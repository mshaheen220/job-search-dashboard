<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Search Dashboard - Jill Shaheen</title>
    <!-- Favicon: Target icon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' font-size='96'>ðŸŽ¯</text></svg>">

    <!-- Security Headers (X-Frame-Options must be set via HTTP header, not meta tag) -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <!-- 1. React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>

    <!-- 2. React DOM -->
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- 3. Chart.js (replaces Recharts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts - Professional Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --bg-elevated: #ffffff;
            --bg-hover: #f8f8f8;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-primary: #e5e5e5;
            --border-secondary: #f0f0f0;
            --accent-primary: #2563eb;
            --accent-secondary: #3b82f6;
            --accent-hover: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.12);
        }

        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1a1a1a;
            --bg-elevated: #1f1f1f;
            --bg-hover: #242424;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --text-tertiary: #737373;
            --border-primary: #2a2a2a;
            --border-secondary: #1f1f1f;
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --accent-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .app {
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border-primary);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .logo {
            font-family: 'Bricolage Grotesque', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: scale(1.05);
        }

        .nav {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.25rem;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: 'DM Sans', sans-serif;
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card,
        .chart-card {
            background: var(--bg-secondary);
            padding: 1.75rem;
            margin-bottom: 30px;
            border-radius: 16px;
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Stretch stat cards to match adjacent chart heights */
        .stat-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Stretch chart cards to equal heights in grid rows */
        .chart-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chart-card .chart-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card h3,
        .chart-card h3 {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .stat-card .value,
        .chart-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'Bricolage Grotesque', sans-serif;
            line-height: 1.2;
        }

        .stat-card .subtext,
        .chart-card .subtext {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
        }

        /* Allow table content to fill stat-card height */
        .stat-card .table-container {
            flex: 1;
            display: flex;
        }

        .stat-card .table {
            width: 100%;
        }

        /* Lighter background for stat-cards in light mode */
        [data-theme="light"] .stat-card {
            background: #ffffff;
        }

        /* Chart layout styles */
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .chart-row>* {
            height: 100%;
        }

        .chart-large {
            width: 100%;
        }

        .chart-medium {
            width: 100%;
            display: flex;
        }

        .chart-medium>* {
            flex: 1;
        }

        .chart-medium canvas {
            min-height: 300px;
        }

        /* Stack on mobile */
        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-select,
        .search-input {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            padding: 0.6rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s ease;
        }

        .filter-select:focus,
        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-input {
            min-width: 200px;
            width: 100%;
            padding-right: 2.5rem;
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            font-family: 'DM Sans', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .table-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-primary);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border-primary);
        }

        .table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-secondary);
            color: var(--text-primary);
        }

        .table tbody tr {
            transition: background 0.2s;
        }

        .table tbody tr:hover {
            background: var(--bg-hover);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-not-applied {
            background: #f3f4f6;
            color: #6b7280;
        }

        [data-theme="dark"] .status-not-applied {
            background: #374151;
            color: #9ca3af;
        }

        .status-applied {
            background: #dbeafe;
            color: #1e40af;
        }

        [data-theme="dark"] .status-applied {
            background: #1e3a8a;
            color: #93c5fd;
        }

        /* In Progress - Vibrant and eye-catching for important opportunities */
        .status-in-progress {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3);
        }

        [data-theme="dark"] .status-in-progress {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fef3c7;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.4);
        }

        .status-recruiter-contact {
            background: #ede9fe;
            color: #6b21a8;
        }

        [data-theme="dark"] .status-recruiter-contact {
            background: #7c3aed;
            color: #c4b5fd;
        }

        .status-phone-screen {
            background: #cffafe;
            color: #0e7490;
        }

        [data-theme="dark"] .status-phone-screen {
            background: #0891b2;
            color: #a5f3fc;
        }

        .status-interview-loop {
            background: #d1fae5;
            color: #065f46;
        }

        [data-theme="dark"] .status-interview-loop {
            background: #059669;
            color: #6ee7b7;
        }

        .status-final-round {
            background: #fed7aa;
            color: #9a3412;
        }

        [data-theme="dark"] .status-final-round {
            background: #ea580c;
            color: #fed7aa;
        }

        .status-offer {
            background: #d1fae5;
            color: #065f46;
        }

        [data-theme="dark"] .status-offer {
            background: #16a34a;
            color: #86efac;
        }

        .status-declined-offer {
            background: #e0e7ff;
            color: #3730a3;
        }

        [data-theme="dark"] .status-declined-offer {
            background: #4338ca;
            color: #a5b4fc;
        }

        .status-declined-\(withdrew\) {
            background: #e0e7ff;
            color: #4338ca;
        }

        [data-theme="dark"] .status-declined-\(withdrew\) {
            background: #6366f1;
            color: #c7d2fe;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        [data-theme="dark"] .status-rejected {
            background: #7f1d1d;
            color: #fca5a5;
        }

        .status-ghosted {
            background: #f5f5f4;
            color: #57534e;
        }

        [data-theme="dark"] .status-ghosted {
            background: #44403c;
            color: #a8a29e;
        }

        /* Closed status: add background for contrast in light/dark */
        .status-closed {
            background: #e5e7eb;
            color: #111827;
        }

        [data-theme="dark"] .status-closed {
            background: #1f2937;
            color: #e5e7eb;
        }

        .priority-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .priority-tier1 {
            background: #fecaca;
            color: #991b1b;
        }

        [data-theme="dark"] .priority-tier1 {
            background: #991b1b;
            color: #fca5a5;
        }

        .priority-tier2 {
            background: #fed7aa;
            color: #9a3412;
        }

        [data-theme="dark"] .priority-tier2 {
            background: #ea580c;
            color: #fed7aa;
        }

        .priority-tier3 {
            background: #fef3c7;
            color: #78350f;
        }

        [data-theme="dark"] .priority-tier3 {
            background: #854d0e;
            color: #fcd34d;
        }

        /* Category pill styles */
        .category-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .category-developer-tools {
            background: #dbeafe;
            color: #0c4a6e;
            border: 1px solid #0284c7;
        }

        [data-theme="dark"] .category-developer-tools {
            background: #1e3a8a;
            color: #93c5fd;
            border: 1px solid #3b82f6;
        }

        .category-data-infrastructure {
            background: #dbeafe;
            color: #0c4a6e;
            border: 1px solid #0284c7;
        }

        [data-theme="dark"] .category-data-infrastructure {
            background: #1e3a8a;
            color: #93c5fd;
            border: 1px solid #3b82f6;
        }

        .category-cloud-infrastructure {
            background: #e0e7ff;
            color: #312e81;
            border: 1px solid #4338ca;
        }

        [data-theme="dark"] .category-cloud-infrastructure {
            background: #312e81;
            color: #a5b4fc;
            border: 1px solid #6366f1;
        }

        .category-enterprise-software {
            background: #fce7f3;
            color: #831843;
            border: 1px solid #db2777;
        }

        [data-theme="dark"] .category-enterprise-software {
            background: #831843;
            color: #f9a8d4;
            border: 1px solid #ec4899;
        }

        .category-consumer-tech {
            background: #fef08a;
            color: #713f12;
            border: 1px solid #ca8a04;
        }

        [data-theme="dark"] .category-consumer-tech {
            background: #854d0e;
            color: #fde047;
            border: 1px solid #eab308;
        }

        .category-none {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        [data-theme="dark"] .category-none {
            background: #374151;
            color: #d1d5db;
            border: 1px solid #6b7280;
        }

        /* Extended palette for custom categories */
        .category-custom-0 {
            background: #fae8ff;
            color: #701a75;
            border: 1px solid #a21caf;
        }

        [data-theme="dark"] .category-custom-0 {
            background: #701a75;
            color: #f0abfc;
            border: 1px solid #d946ef;
        }

        .category-custom-1 {
            background: #dcfce7;
            color: #14532d;
            border: 1px solid #16a34a;
        }

        [data-theme="dark"] .category-custom-1 {
            background: #14532d;
            color: #86efac;
            border: 1px solid #22c55e;
        }

        .category-custom-2 {
            background: #ffedd5;
            color: #7c2d12;
            border: 1px solid #ea580c;
        }

        [data-theme="dark"] .category-custom-2 {
            background: #7c2d12;
            color: #fed7aa;
            border: 1px solid #f97316;
        }

        .category-custom-3 {
            background: #e0f2fe;
            color: #0c4a6e;
            border: 1px solid #0284c7;
        }

        [data-theme="dark"] .category-custom-3 {
            background: #0c4a6e;
            color: #7dd3fc;
            border: 1px solid #0ea5e9;
        }

        .category-custom-4 {
            background: #fef9c3;
            color: #713f12;
            border: 1px solid #ca8a04;
        }

        [data-theme="dark"] .category-custom-4 {
            background: #713f12;
            color: #fef08a;
            border: 1px solid #eab308;
        }

        .category-custom-5 {
            background: #f3e8ff;
            color: #5b21b6;
            border: 1px solid #7c3aed;
        }

        [data-theme="dark"] .category-custom-5 {
            background: #5b21b6;
            color: #d8b4fe;
            border: 1px solid #a855f7;
        }

        .category-custom-6 {
            background: #ddd6fe;
            color: #4c1d95;
            border: 1px solid #6366f1;
        }

        [data-theme="dark"] .category-custom-6 {
            background: #4c1d95;
            color: #c4b5fd;
            border: 1px solid #818cf8;
        }

        .category-custom-7 {
            background: #fce7f3;
            color: #9f1239;
            border: 1px solid #e11d48;
        }

        [data-theme="dark"] .category-custom-7 {
            background: #9f1239;
            color: #fbcfe8;
            border: 1px solid #f43f5e;
        }

        .category-custom-8 {
            background: #ccfbf1;
            color: #134e4a;
            border: 1px solid #0d9488;
        }

        [data-theme="dark"] .category-custom-8 {
            background: #134e4a;
            color: #5eead4;
            border: 1px solid #14b8a6;
        }

        .category-custom-9 {
            background: #fef3c7;
            color: #78350f;
            border: 1px solid #d97706;
        }

        [data-theme="dark"] .category-custom-9 {
            background: #78350f;
            color: #fde68a;
            border: 1px solid #f59e0b;
        }

        .category-custom-10 {
            background: #ede9fe;
            color: #4c1d95;
            border: 1px solid #7c3aed;
        }

        [data-theme="dark"] .category-custom-10 {
            background: #4c1d95;
            color: #ddd6fe;
            border: 1px solid #8b5cf6;
        }

        .category-custom-11 {
            background: #ecfccb;
            color: #365314;
            border: 1px solid #65a30d;
        }

        [data-theme="dark"] .category-custom-11 {
            background: #365314;
            color: #d9f99d;
            border: 1px solid #84cc16;
        }

        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .company-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .company-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .company-card h3 {
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .company-card .category {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .company-card .actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .modal-close {
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--danger);
        }

        .modal-body {
            padding: 1.5rem 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-primary);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-tertiary);
        }

        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .link {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .link:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .main {
                padding: 1rem;
            }

            .table-container {
                overflow-x: auto;
            }

            .table {
                min-width: 800px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .company-grid {
                grid-template-columns: 1fr;
            }
        }

        .search-container {
            position: relative;
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        .clear-search {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b8aff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            padding: 2rem;
            margin-top: 3rem;
            text-align: center;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .footer-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .footer-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .footer-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        .footer-icon {
            width: 18px;
            height: 18px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        /* ===========================================
           APPLICATION CONSTANTS & CONFIGURATION
           =========================================== */

        const APP_CONFIG = {
            // Application version and metadata
            VERSION: '1.0',
            APP_NAME: 'Job Search Dashboard',

            // Storage keys
            STORAGE_KEYS: {
                JOBS: 'jobTrackerJobs',
                CUSTOM_COMPANIES: 'jobTrackerCustomCompanies',
                BLOCKED_COMPANIES: 'blockedCompanies',
                LAST_BACKUP: 'jobTrackerLastBackup',
                THEME: 'theme'
            },

            // Date and time constants
            BACKUP_INTERVAL_MS: 60 * 60 * 1000, // 1 hour
            MS_PER_DAY: 1000 * 60 * 60 * 24,

            // Pagination
            ITEMS_PER_PAGE: 20,

            // Analytics thresholds
            HOT_PERIOD_MULTIPLIER: 1.25,
            MIN_APPLICATIONS_FOR_COMPANY_STATS: 2
        };

        // Job application statuses
        const JOB_STATUSES = {
            APPLIED: 'Applied',
            IN_PROGRESS: 'In Progress',
            CLOSED: 'Closed'
        };

        // Closure reasons for closed applications
        const CLOSE_REASONS = {
            GHOSTED: 'Ghosted',
            REJECTED: 'Rejected',
            DECLINED_OFFER: 'Declined Offer',
            WITHDREW: 'Withdrew'
        };

        // Application progression stages
        const PROGRESSION_STAGES = {
            APPLICATION: 'Application',
            RECRUITER_SCREEN: 'Recruiter Screen',
            PARTIAL_LOOP: 'Partial Loop',
            FULL_LOOP: 'Full Loop',
            OFFER: 'Offer'
        };

        // Priority tiers for job applications
        const PRIORITY_TIERS = {
            TIER_1: 'Tier 1',  // Highest priority
            TIER_2: 'Tier 2',  // Medium priority
            TIER_3: 'Tier 3'   // Lower priority
        };

        // Company fit levels
        const FIT_LEVELS = {
            STRONG: { value: 3, label: 'Strong' },
            DECENT: { value: 2, label: 'Decent' },
            LONG_SHOT: { value: 1, label: 'Long Shot' },
            UNSET: { value: null, label: 'â€”' }
        };

        /* Legacy arrays for backward compatibility - gradually migrate to objects above */
        const STATUSES = Object.values(JOB_STATUSES);
        const PROGRESSIONS = Object.values(PROGRESSION_STAGES);
        const PRIORITIES = Object.values(PRIORITY_TIERS);

        /* ===========================================
           ANALYTICS MODULE
           =========================================== */

        window.analytics = (() => {

            // ============================================
            // HELPER FUNCTIONS
            // ============================================

            /**
             * Parse a date string into a Date object
             * @param {string} dateString - The date string to parse
             * @returns {Date|null} Parsed date or null if invalid
             */
            /**
             * Parse a date string into a Date object
             * @param {string} dateString - The date string to parse
             * @returns {Date|null} Parsed date or null if invalid
             */
            const parseDate = (dateString) => {
                if (!dateString) return null;
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? null : date;
            };

            /**
             * Calculate ISO week number for a given date
             * @param {Date} date - The date to calculate week number for
             * @returns {number} ISO week number
             */
            const getWeekNumber = (date) => {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            };

            /**
             * Format date as YYYY-MM for grouping by month
             * @param {Date} date - The date to format
             * @returns {string} Formatted month-year string
             */
            const getMonthYear = (date) => {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            };

            /**
             * Format date as YYYY-Www for grouping by week
             * @param {Date} date - The date to format
             * @returns {string} Formatted week-year string
             */
            const getWeekYear = (date) => {
                const week = getWeekNumber(date);
                return `${date.getFullYear()}-W${String(week).padStart(2, '0')}`;
            };

            /**
             * Filter jobs by date range
             * @param {Array} jobs - Array of job objects
             * @param {Date} startDate - Start of date range (inclusive)
             * @param {Date} endDate - End of date range (inclusive)
             * @returns {Array} Filtered jobs array
             */
            const filterByDateRange = (jobs, startDate, endDate) => {
                return jobs.filter(job => {
                    const appliedDate = parseDate(job.dateApplied);
                    if (!appliedDate) return false;
                    if (startDate && appliedDate < startDate) return false;
                    if (endDate && appliedDate > endDate) return false;
                    return true;
                });
            };

            // ============================================
            // CORE METRICS CALCULATIONS
            // ============================================

            /**
             * Get total number of applications with a date
             * @param {Array} jobs - Array of job objects
             * @returns {number} Total applications count
             */
            const getTotalApplications = (jobs) => {
                return jobs.filter(job => job.dateApplied).length;
            };

            /**
             * Calculate applications by various time windows
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Application counts by time period
             */
            const getApplicationsByTimeWindow = (jobs) => {
                const now = new Date();

                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                startOfWeek.setHours(0, 0, 0, 0);

                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);

                return {
                    today: filterByDateRange(jobs, startOfToday, null).length,
                    thisWeek: filterByDateRange(jobs, startOfWeek, null).length,
                    thisMonth: filterByDateRange(jobs, startOfMonth, null).length,
                    lastMonth: filterByDateRange(jobs, startOfLastMonth, endOfLastMonth).length,
                    total: getTotalApplications(jobs)
                };
            };

            /**
             * Calculate response rate (companies that moved past application stage)
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Response statistics
             */
            const getResponseRate = (jobs) => {
                const applicationsWithDate = jobs.filter(job => job.dateApplied);
                const total = applicationsWithDate.length;

                if (total === 0) return {
                    count: 0,
                    percentage: 0,
                    total,
                    waiting: 0
                };

                // Count as response if status is "In Progress" or progression moved beyond "Application"
                const responded = applicationsWithDate.filter(job => {
                    if (job.status === JOB_STATUSES.IN_PROGRESS) return true;

                    const prog = job.progression || PROGRESSION_STAGES.APPLICATION;
                    if (prog !== PROGRESSION_STAGES.APPLICATION) return true;

                    // Count withdrawals after engagement as responses
                    if (job.status === JOB_STATUSES.CLOSED && job.closeReason === CLOSE_REASONS.WITHDREW) {
                        return true;
                    }

                    return false;
                });

                const waiting = applicationsWithDate.filter(job => {
                    return job.status === JOB_STATUSES.APPLIED &&
                        (job.progression || PROGRESSION_STAGES.APPLICATION) === PROGRESSION_STAGES.APPLICATION;
                });

                return {
                    count: responded.length,
                    percentage: Math.round((responded.length / total) * 100),
                    total,
                    waiting: waiting.length
                };
            };

            /**
             * Analyze waiting applications by duration buckets
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Waiting applications statistics
             */
            const getWaitingStatus = (jobs) => {
                const waiting = jobs.filter(job =>
                    job.status === JOB_STATUSES.APPLIED &&
                    (job.progression || PROGRESSION_STAGES.APPLICATION) === PROGRESSION_STAGES.APPLICATION
                );

                const now = new Date();
                const waitingByDuration = {
                    "0-7 days": 0,
                    "8-14 days": 0,
                    "15-30 days": 0,
                    "31-60 days": 0,
                    "60+ days": 0
                };

                waiting.forEach(job => {
                    if (!job.dateApplied) return;

                    const appliedDate = new Date(job.dateApplied);
                    const daysWaiting = Math.floor((now - appliedDate) / APP_CONFIG.MS_PER_DAY);

                    if (daysWaiting <= 7) {
                        waitingByDuration["0-7 days"]++;
                    } else if (daysWaiting <= 14) {
                        waitingByDuration["8-14 days"]++;
                    } else if (daysWaiting <= 30) {
                        waitingByDuration["15-30 days"]++;
                    } else if (daysWaiting <= 60) {
                        waitingByDuration["31-60 days"]++;
                    } else {
                        waitingByDuration["60+ days"]++;
                    }
                });

                return {
                    total: waiting.length,
                    byDuration: waitingByDuration,
                    jobs: waiting
                };
            };

            /**
             * Calculate interview conversion rate
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Interview conversion statistics
             */
            const getInterviewConversionRate = (jobs) => {
                const applicationsWithDate = jobs.filter(job => job.dateApplied);
                const total = applicationsWithDate.length;

                if (total === 0) return { count: 0, percentage: 0, total };

                const interviewStages = [
                    PROGRESSION_STAGES.RECRUITER_SCREEN,
                    PROGRESSION_STAGES.PARTIAL_LOOP,
                    PROGRESSION_STAGES.FULL_LOOP,
                    PROGRESSION_STAGES.OFFER
                ];

                const interviewed = applicationsWithDate.filter(job =>
                    interviewStages.includes(job.progression)
                );

                return {
                    count: interviewed.length,
                    percentage: Math.round((interviewed.length / total) * 100),
                    total
                };
            };

            /**
             * Calculate offer rate
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Offer statistics
             */
            const getOfferRate = (jobs) => {
                const applicationsWithDate = jobs.filter(job => job.dateApplied);
                const total = applicationsWithDate.length;

                if (total === 0) return { count: 0, percentage: 0, total };

                const offers = applicationsWithDate.filter(job =>
                    job.progression === PROGRESSION_STAGES.OFFER
                );

                return {
                    count: offers.length,
                    percentage: Math.round((offers.length / total) * 100),
                    total
                };
            };

            /**
             * Get pipeline status for active applications
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Pipeline statistics by stage and status
             */
            const getPipelineStatus = (jobs) => {
                const activePipeline = jobs.filter(job =>
                    job.status === JOB_STATUSES.APPLIED || job.status === JOB_STATUSES.IN_PROGRESS
                );

                const byStage = {
                    [PROGRESSION_STAGES.APPLICATION]: 0,
                    [PROGRESSION_STAGES.RECRUITER_SCREEN]: 0,
                    [PROGRESSION_STAGES.PARTIAL_LOOP]: 0,
                    [PROGRESSION_STAGES.FULL_LOOP]: 0,
                    [PROGRESSION_STAGES.OFFER]: 0
                };

                const byStatus = {
                    [JOB_STATUSES.APPLIED]: 0,
                    [JOB_STATUSES.IN_PROGRESS]: 0
                };

                activePipeline.forEach(job => {
                    const stage = job.progression || PROGRESSION_STAGES.APPLICATION;
                    if (byStage.hasOwnProperty(stage)) {
                        byStage[stage]++;
                    }

                    if (job.status === JOB_STATUSES.APPLIED) {
                        byStatus[JOB_STATUSES.APPLIED]++;
                    } else if (job.status === JOB_STATUSES.IN_PROGRESS) {
                        byStatus[JOB_STATUSES.IN_PROGRESS]++;
                    }
                });

                return {
                    total: activePipeline.length,
                    byStage,
                    byStatus,
                    jobs: activePipeline
                };
            };

            /**
             * Analyze closure reasons for closed applications
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Closure statistics by reason
             */
            const getClosureReasons = (jobs) => {
                const closed = jobs.filter(job => job.status === JOB_STATUSES.CLOSED);

                const counts = {
                    [CLOSE_REASONS.REJECTED]: 0,
                    [CLOSE_REASONS.GHOSTED]: 0,
                    [CLOSE_REASONS.WITHDREW]: 0,
                    "Unknown": 0
                };

                closed.forEach(job => {
                    const reason = job.closeReason || "Unknown";
                    if (counts.hasOwnProperty(reason)) {
                        counts[reason]++;
                    } else {
                        counts["Unknown"]++;
                    }
                });

                return {
                    total: closed.length,
                    counts
                };
            };

            /**
             * Calculate rejection rate from closed applications
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Rejection statistics
             */
            const getRejectionRate = (jobs) => {
                const closed = jobs.filter(job => job.status === JOB_STATUSES.CLOSED);
                const total = closed.length;

                if (total === 0) return { count: 0, percentage: 0, total };

                const rejected = closed.filter(job => job.closeReason === CLOSE_REASONS.REJECTED);

                return {
                    count: rejected.length,
                    percentage: Math.round((rejected.length / total) * 100),
                    total
                };
            };

            /**
             * Break down closed applications by progression stage
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Closed applications by progression
             */
            const getClosedProgressionBreakdown = (jobs) => {
                const closed = jobs.filter(job => job.status === JOB_STATUSES.CLOSED);

                const byProgression = {
                    [PROGRESSION_STAGES.APPLICATION]: 0,
                    [PROGRESSION_STAGES.RECRUITER_SCREEN]: 0,
                    [PROGRESSION_STAGES.PARTIAL_LOOP]: 0,
                    [PROGRESSION_STAGES.FULL_LOOP]: 0,
                    [PROGRESSION_STAGES.OFFER]: 0
                };

                closed.forEach(job => {
                    const prog = job.progression || PROGRESSION_STAGES.APPLICATION;
                    if (byProgression.hasOwnProperty(prog)) {
                        byProgression[prog]++;
                    }
                });

                return {
                    total: closed.length,
                    byProgression
                };
            };

            // ============================================
            // TIME-BASED ANALYTICS
            // ============================================

            /**
             * Calculate applications per week with average
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Weekly application statistics
             */
            const getApplicationsPerWeek = (jobs) => {
                const jobsWithDates = jobs.filter(job => job.dateApplied);
                const weekMap = {};

                jobsWithDates.forEach(job => {
                    const date = parseDate(job.dateApplied);
                    if (!date) return;

                    const weekKey = getWeekYear(date);
                    weekMap[weekKey] = (weekMap[weekKey] || 0) + 1;
                });

                const weeks = Object.entries(weekMap)
                    .map(([week, count]) => ({ week, count }))
                    .sort((a, b) => a.week.localeCompare(b.week));

                const totalWeeks = weeks.length;
                const totalApps = weeks.reduce((sum, w) => sum + w.count, 0);
                const average = totalWeeks > 0 ? Math.round(totalApps / totalWeeks) : 0;

                return {
                    byWeek: weeks,
                    average,
                    total: totalApps
                };
            };

            /**
             * Calculate applications per month with formatted labels
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Monthly application statistics
             */
            const getApplicationsPerMonth = (jobs) => {
                const jobsWithDates = jobs.filter(job => job.dateApplied);
                const monthMap = {};

                jobsWithDates.forEach(job => {
                    const date = parseDate(job.dateApplied);
                    if (!date) return;

                    const monthKey = getMonthYear(date);
                    monthMap[monthKey] = (monthMap[monthKey] || 0) + 1;
                });

                const months = Object.entries(monthMap)
                    .map(([month, count]) => {
                        const [year, monthNum] = month.split('-');
                        const date = new Date(parseInt(year), parseInt(monthNum) - 1);
                        const label = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                        return { month, label, count };
                    })
                    .sort((a, b) => a.month.localeCompare(b.month));

                const totalMonths = months.length;
                const totalApps = months.reduce((sum, m) => sum + m.count, 0);
                const average = totalMonths > 0 ? Math.round(totalApps / totalMonths) : 0;

                return {
                    byMonth: months,
                    average,
                    total: totalApps
                };
            };

            /**
             * Track response rates by month based on follow-up (close) dates
             * @param {Array} jobs - Array of job objects
             * @returns {Array} Monthly response rate data
             */
            const getResponseRateByMonth = (jobs) => {
                const monthMap = {};

                jobs.forEach(job => {
                    if (!job.followUp) return;
                    const date = parseDate(job.followUp);
                    if (!date) return;

                    const monthKey = getMonthYear(date);
                    if (!monthMap[monthKey]) {
                        monthMap[monthKey] = { followUps: 0, responded: 0 };
                    }

                    monthMap[monthKey].followUps++;
                    // Count as responded if progression moved beyond Application stage
                    if (job.progression && job.progression !== PROGRESSION_STAGES.APPLICATION) {
                        monthMap[monthKey].responded++;
                    }
                });

                const months = Object.entries(monthMap)
                    .map(([month, data]) => {
                        const [year, monthNum] = month.split('-');
                        const date = new Date(parseInt(year), parseInt(monthNum) - 1);
                        const label = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                        const responsePercentage = data.followUps > 0
                            ? Math.round((data.responded / data.followUps) * 100)
                            : 0;

                        return {
                            month,
                            label,
                            followUps: data.followUps,
                            responded: data.responded,
                            responsePercentage
                        };
                    })
                    .sort((a, b) => a.month.localeCompare(b.month));

                return months;
            };

            /**
             * Identify months with unusually high application activity
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Hot application periods above threshold
             */
            const getHotApplicationPeriods = (jobs) => {
                const monthlyData = getApplicationsPerMonth(jobs);
                const hotThreshold = monthlyData.average * APP_CONFIG.HOT_PERIOD_MULTIPLIER;

                const hotPeriods = monthlyData.byMonth
                    .filter(item => item.count >= hotThreshold)
                    .map(item => ({
                        period: item.label,
                        applications: item.count,
                        vsAverage: Math.round(((item.count - monthlyData.average) / monthlyData.average) * 100)
                    }));

                return {
                    hotPeriods,
                    threshold: Math.round(hotThreshold),
                    average: monthlyData.average
                };
            };

            /**
             * Identify periods with unusually high response rates
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Hot response periods above threshold
             */
            const getHotResponsePeriods = (jobs) => {
                const monthlyResponses = getResponseRateByMonth(jobs);

                const totalApps = monthlyResponses.reduce((sum, item) => sum + item.total, 0);
                const totalResponses = monthlyResponses.reduce((sum, item) => sum + item.responded, 0);
                const overallAverage = totalApps > 0 ? (totalResponses / totalApps) * 100 : 0;

                const hotThreshold = overallAverage * APP_CONFIG.HOT_PERIOD_MULTIPLIER;

                const hotPeriods = monthlyResponses
                    .filter(item => item.percentage >= hotThreshold && item.total >= 3)
                    .map(item => ({
                        period: item.label,
                        responseRate: item.percentage,
                        applications: item.total,
                        responses: item.responded
                    }));

                return {
                    hotPeriods,
                    threshold: Math.round(hotThreshold),
                    average: Math.round(overallAverage)
                };
            };

            // ============================================
            // COMPANY & PRIORITY ANALYTICS
            // ============================================

            /**
             * Aggregate application statistics by company
             * @param {Array} jobs - Array of job objects
             * @returns {Array} Company-wise application statistics
             */
            const getApplicationsByCompany = (jobs) => {
                const jobsWithDates = jobs.filter(job => job.dateApplied);
                const companyData = {};

                jobsWithDates.forEach(job => {
                    const company = job.company || "Unknown";

                    if (!companyData[company]) {
                        companyData[company] = {
                            total: 0,
                            applied: 0,
                            inProgress: 0,
                            closed: 0,
                            responded: 0,
                            rejected: 0,
                            offers: 0
                        };
                    }

                    companyData[company].total++;

                    // Count by status
                    if (job.status === JOB_STATUSES.APPLIED) {
                        companyData[company].applied++;
                    } else if (job.status === JOB_STATUSES.IN_PROGRESS) {
                        companyData[company].inProgress++;
                    } else if (job.status === JOB_STATUSES.CLOSED) {
                        companyData[company].closed++;
                    }

                    // Count responses (anything beyond Application stage)
                    const prog = job.progression || PROGRESSION_STAGES.APPLICATION;
                    if (job.status === JOB_STATUSES.IN_PROGRESS || prog !== PROGRESSION_STAGES.APPLICATION) {
                        companyData[company].responded++;
                    }

                    // Count rejections
                    if (job.closeReason === CLOSE_REASONS.REJECTED) {
                        companyData[company].rejected++;
                    }

                    // Count offers
                    if (prog === PROGRESSION_STAGES.OFFER) {
                        companyData[company].offers++;
                    }
                });

                // Convert to array and calculate response rates
                const companies = Object.entries(companyData)
                    .map(([name, data]) => ({
                        name,
                        ...data,
                        responseRate: data.total > 0
                            ? Math.round((data.responded / data.total) * 100)
                            : 0
                    }))
                    .sort((a, b) => b.total - a.total);

                return companies;
            };

            /**
             * Analyze success rates by priority tier
             * @param {Array} jobs - Array of job objects
             * @returns {Array} Success metrics by priority tier
             */
            const getSuccessRateByPriority = (jobs) => {
                const jobsWithDates = jobs.filter(job => job.dateApplied);

                // Initialize data structure for each priority tier
                const priorityData = {};
                Object.values(PRIORITY_TIERS).forEach(tier => {
                    priorityData[tier] = { total: 0, responded: 0, interviewed: 0, offers: 0 };
                });

                const interviewStages = [
                    PROGRESSION_STAGES.RECRUITER_SCREEN,
                    PROGRESSION_STAGES.PARTIAL_LOOP,
                    PROGRESSION_STAGES.FULL_LOOP,
                    PROGRESSION_STAGES.OFFER
                ];

                jobsWithDates.forEach(job => {
                    const tier = job.priority || PRIORITY_TIERS.TIER_3;

                    if (priorityData[tier]) {
                        priorityData[tier].total++;

                        // Count responses (status In Progress or progression beyond Application)
                        if (job.status === JOB_STATUSES.IN_PROGRESS ||
                            (job.progression && job.progression !== PROGRESSION_STAGES.APPLICATION)) {
                            priorityData[tier].responded++;
                        }

                        // Count interviews
                        if (job.progression && interviewStages.includes(job.progression)) {
                            priorityData[tier].interviewed++;
                        }

                        // Count offers
                        if (job.progression === PROGRESSION_STAGES.OFFER) {
                            priorityData[tier].offers++;
                        }
                    }
                });

                // Calculate percentages for each tier
                const result = Object.entries(priorityData).map(([tier, data]) => {
                    const responseRate = data.total > 0 ? Math.round((data.responded / data.total) * 100) : 0;
                    const interviewRate = data.total > 0 ? Math.round((data.interviewed / data.total) * 100) : 0;
                    const offerRate = data.total > 0 ? Math.round((data.offers / data.total) * 100) : 0;

                    return {
                        tier,
                        total: data.total,
                        responded: data.responded,
                        interviewed: data.interviewed,
                        offers: data.offers,
                        responseRate,
                        interviewRate,
                        offerRate
                    };
                });

                return result;
            };

            /**
             * Get top companies by response rate (requires minimum applications)
             * @param {Array} jobs - Array of job objects
             * @param {number} minApplications - Minimum applications to be included
             * @returns {Array} Top 10 most responsive companies
             */
            const getMostResponsiveCompanies = (jobs, minApplications = APP_CONFIG.MIN_APPLICATIONS_FOR_COMPANY_STATS) => {
                const companies = getApplicationsByCompany(jobs);

                return companies
                    .filter(company => company.total >= minApplications)
                    .sort((a, b) => b.responseRate - a.responseRate)
                    .slice(0, 10);
            };

            /**
             * Break down progression stages for applications that received responses
             * @param {Array} jobs - Array of job objects
             * @returns {Array} Progression breakdown data
             */
            const getProgressionBreakdownForResponded = (jobs) => {
                const responded = jobs.filter(job =>
                    job.progression && job.progression !== PROGRESSION_STAGES.APPLICATION
                );

                const byProgression = {
                    [PROGRESSION_STAGES.RECRUITER_SCREEN]: 0,
                    [PROGRESSION_STAGES.PARTIAL_LOOP]: 0,
                    [PROGRESSION_STAGES.FULL_LOOP]: 0,
                    [PROGRESSION_STAGES.OFFER]: 0
                };

                responded.forEach(job => {
                    const prog = job.progression || PROGRESSION_STAGES.APPLICATION;
                    if (byProgression.hasOwnProperty(prog)) {
                        byProgression[prog]++;
                    }
                });

                return Object.entries(byProgression)
                    .filter(([_, count]) => count > 0)
                    .map(([stage, count]) => ({
                        label: stage,
                        value: count
                    }));
            };

            // ============================================
            // AGGREGATED ANALYTICS EXPORTS
            // ============================================

            /**
             * Get comprehensive job search overview metrics
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Complete overview metrics
             */
            const getJobSearchOverview = (jobs) => {
                return {
                    totalApplications: getTotalApplications(jobs),
                    byTimeWindow: getApplicationsByTimeWindow(jobs),
                    responseRate: getResponseRate(jobs),
                    interviewConversionRate: getInterviewConversionRate(jobs),
                    offerRate: getOfferRate(jobs),
                    pipeline: getPipelineStatus(jobs),
                    waiting: getWaitingStatus(jobs),
                    closureReasons: getClosureReasons(jobs),
                    rejectionRate: getRejectionRate(jobs),
                    closedProgression: getClosedProgressionBreakdown(jobs)
                };
            };

            /**
             * Get time-based analytics metrics
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Time-based metrics
             */
            const getTimeBasedAnalytics = (jobs) => {
                return {
                    applicationsPerWeek: getApplicationsPerWeek(jobs),
                    applicationsPerMonth: getApplicationsPerMonth(jobs),
                    responseRateByMonth: getResponseRateByMonth(jobs),
                    hotApplicationPeriods: getHotApplicationPeriods(jobs),
                    hotResponsePeriods: getHotResponsePeriods(jobs)
                };
            };

            /**
             * Get company and priority-based analytics
             * @param {Array} jobs - Array of job objects
             * @returns {Object} Company and priority metrics
             */
            const getCompanyPriorityAnalytics = (jobs) => {
                return {
                    applicationsByCompany: getApplicationsByCompany(jobs),
                    successRateByPriority: getSuccessRateByPriority(jobs),
                    mostResponsiveCompanies: getMostResponsiveCompanies(jobs)
                };
            };

            /**
             * Get complete analytics dataset
             * @param {Array} jobs - Array of job objects
             * @returns {Object} All analytics with generation timestamp
             */
            const getCompleteAnalytics = (jobs) => {
                return {
                    overview: getJobSearchOverview(jobs),
                    timeBased: getTimeBasedAnalytics(jobs),
                    companyPriority: getCompanyPriorityAnalytics(jobs),
                    generatedAt: new Date().toISOString()
                };
            };

            /* Export all analytics functions as public API */
            return {
                // Helper functions
                parseDate,
                filterByDateRange,

                // Core metrics
                getTotalApplications,
                getApplicationsByTimeWindow,
                getResponseRate,
                getWaitingStatus,
                getInterviewConversionRate,
                getOfferRate,
                getPipelineStatus,
                getClosureReasons,
                getRejectionRate,
                getClosedProgressionBreakdown,

                // Time-based analytics
                getApplicationsPerWeek,
                getApplicationsPerMonth,
                getResponseRateByMonth,
                getHotApplicationPeriods,
                getHotResponsePeriods,

                // Company & priority analytics
                getApplicationsByCompany,
                getSuccessRateByPriority,
                getMostResponsiveCompanies,
                getProgressionBreakdownForResponded,

                // Aggregated exports
                getJobSearchOverview,
                getTimeBasedAnalytics,
                getCompanyPriorityAnalytics,
                getCompleteAnalytics
            };

        })(); /* End of analytics module */

        // Wrap analytics functions with caching for better performance
        const cachedAnalytics = (() => {
            const original = window.analytics || analytics;

            return {
                getJobSearchOverview(jobs) {
                    const cacheKey = `overview_${jobs.length}_${jobs.map(j => j.id).join('-').substring(0, 50)}`;
                    return PerformanceUtil.memoize(cacheKey, () => {
                        return PerformanceUtil.measure('analytics:overview', () => original.getJobSearchOverview(jobs));
                    }, 30000);
                },

                getTimeBasedAnalytics(jobs) {
                    const cacheKey = `timebased_${jobs.length}_${jobs.map(j => j.dateApplied).join('-').substring(0, 50)}`;
                    return PerformanceUtil.memoize(cacheKey, () => {
                        return PerformanceUtil.measure('analytics:timebased', () => original.getTimeBasedAnalytics(jobs));
                    }, 30000);
                },

                getCompanyPriorityAnalytics(jobs) {
                    const cacheKey = `company_${jobs.length}_${jobs.map(j => j.company).join('-').substring(0, 50)}`;
                    return PerformanceUtil.memoize(cacheKey, () => {
                        return PerformanceUtil.measure('analytics:company', () => original.getCompanyPriorityAnalytics(jobs));
                    }, 30000);
                },

                getCompleteAnalytics(jobs) {
                    const cacheKey = `complete_${jobs.length}_${jobs.map(j => j.id).join('-').substring(0, 50)}`;
                    return PerformanceUtil.memoize(cacheKey, () => {
                        return PerformanceUtil.measure('analytics:complete', () => original.getCompleteAnalytics(jobs));
                    }, 30000);
                },

                // Pass through other methods
                getHotPeriods: original.getHotPeriods,
                getApplicationsPerDay: original.getApplicationsPerDay,
                getApplicationsPerMonth: original.getApplicationsPerMonth,
                getPriorityStats: original.getPriorityStats,
                getMostResponsiveCompanies: original.getMostResponsiveCompanies,
                getProgressionBreakdownForResponded: original.getProgressionBreakdownForResponded
            };
        })();

        // Use cached analytics globally
        var analytics = cachedAnalytics;
    </script>

    <script type="text/babel">
        /* ===========================================
        CHART WRAPPER - Canvas-based charts
        =========================================== */

        const ChartCard = ({ title, children }) => {
            return (
                <div className="chart-card">
                    <h3>{title}</h3>
                    <div className="chart-content">
                        {children}
                    </div>
                </div>
            );
        };

        /* ===========================================
        CHART COMPONENTS using Chart.js
        =========================================== */

        const DualLineChartComponent = ({ data, label1, label2, color1 = '#6b8aff', color2 = '#10b981', isPercentage = false }) => {
            const { useEffect, useRef } = React;
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                // Destroy previous chart
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [
                            {
                                label: label1,
                                data: data.map(d => d.value1),
                                borderColor: color1 + '60',  // Fainter (60% opacity)
                                backgroundColor: color1 + '10',
                                tension: 0.4,
                                fill: false,
                                borderWidth: 2,
                                pointRadius: 3,
                                pointBackgroundColor: color1 + '60'
                            },
                            {
                                label: label2,
                                data: data.map(d => d.value2),
                                borderColor: color2,  // Prominent (full opacity)
                                backgroundColor: color2 + '20',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 4,
                                pointBackgroundColor: color2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#9ca3af',
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.parsed.y;
                                        return context.dataset.label + ': ' + value + (isPercentage ? '%' : '');
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: isPercentage ? 100 : undefined,
                                ticks: {
                                    color: '#9ca3af',
                                    stepSize: isPercentage ? undefined : 1,
                                    callback: (value) => value + (isPercentage ? '%' : '')
                                },
                                grid: { color: '#2a3248' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#2a3248' }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data, label1, label2, color1, color2, isPercentage]);

            return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        const TripleLineChartComponent = ({ data, label1, label2, label3, color1 = '#6b8aff', color2 = '#f59e0b', color3 = '#10b981', isPercentage = false, useDailyData = false }) => {
            const { useEffect, useRef } = React;
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                const ctx = canvasRef.current.getContext('2d');

                const labels = data.map(d => d.label);
                const dataset1 = data.map(d => d.value1 ?? d.applications ?? 0);
                const dataset2 = data.map(d => d.value2 ?? d.followUps ?? 0);
                const dataset3 = data.map(d => d.value3 ?? d.responded ?? 0);

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const pointRadius = useDailyData ? 5 : 2;
                const pointHoverRadius = useDailyData ? 7 : 3;

                // Calculate max value to determine appropriate step size
                const maxValue = Math.max(...dataset1, ...dataset2, ...dataset3);
                let stepSize;
                if (maxValue <= 10) {
                    stepSize = 1;
                } else if (maxValue <= 20) {
                    stepSize = 2;
                } else if (maxValue <= 50) {
                    stepSize = 5;
                } else if (maxValue <= 100) {
                    stepSize = 10;
                } else {
                    stepSize = 20;
                }

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: label1,
                                data: dataset1,
                                borderColor: color1,
                                backgroundColor: color1 + '33',
                                fill: false,
                                tension: 0.2,
                                pointRadius: pointRadius,
                                pointHoverRadius: pointHoverRadius
                            },
                            {
                                label: label2,
                                data: dataset2,
                                borderColor: color2,
                                backgroundColor: color2 + '33',
                                fill: false,
                                tension: 0.2,
                                pointRadius: pointRadius,
                                pointHoverRadius: pointHoverRadius
                            },
                            {
                                label: label3,
                                data: dataset3,
                                borderColor: color3,
                                backgroundColor: color3 + '33',
                                fill: false,
                                tension: 0.2,
                                pointRadius: pointRadius,
                                pointHoverRadius: pointHoverRadius
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        stacked: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: stepSize,
                                    callback: function (value) {
                                        return isPercentage ? value + '%' : value;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) chartRef.current.destroy();
                };
            }, [data, label1, label2, label3, color1, color2, color3, isPercentage, useDailyData]);

            return <canvas ref={canvasRef} style={{ maxHeight: '200px' }}></canvas>;
        };

        const LineChartComponent = ({ data, label, color = '#6b8aff' }) => {
            const { useEffect, useRef } = React;
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                // Destroy previous chart
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [{
                            label: label,
                            data: data.map(d => d.value),
                            borderColor: color,
                            backgroundColor: color + '20',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#9ca3af' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#2a3248' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#2a3248' }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data, label, color]);

            return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        const BarChartComponent = ({ data, color = '#6b8aff' }) => {
            const { useEffect, useRef } = React;
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [{
                            label: 'Count',
                            data: data.map(d => d.value),
                            backgroundColor: color,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af', stepSize: 1 },
                                grid: { color: '#2a3248' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data, color]);

            return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        const PieChartComponent = ({ data }) => {
            const { useEffect, useRef } = React;
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const colors = ['#6b8aff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [{
                            data: data.map(d => d.value),
                            backgroundColor: colors.slice(0, data.length),
                            borderWidth: 2,
                            borderColor: '#0a0e1a'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#9ca3af', padding: 15 }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        const FunnelChartComponent = ({ data }) => {
            const { useEffect, useRef } = React;
            const containerRef = useRef(null);

            useEffect(() => {
                if (!containerRef.current || !data || data.length === 0) return;

                // Sort data in funnel order
                const funnelOrder = ['Application', 'Recruiter Screen', 'Partial Loop', 'Full Loop', 'Offer'];
                const sortedData = funnelOrder
                    .map(stage => data.find(d => d.label === stage))
                    .filter(item => item && item.value > 0);

                if (sortedData.length === 0) return;

                // Calculate total for percentage calculations
                const totalValue = sortedData.reduce((sum, item) => sum + item.value, 0) || 1;

                // Clear previous content
                containerRef.current.innerHTML = '';

                // Colors matching dashboard theme
                const colors = ['#6b8aff', '#8b5cf6', '#f59e0b', '#10b981', '#34d399'];

                // Create funnel container
                const funnel = document.createElement('div');
                funnel.style.cssText = 'display: flex; flex-direction: column; gap: 20px; width: 100%; padding: 20px 0;';

                sortedData.forEach((item, index) => {
                    // Calculate width percentage for bar (relative to total)
                    const barWidthPercent = (item.value / totalValue) * 100;
                    // Calculate percentage (relative to total)
                    const percent = ((item.value / totalValue) * 100).toFixed(1);

                    // Create row container
                    const row = document.createElement('div');
                    row.style.cssText = 'display: flex; align-items: center; gap: 16px;';

                    // Create circle with percentage
                    const circle = document.createElement('div');
                    const circleSize = Math.max(60, 80 - index * 8); // Circles get slightly smaller
                    circle.style.cssText = `
                width: ${circleSize}px;
                height: ${circleSize}px;
                border-radius: 50%;
                background-color: ${colors[index % colors.length]};
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                font-weight: 700;
                font-size: 18px;
                color: white;
            `;
                    circle.textContent = `${percent}%`;

                    // Create bar section
                    const barSection = document.createElement('div');
                    barSection.style.cssText = 'flex: 1; display: flex; flex-direction: column; gap: 6px;';

                    // Create bar
                    const bar = document.createElement('div');
                    bar.style.cssText = `
                height: 32px;
                background-color: ${colors[index % colors.length]};
                border-radius: 4px;
                width: ${Math.max(barWidthPercent, 15)}%;
                min-width: 60px;
                transition: all 0.2s;
                cursor: pointer;
            `;

                    bar.addEventListener('mouseenter', () => {
                        bar.style.opacity = '0.8';
                        bar.style.transform = 'scaleX(1.05)';
                        bar.style.transformOrigin = 'left';
                    });
                    bar.addEventListener('mouseleave', () => {
                        bar.style.opacity = '1';
                        bar.style.transform = 'scaleX(1)';
                    });

                    // Create label and count container
                    const labelCount = document.createElement('div');
                    labelCount.style.cssText = 'display: flex; gap: 8px; font-size: 12px; color: var(--text-tertiary);';

                    const label = document.createElement('span');
                    label.textContent = item.label;
                    label.style.cssText = 'font-weight: 600; color: var(--text-secondary);';

                    const count = document.createElement('span');
                    count.textContent = item.value.toLocaleString();

                    labelCount.appendChild(label);
                    labelCount.appendChild(count);

                    barSection.appendChild(bar);
                    barSection.appendChild(labelCount);

                    row.appendChild(circle);
                    row.appendChild(barSection);

                    funnel.appendChild(row);
                });

                containerRef.current.appendChild(funnel);
            }, [data]);

            return <div ref={containerRef} style={{ width: '100%', minHeight: '300px' }}></div>;
        };

        const GroupedBarChartComponent = ({ data }) => {
            const { useEffect, useRef } = React;
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Callback rate',
                                data: data.responseRates,
                                backgroundColor: '#6b8aff'
                            },
                            {
                                label: 'Interview rate',
                                data: data.interviewRates,
                                backgroundColor: '#10b981'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#9ca3af' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: '#9ca3af',
                                    callback: (value) => value + '%'
                                },
                                grid: { color: '#2a3248' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        /* ===========================================
        KEY METRICS GRID
        =========================================== */

        const KeyMetricsGrid = ({ metrics }) => {
            return (
                <div className="metrics-grid" style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
                    gap: '1rem',
                    marginBottom: '2rem'
                }}>
                    <div className="stat-card">
                        <div className="stat-label" style={{
                            fontSize: '0.85rem',
                            color: 'var(--text-tertiary)',
                            marginBottom: '0.5rem'
                        }}>Total applications</div>
                        <div className="stat-value" style={{
                            fontSize: '2rem',
                            fontWeight: 'bold',
                            color: 'var(--text-primary)',
                            marginBottom: '0.25rem'
                        }}>{metrics.totalApplications}</div>
                        <div className="stat-detail" style={{
                            fontSize: '0.8rem',
                            color: 'var(--text-tertiary)'
                        }}>
                            {metrics.byTimeWindow.thisMonth} this month
                        </div>
                    </div>

                    <div className="stat-card">
                        <div className="stat-label" style={{
                            fontSize: '0.85rem',
                            color: 'var(--text-tertiary)',
                            marginBottom: '0.5rem'
                        }}>Callback rate</div>
                        <div className="stat-value" style={{
                            fontSize: '2rem',
                            fontWeight: 'bold',
                            color: 'var(--success)',
                            marginBottom: '0.25rem'
                        }}>{metrics.responseRate.percentage}%</div>
                        <div className="stat-detail" style={{
                            fontSize: '0.8rem',
                            color: 'var(--text-tertiary)'
                        }}>
                            {metrics.responseRate.count} engagements
                        </div>
                    </div>

                    <div className="stat-card">
                        <div className="stat-label" style={{
                            fontSize: '0.85rem',
                            color: 'var(--text-tertiary)',
                            marginBottom: '0.5rem'
                        }}>Interview rate</div>
                        <div className="stat-value" style={{
                            fontSize: '2rem',
                            fontWeight: 'bold',
                            color: 'var(--accent-primary)',
                            marginBottom: '0.25rem'
                        }}>{metrics.interviewConversionRate.percentage}%</div>
                        <div className="stat-detail" style={{
                            fontSize: '0.8rem',
                            color: 'var(--text-tertiary)'
                        }}>
                            {metrics.interviewConversionRate.count} reached interviews
                        </div>
                    </div>

                    <div className="stat-card">
                        <div className="stat-label" style={{
                            fontSize: '0.85rem',
                            color: 'var(--text-tertiary)',
                            marginBottom: '0.5rem'
                        }}>Active pipeline</div>
                        <div className="stat-value" style={{
                            fontSize: '2rem',
                            fontWeight: 'bold',
                            color: 'var(--text-primary)',
                            marginBottom: '0.25rem'
                        }}>{metrics.pipeline.total}</div>
                        <div className="stat-detail" style={{
                            fontSize: '0.8rem',
                            color: 'var(--text-tertiary)'
                        }}>
                            {metrics.pipeline.byStatus.Applied} idle Â· {metrics.pipeline.byStatus["In Progress"]} in progress
                        </div>
                    </div>

                    <div className="stat-card">
                        <div className="stat-label" style={{
                            fontSize: '0.85rem',
                            color: 'var(--text-tertiary)',
                            marginBottom: '0.5rem'
                        }}>Offers</div>
                        <div className="stat-value" style={{
                            fontSize: '2rem',
                            fontWeight: 'bold',
                            color: 'var(--warning)',
                            marginBottom: '0.25rem'
                        }}>{metrics.offerRate.count}</div>
                        <div className="stat-detail" style={{
                            fontSize: '0.8rem',
                            color: 'var(--text-tertiary)'
                        }}>
                            {metrics.offerRate.percentage}% of applications
                        </div>
                    </div>

                    <div className="stat-card">
                        <div className="stat-label" style={{
                            fontSize: '0.85rem',
                            color: 'var(--text-tertiary)',
                            marginBottom: '0.5rem'
                        }}>This week</div>
                        <div className="stat-value" style={{
                            fontSize: '2rem',
                            fontWeight: 'bold',
                            color: 'var(--text-primary)',
                            marginBottom: '0.25rem'
                        }}>{metrics.byTimeWindow.thisWeek}</div>
                        <div className="stat-detail" style={{
                            fontSize: '0.8rem',
                            color: 'var(--text-tertiary)'
                        }}>
                            applications submitted
                        </div>
                    </div>
                </div>
            );
        };

        /* ===========================================
        INSIGHTS PANEL
        =========================================== */

        const InsightsPanel = ({ insights }) => {
            if (!insights || insights.length === 0) return null;

            return (
                <div className="insights-panel">
                    <h3>Insights & recommendations</h3>
                    <div className="insights-list">
                        {insights.map((insight, index) => (
                            <div key={index} className={`insight-item insight-${insight.type}`}>
                                <div className="insight-icon">
                                    {insight.type === 'success' && 'âœ“'}
                                    {insight.type === 'warning' && 'âš '}
                                    {insight.type === 'info' && 'â„¹'}
                                </div>
                                <div className="insight-content">
                                    <div className="insight-title">{insight.title}</div>
                                    <div className="insight-description">{insight.description}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        /* ===========================================
        GENERATE INSIGHTS
        =========================================== */

        const generateInsights = (metrics, timeData, companyData) => {
            const insights = [];


            // Stale applications
            if (metrics.waiting.byDuration["60+ days"] > 0) {
                insights.push({
                    type: 'warning',
                    title: 'Stale Applications',
                    description: `${metrics.waiting.byDuration["60+ days"]} applications have been waiting 60+ days. Consider following up or marking as closed.`
                });
            }


            // Most responsive companies
            const topCompanies = companyData.mostResponsiveCompanies.slice(0, 3);
            if (topCompanies.length > 0 && topCompanies[0].responseRate > 50) {
                insights.push({
                    type: 'success',
                    title: 'Responsive Companies',
                    description: `${topCompanies[0].name} has a ${topCompanies[0].responseRate}% response rate from your ${topCompanies[0].total} applications. Consider applying to more roles there.`
                });
            }

            return insights;
        };

        /* ===========================================
        MAIN DASHBOARD COMPONENT
        =========================================== */

        const AnalyticsDashboard = ({ jobs }) => {
            const { useMemo, useState } = React;
            const [timeRange, setTimeRange] = useState('all');
            const [customStart, setCustomStart] = useState('');
            const [customEnd, setCustomEnd] = useState('');

            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                return (
                    <div style={{ padding: '2rem', color: '#ef4444' }}>
                        <h2>Chart.js library not loaded</h2>
                        <p>Please ensure Chart.js CDN is included in the HTML head:</p>
                        <code style={{
                            display: 'block',
                            padding: '1rem',
                            background: '#1a1f35',
                            borderRadius: '6px',
                            marginTop: '1rem',
                            color: '#10b981'
                        }}>
                            &lt;script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"&gt;&lt;/script&gt;
                        </code>
                    </div>
                );
            }

            // Helper function to filter data by time range
            const filterDataByTimeRange = (data, range) => {
                const now = new Date();
                let startDate = null;
                let endDate = null;

                switch (range) {
                    case 'past30':
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case 'past12months':
                        startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                        break;
                    case 'thisYear':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                    case 'lastYear':
                        startDate = new Date(now.getFullYear() - 1, 0, 1);
                        endDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59);
                        break;
                    case 'custom':
                        if (customStart) startDate = new Date(customStart);
                        break;
                    case 'all':
                    default:
                        return data;
                }

                if (!startDate) return data;

                return data.filter(item => {
                    // Parse label like "Jan 2025" or "January 2025"
                    const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    const labelLower = item.label.toLowerCase();
                    const yearMatch = item.label.match(/\d{4}/);
                    const year = yearMatch ? parseInt(yearMatch[0]) : null;

                    let month = null;
                    for (let i = 0; i < monthNames.length; i++) {
                        if (labelLower.includes(monthNames[i])) {
                            month = i;
                            break;
                        }
                    }

                    if (!year || month === null) return true;
                    const itemDate = new Date(year, month, 1);
                    if (itemDate < startDate) return false;
                    if (endDate && itemDate > endDate) return false;
                    return true;
                });
            };

            // Check if filtered data spans less than 1 month for daily granularity
            const shouldUseDailyData = (data) => {
                // Use prominent points for sparse data (3 or fewer data points)
                if (data.length <= 3) return true;

                const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                const parseMonthYear = (label) => {
                    const labelLower = label.toLowerCase();
                    const yearMatch = label.match(/\d{4}/);
                    const year = yearMatch ? parseInt(yearMatch[0]) : null;

                    let month = null;
                    for (let i = 0; i < monthNames.length; i++) {
                        if (labelLower.includes(monthNames[i])) {
                            month = i;
                            break;
                        }
                    }
                    return { year, month };
                };

                const first = parseMonthYear(data[0].label);
                const last = parseMonthYear(data[data.length - 1].label);

                if (!first.year || first.month === null || !last.year || last.month === null) return false;

                const firstDate = new Date(first.year, first.month, 1);
                const lastDate = new Date(last.year, last.month, 1);
                const diffTime = Math.abs(lastDate - firstDate);
                const diffMonths = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 30));

                return diffMonths < 1;
            };

            // Calculate all metrics
            const { overview, timeData, companyData, insights } = useMemo(() => {
                const overview = analytics.getJobSearchOverview(jobs);
                const timeData = analytics.getTimeBasedAnalytics(jobs);
                const companyData = analytics.getCompanyPriorityAnalytics(jobs);
                const insights = generateInsights(overview, timeData, companyData);

                return { overview, timeData, companyData, insights };
            }, [jobs]);

            // Prepare chart data
            const applicationsChartData = timeData.applicationsPerMonth.byMonth.map(item => ({
                label: item.label,
                value: item.count
            }));

            const responseRateChartData = timeData.responseRateByMonth.map(item => ({
                label: item.label,
                value1: item.followUps,    // Count of all follow-ups (fainter)
                value2: item.responded      // Count of actual responses (prominent)
            }));

            const pipelineChartData = (() => {
                const stages = ['Application', 'Recruiter Screen', 'Partial Loop', 'Full Loop', 'Offer'];
                const activeJobs = jobs.filter(j => j.status === 'In Progress' || j.status === 'Applied');
                return stages.map(stage => ({
                    label: stage,
                    value: activeJobs.filter(j => j.progression === stage).length
                }));
            })();

            const closureChartData = Object.entries(overview.closureReasons.counts)
                .filter(([_, count]) => count > 0)
                .map(([reason, count]) => ({
                    label: reason,
                    value: count
                }));

            const progressionChartData = analytics.getProgressionBreakdownForResponded(jobs);

            // Combine monthly applications and response activity into a single dataset
            // Use the UNION of months from applications and follow-ups so months with
            // follow-ups but no applications are included.
            const appsByMonth = {};
            (timeData.applicationsPerMonth.byMonth || []).forEach(item => {
                appsByMonth[item.month] = { label: item.label, applications: item.count };
            });

            const respByMonth = {};
            (timeData.responseRateByMonth || []).forEach(item => {
                respByMonth[item.month] = { label: item.label, followUps: item.followUps || 0, responded: item.responded || 0 };
            });

            const monthKeys = Array.from(new Set([...Object.keys(appsByMonth), ...Object.keys(respByMonth)])).sort();

            const combinedChartData = monthKeys.map(monthKey => {
                const app = appsByMonth[monthKey] || {
                    label: (() => {
                        const [y, m] = monthKey.split('-');
                        return new Date(parseInt(y), parseInt(m) - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                    })(), applications: 0
                };
                const resp = respByMonth[monthKey] || { followUps: 0, responded: 0 };
                return {
                    label: app.label,
                    applications: app.applications,
                    followUps: resp.followUps,
                    responded: resp.responded
                };
            });

            // Filter data by selected time range
            const filteredChartData = filterDataByTimeRange(combinedChartData, timeRange);

            return (
                <div className="analytics-dashboard">
                    {/* Key Metrics */}
                    <KeyMetricsGrid metrics={overview} />

                    {/* Charts Grid */}
                    <div className="charts-section">
                        {/* Large charts - full width */}
                        <div className="chart-large">
                            <ChartCard title="Applications & response activity">
                                <div style={{ marginBottom: '1rem', display: 'flex', gap: '0.75rem', flexWrap: 'wrap', alignItems: 'center' }}>
                                    <button
                                        onClick={() => setTimeRange('past30')}
                                        style={{
                                            padding: '0.4rem 0.8rem',
                                            fontSize: '0.85rem',
                                            borderRadius: '6px',
                                            border: timeRange === 'past30' ? '2px solid var(--accent-primary)' : '1px solid var(--border-primary)',
                                            background: timeRange === 'past30' ? 'var(--accent-primary)' : 'var(--bg-tertiary)',
                                            color: timeRange === 'past30' ? 'white' : 'var(--text-primary)',
                                            cursor: 'pointer',
                                            fontWeight: timeRange === 'past30' ? '600' : '500',
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        Past 30 days
                                    </button>
                                    <button
                                        onClick={() => setTimeRange('past12months')}
                                        style={{
                                            padding: '0.4rem 0.8rem',
                                            fontSize: '0.85rem',
                                            borderRadius: '6px',
                                            border: timeRange === 'past12months' ? '2px solid var(--accent-primary)' : '1px solid var(--border-primary)',
                                            background: timeRange === 'past12months' ? 'var(--accent-primary)' : 'var(--bg-tertiary)',
                                            color: timeRange === 'past12months' ? 'white' : 'var(--text-primary)',
                                            cursor: 'pointer',
                                            fontWeight: timeRange === 'past12months' ? '600' : '500',
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        Past 12 months
                                    </button>
                                    <button
                                        onClick={() => setTimeRange('thisYear')}
                                        style={{
                                            padding: '0.4rem 0.8rem',
                                            fontSize: '0.85rem',
                                            borderRadius: '6px',
                                            border: timeRange === 'thisYear' ? '2px solid var(--accent-primary)' : '1px solid var(--border-primary)',
                                            background: timeRange === 'thisYear' ? 'var(--accent-primary)' : 'var(--bg-tertiary)',
                                            color: timeRange === 'thisYear' ? 'white' : 'var(--text-primary)',
                                            cursor: 'pointer',
                                            fontWeight: timeRange === 'thisYear' ? '600' : '500',
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        This Year
                                    </button>
                                    <button
                                        onClick={() => setTimeRange('lastYear')}
                                        style={{
                                            padding: '0.4rem 0.8rem',
                                            fontSize: '0.85rem',
                                            borderRadius: '6px',
                                            border: timeRange === 'lastYear' ? '2px solid var(--accent-primary)' : '1px solid var(--border-primary)',
                                            background: timeRange === 'lastYear' ? 'var(--accent-primary)' : 'var(--bg-tertiary)',
                                            color: timeRange === 'lastYear' ? 'white' : 'var(--text-primary)',
                                            cursor: 'pointer',
                                            fontWeight: timeRange === 'lastYear' ? '600' : '500',
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        Last Year
                                    </button>
                                    <button
                                        onClick={() => setTimeRange('all')}
                                        style={{
                                            padding: '0.4rem 0.8rem',
                                            fontSize: '0.85rem',
                                            borderRadius: '6px',
                                            border: timeRange === 'all' ? '2px solid var(--accent-primary)' : '1px solid var(--border-primary)',
                                            background: timeRange === 'all' ? 'var(--accent-primary)' : 'var(--bg-tertiary)',
                                            color: timeRange === 'all' ? 'white' : 'var(--text-primary)',
                                            cursor: 'pointer',
                                            fontWeight: timeRange === 'all' ? '600' : '500',
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        All time
                                    </button>
                                </div>
                                {filteredChartData.length === 0 ? (
                                    <div style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)' }}>
                                        No data available for this time range
                                    </div>
                                ) : (
                                    <TripleLineChartComponent
                                        data={filteredChartData}
                                        label1="Applications"
                                        label2="Responses and rejections"
                                        label3="Actual callbacks"
                                        color1="#6b8aff"
                                        color2="#f59e0b"
                                        color3="#10b981"
                                        useDailyData={shouldUseDailyData(filteredChartData)}
                                    />
                                )}
                            </ChartCard>
                        </div>

                        {/* Medium Charts - Side by Side */}
                        <div className="chart-row">
                            <div className="chart-medium">
                                <ChartCard title="Active pipeline status">
                                    <FunnelChartComponent
                                        data={pipelineChartData}
                                    />
                                </ChartCard>
                            </div>

                            <div className="chart-medium">
                                <ChartCard title="Closure reasons">
                                    <PieChartComponent data={closureChartData} />
                                </ChartCard>
                            </div>
                        </div>

                        {/* Responses and Statuses Side by Side */}
                        <div className="chart-row">
                            <div className="chart-medium">
                                <ChartCard title="Responses by progression">
                                    <PieChartComponent data={progressionChartData} />
                                </ChartCard>
                            </div>

                            <div className="chart-medium">
                                <div className="stat-card">
                                    <h3 style={{
                                        fontSize: '0.8rem',
                                        color: 'var(--text-tertiary)',
                                        marginBottom: '0.75rem',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.1em',
                                        fontWeight: '600'
                                    }}>
                                        Application statuses
                                    </h3>
                                    <div className="table-container" style={{ border: 'none', background: 'transparent' }}>
                                        <table className="table">
                                            <thead>
                                                <tr>
                                                    <th>Status</th>
                                                    <th>Count</th>
                                                    <th>Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {STATUSES.map(status => {
                                                    const count = jobs.filter(j => j.status === status).length;
                                                    return (
                                                        <tr key={status}>
                                                            <td><StatusBadge status={status} /></td>
                                                            <td><strong>{count}</strong></td>
                                                            <td>{jobs.length > 0 ? Math.round((count / jobs.length) * 100) : 0}%</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Insights */}
                    <InsightsPanel insights={insights} />
                </div>
            );
        };

        /* Export for global access */
        window.AnalyticsDashboard = AnalyticsDashboard;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('React Error Boundary caught:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '2rem', color: '#e4e6eb', background: '#0a0e1a', minHeight: '100vh' }}>
                            <h1 style={{ color: '#ff6b6b' }}>Something went wrong</h1>
                            <p>Error: {this.state.error?.message}</p>
                            <button
                                onClick={() => window.location.reload()}
                                style={{
                                    background: '#6b8aff',
                                    color: 'white',
                                    border: 'none',
                                    padding: '0.75rem 1.5rem',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    marginTop: '1rem'
                                }}
                            >
                                Reload Page
                            </button>
                            <pre style={{
                                marginTop: '1rem',
                                padding: '1rem',
                                background: '#1a1f35',
                                borderRadius: '6px',
                                overflow: 'auto'
                            }}>
                                {this.state.error?.stack}
                            </pre>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        // Target companies data
        const DEFAULT_COMPANIES = {
            "Fintech": [
                { name: "Stripe", url: "https://stripe.com/jobs/search" }
            ],
            "Data Infra": [
                { name: "Snowflake", url: "https://careers.snowflake.com/us/en/search-results" }
            ],
            "AI/ML": [
                { name: "Anthropic", url: "https://www.anthropic.com/careers/jobs" },
                { name: "OpenAI", url: "https://openai.com/careers/search" }
            ],
            "Big Tech": [
                { name: "Microsoft", url: "https://apply.careers.microsoft.com/careers" },
                { name: "Google", url: "https://www.google.com/about/careers/applications/jobs/results/" }
            ],
            "Enterprise SaaS": [
                { name: "ServiceNow", url: "https://careers.servicenow.com/careers/jobs" }
            ],
            "Marketplaces": [
                { name: "DoorDash", url: "https://careers.doordash.com/jobs" },
                { name: "Zillow", url: "https://zillow.wd5.myworkdayjobs.com/Zillow_Group_External" }
            ],
            "Media/Streaming": [
                { name: "Netflix", url: "https://explore.jobs.netflix.net/careers" }
            ]
        };

        /* ===========================================
           UTILITY FUNCTIONS
           =========================================== */

        /**
         * Storage utilities for localStorage operations with security
         */
        const StorageUtil = {
            /**
             * Get item from localStorage with error handling and validation
             * @param {string} key - Storage key
             * @param {*} defaultValue - Default value if key not found
             * @returns {*} Parsed value or default
             */
            get(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    if (!item) return defaultValue;

                    const parsed = JSON.parse(item);

                    // Basic validation based on key type
                    if (key === APP_CONFIG.STORAGE_KEYS.JOBS) {
                        if (!Array.isArray(parsed)) {
                            console.warn('Invalid jobs data structure, using default');
                            return defaultValue;
                        }
                        // Limit check
                        if (parsed.length > SecurityUtil.CONFIG.MAX_JOBS_COUNT) {
                            console.warn('Jobs count exceeds limit, truncating');
                            return parsed.slice(0, SecurityUtil.CONFIG.MAX_JOBS_COUNT);
                        }
                    }

                    return parsed;
                } catch (error) {
                    SecurityUtil.handleError(error, 'loading data', false);
                    return defaultValue;
                }
            },

            /**
             * Set item in localStorage with error handling and size check
             * @param {string} key - Storage key
             * @param {*} value - Value to store (will be JSON stringified)
             * @returns {boolean} Success status
             */
            set(key, value) {
                try {
                    const jsonString = JSON.stringify(value);

                    // Check size (localStorage typically has 5-10MB limit)
                    const sizeInMB = new Blob([jsonString]).size / (1024 * 1024);
                    if (sizeInMB > 5) {
                        console.warn(`Data size (${sizeInMB.toFixed(2)}MB) approaching localStorage limits`);
                        alert(`Warning: Your data is getting large (${sizeInMB.toFixed(2)}MB). Consider exporting a backup.`);
                    }

                    localStorage.setItem(key, jsonString);
                    return true;
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        SecurityUtil.handleError(
                            new Error('Storage quota exceeded. Please export and clear old data.'),
                            'saving data'
                        );
                    } else {
                        SecurityUtil.handleError(error, 'saving data', false);
                    }
                    return false;
                }
            },

            /**
             * Remove item from localStorage with error handling
             * @param {string} key - Storage key
             */
            remove(key) {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    SecurityUtil.handleError(error, 'removing data', false);
                }
            },

            /**
             * Get storage usage statistics
             * @returns {Object} Storage usage info
             */
            getUsageStats() {
                try {
                    let total = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            total += localStorage[key].length + key.length;
                        }
                    }
                    return {
                        used: total,
                        usedMB: (total / (1024 * 1024)).toFixed(2),
                        estimated: '5-10MB typical limit'
                    };
                } catch (error) {
                    return { error: 'Unable to calculate usage' };
                }
            }
        };

        /**
         * Company fit level utility functions
         */
        const FitLevelUtil = {
            /**
             * Convert fit level value to label
             * @param {number|null} value - Numeric fit level
             * @returns {string} Human-readable label
             */
            getLabel(value) {
                const level = Object.values(FIT_LEVELS).find(l => l.value === value);
                return level ? level.label : FIT_LEVELS.UNSET.label;
            },

            /**
             * Convert fit level label to value
             * @param {string} label - Human-readable label
             * @returns {number|null} Numeric fit level
             */
            getValue(label) {
                const level = Object.values(FIT_LEVELS).find(l => l.label === label);
                return level ? level.value : FIT_LEVELS.UNSET.value;
            },

            /**
             * Sort comparator for fit levels
             * @param {number|null} a - First value
             * @param {number|null} b - Second value
             * @param {string} direction - 'asc' or 'desc'
             * @returns {number} Sort order
             */
            compare(a, b, direction = 'desc') {
                // Unset values always sort last
                if (a === null && b === null) return 0;
                if (a === null) return 1;
                if (b === null) return -1;

                return direction === 'desc' ? b - a : a - b;
            }
        };

        /**
         * Legacy function aliases for backward compatibility
         */
        const getFitLevelLabel = FitLevelUtil.getLabel;
        const getFitLevelValue = FitLevelUtil.getValue;
        const sortByFitLevel = FitLevelUtil.compare;

        /* ===========================================
           SECURITY & VALIDATION MODULE
           =========================================== */

        const SecurityUtil = {
            // Security configuration
            CONFIG: {
                MAX_STRING_LENGTH: 10000,
                MAX_URL_LENGTH: 2048,
                MAX_JOBS_COUNT: 10000,
                MAX_COMPANIES_COUNT: 5000,
                MAX_IMPORT_SIZE_MB: 10,
                ALLOWED_URL_PROTOCOLS: ['http:', 'https:'],
                RATE_LIMIT_MS: 100 // Min time between operations
            },

            /**
             * Sanitize HTML to prevent XSS attacks
             * @param {string} str - String to sanitize
             * @returns {string} Sanitized string
             */
            sanitizeHTML(str) {
                if (typeof str !== 'string') return '';

                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            /**
             * Validate and sanitize URL
             * @param {string} url - URL to validate
             * @returns {string|null} Sanitized URL or null if invalid
             */
            validateURL(url) {
                if (!url || typeof url !== 'string') return null;

                // Length check
                if (url.length > this.CONFIG.MAX_URL_LENGTH) {
                    console.warn('URL exceeds maximum length');
                    return null;
                }

                try {
                    const urlObj = new URL(url);

                    // Protocol whitelist
                    if (!this.CONFIG.ALLOWED_URL_PROTOCOLS.includes(urlObj.protocol)) {
                        console.warn('Invalid URL protocol:', urlObj.protocol);
                        return null;
                    }

                    // Prevent javascript: and data: URIs
                    if (urlObj.protocol === 'javascript:' || urlObj.protocol === 'data:') {
                        console.warn('Blocked dangerous URL protocol');
                        return null;
                    }

                    return urlObj.href;
                } catch (e) {
                    console.warn('Invalid URL format:', url);
                    return null;
                }
            },

            /**
             * Validate string length
             * @param {string} str - String to validate
             * @param {number} maxLength - Maximum allowed length
             * @returns {boolean} Whether string is valid
             */
            validateStringLength(str, maxLength = this.CONFIG.MAX_STRING_LENGTH) {
                if (typeof str !== 'string') return false;
                return str.length <= maxLength;
            },

            /**
             * Sanitize text input
             * @param {string} input - Input to sanitize
             * @param {number} maxLength - Maximum length
             * @returns {string} Sanitized input
             */
            sanitizeInput(input, maxLength = this.CONFIG.MAX_STRING_LENGTH) {
                if (typeof input !== 'string') return '';

                // Truncate if too long
                let sanitized = input.slice(0, maxLength);

                // Remove null bytes
                sanitized = sanitized.replace(/\0/g, '');

                // Trim whitespace
                sanitized = sanitized.trim();

                return sanitized;
            },

            /**
             * Validate job object structure and data
             * @param {Object} job - Job object to validate
             * @returns {Object} Validated and sanitized job object
             * @throws {Error} If validation fails
             */
            validateJobData(job) {
                if (!job || typeof job !== 'object') {
                    throw new Error('Invalid job data: must be an object');
                }

                // Required fields validation
                const requiredFields = ['company', 'role'];
                for (const field of requiredFields) {
                    if (!job[field] || typeof job[field] !== 'string') {
                        throw new Error(`Invalid job data: ${field} is required`);
                    }
                }

                // Sanitize and validate each field
                const validated = {
                    id: job.id || Date.now(),
                    company: this.sanitizeInput(job.company, 200),
                    role: this.sanitizeInput(job.role, 200),
                    status: this.validateEnum(job.status, Object.values(JOB_STATUSES), JOB_STATUSES.APPLIED),
                    priority: this.validateEnum(job.priority, Object.values(PRIORITY_TIERS), PRIORITY_TIERS.TIER_2),
                    dateApplied: this.validateDate(job.dateApplied),
                    url: job.url ? this.validateURL(job.url) : '',
                    salary: this.sanitizeInput(job.salary || '', 100),
                    location: this.sanitizeInput(job.location || '', 200),
                    contact: this.sanitizeInput(job.contact || '', 200),
                    notes: this.sanitizeInput(job.notes || '', 5000),
                    followUp: job.followUp ? this.validateDate(job.followUp, false) : '',
                    progression: this.validateEnum(job.progression, Object.values(PROGRESSION_STAGES), PROGRESSION_STAGES.APPLICATION),
                    closeReason: job.closeReason ? this.validateEnum(job.closeReason, Object.values(CLOSE_REASONS), '') : '',
                    resumeUrl: job.resumeUrl ? this.validateURL(job.resumeUrl) : '',
                    coverLetterUrl: job.coverLetterUrl ? this.validateURL(job.coverLetterUrl) : ''
                };

                // Validate combined data size
                const dataSize = JSON.stringify(validated).length;
                if (dataSize > 50000) {
                    throw new Error('Job data exceeds maximum size');
                }

                return validated;
            },

            /**
             * Validate company object
             * @param {Object} company - Company object to validate
             * @returns {Object} Validated company object
             * @throws {Error} If validation fails
             */
            validateCompanyData(company) {
                if (!company || typeof company !== 'object') {
                    throw new Error('Invalid company data');
                }

                if (!company.name || typeof company.name !== 'string') {
                    throw new Error('Company name is required');
                }

                return {
                    name: this.sanitizeInput(company.name, 200),
                    url: company.url ? this.validateURL(company.url) : '',
                    category: this.sanitizeInput(company.category || 'None', 100),
                    fitLevel: company.fitLevel !== undefined ? this.validateFitLevel(company.fitLevel) : null
                };
            },

            /**
             * Validate enum value
             * @param {*} value - Value to validate
             * @param {Array} allowedValues - Array of allowed values
             * @param {*} defaultValue - Default if invalid
             * @returns {*} Validated value or default
             */
            validateEnum(value, allowedValues, defaultValue) {
                return allowedValues.includes(value) ? value : defaultValue;
            },

            /**
             * Validate date string
             * @param {string} dateStr - Date string to validate
             * @param {boolean} required - Whether date is required
             * @returns {string} Validated ISO date string
             */
            validateDate(dateStr, required = true) {
                if (!dateStr) {
                    return required ? new Date().toISOString().split('T')[0] : '';
                }

                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    return required ? new Date().toISOString().split('T')[0] : '';
                }

                // Validate date is not too far in past or future
                const minDate = new Date('2000-01-01');
                const maxDate = new Date('2100-01-01');

                if (date < minDate || date > maxDate) {
                    console.warn('Date out of valid range:', dateStr);
                    return required ? new Date().toISOString().split('T')[0] : '';
                }

                return date.toISOString().split('T')[0];
            },

            /**
             * Validate fit level value
             * @param {number|null} value - Fit level value
             * @returns {number|null} Validated fit level
             */
            validateFitLevel(value) {
                if (value === null || value === undefined) return null;
                const numValue = parseInt(value);
                return [1, 2, 3].includes(numValue) ? numValue : null;
            },

            /**
             * Validate import data structure and size
             * @param {string} jsonString - JSON string to validate
             * @returns {Object} Parsed and validated data
             * @throws {Error} If validation fails
             */
            validateImportData(jsonString) {
                // Size check
                const sizeInMB = new Blob([jsonString]).size / (1024 * 1024);
                if (sizeInMB > this.CONFIG.MAX_IMPORT_SIZE_MB) {
                    throw new Error(`Import file too large: ${sizeInMB.toFixed(2)}MB (max: ${this.CONFIG.MAX_IMPORT_SIZE_MB}MB)`);
                }

                let data;
                try {
                    data = JSON.parse(jsonString);
                } catch (e) {
                    throw new Error('Invalid JSON format: ' + e.message);
                }

                // Structure validation
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid backup format: must be an object');
                }

                if (!data.jobs || !Array.isArray(data.jobs)) {
                    throw new Error('Invalid backup format: jobs array required');
                }

                // Quantity limits
                if (data.jobs.length > this.CONFIG.MAX_JOBS_COUNT) {
                    throw new Error(`Too many jobs: ${data.jobs.length} (max: ${this.CONFIG.MAX_JOBS_COUNT})`);
                }

                if (data.customCompanies) {
                    const companyCount = Object.keys(data.customCompanies).length;
                    if (companyCount > this.CONFIG.MAX_COMPANIES_COUNT) {
                        throw new Error(`Too many companies: ${companyCount} (max: ${this.CONFIG.MAX_COMPANIES_COUNT})`);
                    }
                }

                return data;
            },

            /**
             * Secure error handler - logs details but shows safe message to user
             * @param {Error} error - Error object
             * @param {string} context - Context where error occurred
             * @param {boolean} showToUser - Whether to show alert to user
             */
            handleError(error, context, showToUser = true) {
                // Log full error for debugging
                console.error(`[${context}]`, error);

                // Show sanitized message to user
                if (showToUser) {
                    const safeMessage = this.getSafeErrorMessage(error, context);
                    alert(safeMessage);
                }
            },

            /**
             * Get user-safe error message (no stack traces or sensitive info)
             * @param {Error} error - Error object
             * @param {string} context - Error context
             * @returns {string} Safe error message
             */
            getSafeErrorMessage(error, context) {
                const baseMessage = `An error occurred while ${context}.`;

                // Only show specific error if it's a validation error
                if (error.message && error.message.startsWith('Invalid')) {
                    return `${baseMessage}\n${error.message}`;
                }

                return `${baseMessage}\nPlease try again or contact support if the issue persists.`;
            },

            /**
             * Enhanced rate limiter with adaptive throttling
             */
            _lastOperationTime: 0,
            _operationQueue: [],
            _isProcessing: false,
            _recentErrors: 0,

            /**
             * Adaptive rate limit based on system state
             */
            getAdaptiveRateLimit() {
                // Base rate limit
                let limit = this.CONFIG.RATE_LIMIT_MS;

                // Increase if there are queued operations (system under load)
                if (this._operationQueue.length > 5) {
                    limit *= 2; // Double the limit if queue is building
                }

                // Increase if there have been recent errors (system stressed)
                if (this._recentErrors > 3) {
                    limit *= 1.5; // Increase by 50% if errors detected
                }

                return limit;
            },

            /**
             * Queue and throttle operations
             */
            async queueOperation(fn, operationName) {
                const adaptive = this.getAdaptiveRateLimit();
                const now = Date.now();

                if (now - this._lastOperationTime < adaptive) {
                    const waitTime = adaptive - (now - this._lastOperationTime);
                    LoggerUtil.warn('Operation queued due to rate limit', { operation: operationName, waitTime });
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }

                this._lastOperationTime = Date.now();

                try {
                    const result = await fn();
                    // Reset error count on success
                    this._recentErrors = Math.max(0, this._recentErrors - 1);
                    return result;
                } catch (error) {
                    this._recentErrors++;
                    throw error;
                }
            },

            checkRateLimit() {
                const adaptive = this.getAdaptiveRateLimit();
                const now = Date.now();
                if (now - this._lastOperationTime < adaptive) {
                    throw new Error('Operation rate limit exceeded. Please wait.');
                }
                this._lastOperationTime = now;
            },

            /**
             * Generate data integrity hash (simple checksum)
             * @param {Object} data - Data to hash
             * @returns {string} Simple checksum
             */
            generateChecksum(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash.toString(36);
            },

            /**
             * Verify data integrity
             * @param {Object} data - Data to verify
             * @param {string} checksum - Expected checksum
             * @returns {boolean} Whether data is intact
             */
            verifyChecksum(data, checksum) {
                return this.generateChecksum(data) === checksum;
            }
        };

        /**
         * UI Utility Module
         * Provides UI-related helper functions
         */
        const UIUtil = {
            /**
             * Convert URLs in text to clickable links
             * @param {string} text - Text containing URLs
             * @returns {string} HTML string with clickable links
             */
            linkify(text) {
                if (!text) return '';

                // Regular expression to detect URLs
                const urlPattern = /(https?:\/\/[^\s]+)|(www\.[^\s]+)/g;

                return text.replace(urlPattern, (url) => {
                    // Add protocol if missing (for www. links)
                    const href = url.startsWith('http') ? url : `http://${url}`;
                    return `<a href="${href}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-primary); text-decoration: underline;">${url}</a>`;
                });
            }
        };

        /**
         * Performance & Observability Module
         * Tracks metrics, provides caching, throttling, and monitoring
         * 
         * OPTIMIZATIONS IMPLEMENTED:
         * - Multi-level caching with TTL for expensive computations
         * - Debouncing for storage writes (1s) to reduce I/O
         * - Index-based job lookups (O(1) vs O(n) for common queries)
         * - Memoization of filtered/sorted job arrays
         * - Performance metrics tracking and reporting
         * - Structured logging with categorization
         * - Adaptive rate limiting based on system load
         * - Request queuing for graceful degradation
         * - Cache invalidation on data mutations
         */
        const PerformanceUtil = {
            // Metrics collection
            metrics: {
                operationTimes: {},
                cacheHits: 0,
                cacheMisses: 0,
                throttledCalls: 0,
                errorCount: 0,
                lastOperations: []
            },

            // Simple in-memory cache with TTL
            cache: new Map(),
            cacheTimeouts: new Map(),

            /**
             * Memoize expensive computations
             * @param {string} key - Cache key
             * @param {Function} fn - Computation function
             * @param {number} ttl - Time to live in ms (default 5000)
             * @returns {*} Cached or computed value
             */
            memoize(key, fn, ttl = 5000) {
                if (this.cache.has(key)) {
                    this.metrics.cacheHits++;
                    return this.cache.get(key);
                }

                this.metrics.cacheMisses++;
                const result = fn();
                this.cache.set(key, result);

                // Clear timeout if exists
                if (this.cacheTimeouts.has(key)) {
                    clearTimeout(this.cacheTimeouts.get(key));
                }

                // Set new timeout for cache invalidation
                const timeoutId = setTimeout(() => {
                    this.cache.delete(key);
                    this.cacheTimeouts.delete(key);
                }, ttl);

                this.cacheTimeouts.set(key, timeoutId);
                return result;
            },

            /**
             * Clear cache for specific keys
             */
            clearCache(...keys) {
                keys.forEach(key => {
                    if (this.cacheTimeouts.has(key)) {
                        clearTimeout(this.cacheTimeouts.get(key));
                        this.cacheTimeouts.delete(key);
                    }
                    this.cache.delete(key);
                });
            },

            /**
             * Clear cache entries by prefix
             * @param  {...string} prefixes - Cache key prefixes
             */
            clearCacheByPrefix(...prefixes) {
                const keys = Array.from(this.cache.keys());
                keys.forEach(k => {
                    if (prefixes.some(p => k.startsWith(p))) {
                        if (this.cacheTimeouts.has(k)) {
                            clearTimeout(this.cacheTimeouts.get(k));
                            this.cacheTimeouts.delete(k);
                        }
                        this.cache.delete(k);
                    }
                });
            },

            /**
             * Create debounced function
             * @param {Function} fn - Function to debounce
             * @param {number} delay - Delay in ms
             * @returns {Function} Debounced function
             */
            debounce(fn, delay = 300) {
                let timeoutId;
                let lastCallTime = 0;
                const self = this;

                return function debounced(...args) {
                    const now = Date.now();

                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }

                    timeoutId = setTimeout(() => {
                        if (self && self.metrics) {
                            self.metrics.throttledCalls++;
                        }
                        fn.apply(this, args);
                    }, delay);
                };
            },

            /**
             * Create throttled function
             * @param {Function} fn - Function to throttle
             * @param {number} interval - Minimum interval in ms
             * @returns {Function} Throttled function
             */
            throttle(fn, interval = 300) {
                let lastCallTime = 0;

                return function throttled(...args) {
                    const now = Date.now();

                    if (now - lastCallTime >= interval) {
                        lastCallTime = now;
                        return fn.apply(this, args);
                    }
                    this.metrics.throttledCalls++;
                };
            },

            /**
             * Measure operation time
             * @param {string} operation - Operation name
             * @param {Function} fn - Function to measure
             * @returns {*} Function result
             */
            measure(operation, fn) {
                const start = performance.now();
                const result = fn();
                const duration = performance.now() - start;

                if (!this.metrics.operationTimes[operation]) {
                    this.metrics.operationTimes[operation] = [];
                }

                this.metrics.operationTimes[operation].push(duration);

                // Keep only last 100 measurements per operation
                if (this.metrics.operationTimes[operation].length > 100) {
                    this.metrics.operationTimes[operation].shift();
                }

                return result;
            },

            /**
             * Get average operation time
             */
            getAvgTime(operation) {
                const times = this.metrics.operationTimes[operation];
                if (!times || times.length === 0) return 0;
                return times.reduce((a, b) => a + b, 0) / times.length;
            },

            /**
             * Get performance report
             */
            getReport() {
                const report = {
                    cacheStats: {
                        hits: this.metrics.cacheHits,
                        misses: this.metrics.cacheMisses,
                        hitRate: this.metrics.cacheHits + this.metrics.cacheMisses > 0
                            ? (this.metrics.cacheHits / (this.metrics.cacheHits + this.metrics.cacheMisses) * 100).toFixed(2) + '%'
                            : 'N/A'
                    },
                    operationStats: {},
                    memoryUsage: {
                        cacheSize: this.cache.size,
                        logCount: LoggerUtil.logs.length
                    }
                };

                for (const [op, times] of Object.entries(this.metrics.operationTimes)) {
                    if (times.length > 0) {
                        report.operationStats[op] = {
                            count: times.length,
                            avg: (times.reduce((a, b) => a + b, 0) / times.length).toFixed(2) + 'ms',
                            min: Math.min(...times).toFixed(2) + 'ms',
                            max: Math.max(...times).toFixed(2) + 'ms'
                        };
                    }
                }

                return report;
            },

            /**
             * Clear old caches and logs to manage memory
             */
            cleanup() {
                // Clear all caches
                this.cache.clear();
                this.cacheTimeouts.forEach(timeout => clearTimeout(timeout));
                this.cacheTimeouts.clear();

                // Reset metrics (keep for reporting, but clear operation details)
                this.metrics.operationTimes = {};
                this.metrics.throttledCalls = 0;

                // Clear old logs (keep only last 100)
                if (LoggerUtil.logs.length > 100) {
                    LoggerUtil.logs = LoggerUtil.logs.slice(-100);
                }
            },

            /**
             * Get memory stats
             */
            getMemoryStats() {
                const stats = {
                    cacheSize: this.cache.size,
                    cacheTimeouts: this.cacheTimeouts.size,
                    logCount: LoggerUtil.logs.length,
                    metricsOperations: Object.keys(this.metrics.operationTimes).length
                };

                if (performance.memory) {
                    stats.heapUsed = (performance.memory.usedJSHeapSize / 1048576).toFixed(2) + ' MB';
                    stats.heapLimit = (performance.memory.jsHeapSizeLimit / 1048576).toFixed(2) + ' MB';
                }

                return stats;
            }
        };

        /**
         * Logger Module
         * Provides structured logging and error tracking
         */
        const LoggerUtil = {
            logs: [],
            maxLogs: 1000,

            LOG_LEVELS: {
                DEBUG: 'DEBUG',
                INFO: 'INFO',
                WARN: 'WARN',
                ERROR: 'ERROR'
            },

            /**
             * Log a message with structured data
             */
            log(level, message, data = {}) {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    timestamp,
                    level,
                    message,
                    data,
                    userAgent: navigator.userAgent
                };

                this.logs.push(logEntry);

                // Keep only recent logs
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }

                // Also log to console in development
                const consoleMethod = level === 'ERROR' ? 'error' : level === 'WARN' ? 'warn' : 'log';
                console[consoleMethod](`[${timestamp}] ${level}: ${message}`, data);
            },

            debug(message, data) {
                this.log(this.LOG_LEVELS.DEBUG, message, data);
            },

            info(message, data) {
                this.log(this.LOG_LEVELS.INFO, message, data);
            },

            warn(message, data) {
                this.log(this.LOG_LEVELS.WARN, message, data);
            },

            error(message, data) {
                this.log(this.LOG_LEVELS.ERROR, message, data);
            },

            /**
             * Get logs filtered by level and date range
             */
            getLogs(level = null, hoursBack = 24) {
                const cutoffTime = new Date(Date.now() - hoursBack * 60 * 60 * 1000);
                let filtered = this.logs.filter(log => new Date(log.timestamp) >= cutoffTime);

                if (level) {
                    filtered = filtered.filter(log => log.level === level);
                }

                return filtered;
            },

            /**
             * Export logs for debugging
             */
            exportLogs() {
                return {
                    exported: new Date().toISOString(),
                    totalLogs: this.logs.length,
                    logs: this.logs
                };
            },

            /**
             * Track user action with metrics
             */
            trackAction(action, category, data = {}) {
                this.info(`User Action: ${action}`, {
                    category,
                    ...data
                });
            },

            /**
             * Track performance of operations
             */
            trackPerformance(operation, duration, success = true) {
                this.info(`Operation: ${operation}`, {
                    duration: `${duration.toFixed(2)}ms`,
                    success,
                    category: 'performance'
                });
            }
        };

        // Main App Component
        function App() {
            // Theme state
            const [theme, setTheme] = useState(() => {
                const saved = localStorage.getItem('theme');
                return saved || 'light';
            });

            // Apply theme to document
            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            };

            const [view, setView] = useState("dashboard");
            const [jobs, setJobs] = useState(() => {
                const saved = localStorage.getItem("jobs");
                return saved ? JSON.parse(saved) : [];
            });
            // Add blockedCompanies state
            const [customCompanies, setCustomCompanies] = useState({});
            const [customCategories, setCustomCategories] = useState(() => {
                const saved = localStorage.getItem("customCategories");
                return saved ? JSON.parse(saved) : {};
            });
            const [deletedCategories, setDeletedCategories] = useState(() => {
                const saved = localStorage.getItem("deletedCategories");
                return saved ? JSON.parse(saved) : [];
            });
            const [blockedCompanies, setBlockedCompanies] = useState(() => {
                const saved = localStorage.getItem("blockedCompanies");
                return saved ? JSON.parse(saved) : [];
            });

            const [showModal, setShowModal] = useState(false);
            const [showCompanyModal, setShowCompanyModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [editingJob, setEditingJob] = useState(null);
            const [lastBackupTime, setLastBackupTime] = useState(null);
            const [filters, setFilters] = useState({
                status: "all",
                priority: "all",
                company: "",
                search: ""
            });
            const [sortConfig, setSortConfig] = useState({ key: 'dateApplied', direction: 'desc' });

            // Load jobs from localStorage with security validation
            useEffect(() => {
                try {
                    const savedJobs = StorageUtil.get(APP_CONFIG.STORAGE_KEYS.JOBS, []);
                    if (Array.isArray(savedJobs) && savedJobs.length > 0) {
                        // Validate each job object
                        const validJobs = [];
                        const errors = [];

                        for (let i = 0; i < savedJobs.length; i++) {
                            try {
                                const validatedJob = SecurityUtil.validateJobData(savedJobs[i]);
                                validJobs.push(validatedJob);
                            } catch (validationError) {
                                errors.push(`Job ${i + 1}: ${validationError.message}`);
                                console.warn(`Skipping invalid job at index ${i}:`, validationError);
                            }
                        }

                        if (errors.length > 0 && errors.length < savedJobs.length) {
                            console.warn(`Loaded ${validJobs.length} valid jobs, skipped ${errors.length} invalid entries`);
                        }

                        setJobs(validJobs);
                    }

                    const savedCompanies = StorageUtil.get(APP_CONFIG.STORAGE_KEYS.CUSTOM_COMPANIES, {});
                    if (savedCompanies && typeof savedCompanies === 'object') {
                        // Validate company data
                        const validCompanies = {};
                        for (const [name, data] of Object.entries(savedCompanies)) {
                            try {
                                validCompanies[name] = SecurityUtil.validateCompanyData({ ...data, name });
                            } catch (err) {
                                console.warn(`Skipping invalid company ${name}:`, err);
                            }
                        }
                        setCustomCompanies(validCompanies);
                    }

                    const savedBackupTime = localStorage.getItem(APP_CONFIG.STORAGE_KEYS.LAST_BACKUP);
                    if (savedBackupTime) {
                        const backupDate = new Date(savedBackupTime);
                        if (!isNaN(backupDate.getTime())) {
                            setLastBackupTime(backupDate);
                        }
                    }
                } catch (error) {
                    SecurityUtil.handleError(error, 'loading saved data');
                }
            }, []);
            // Create debounced save functions to avoid excessive writes
            const debouncedSaveJobs = useRef(
                PerformanceUtil.debounce(function (jobsData) {
                    try {
                        const startTime = performance.now();
                        StorageUtil.set(APP_CONFIG.STORAGE_KEYS.JOBS, jobsData);
                        const duration = performance.now() - startTime;
                        LoggerUtil.trackPerformance('persistJobs', duration, true);
                    } catch (error) {
                        LoggerUtil.error('Error saving jobs', { error: error.message });
                        SecurityUtil.handleError(error, 'saving jobs');
                    }
                }, 1000)
            ).current;

            const debouncedSaveCompanies = useRef(
                PerformanceUtil.debounce(function (companiesData) {
                    try {
                        const startTime = performance.now();
                        StorageUtil.set(APP_CONFIG.STORAGE_KEYS.CUSTOM_COMPANIES, companiesData);
                        const duration = performance.now() - startTime;
                        LoggerUtil.trackPerformance('persistCompanies', duration, true);
                    } catch (error) {
                        LoggerUtil.error('Error saving companies', { error: error.message });
                        SecurityUtil.handleError(error, 'saving companies');
                    }
                }, 1000)
            ).current;

            // Save jobs to localStorage with validation (debounced)
            useEffect(() => {
                if (jobs.length === 0) return; // Don't save empty array on initial load
                debouncedSaveJobs(jobs);
            }, [jobs]);

            // Save custom companies to localStorage with validation (debounced)
            useEffect(() => {
                debouncedSaveCompanies(customCompanies);
            }, [customCompanies]);

            // Save blockedCompanies to localStorage (debounced)
            useEffect(() => {
                const saveBlocked = PerformanceUtil.debounce(function () {
                    localStorage.setItem("blockedCompanies", JSON.stringify(blockedCompanies));
                }, 500);
                saveBlocked();
            }, [blockedCompanies]);

            // Ensure pending changes are flushed before unload to avoid data loss
            useEffect(() => {
                const flushOnUnload = () => {
                    try {
                        StorageUtil.set(APP_CONFIG.STORAGE_KEYS.JOBS, jobs);
                        StorageUtil.set(APP_CONFIG.STORAGE_KEYS.CUSTOM_COMPANIES, customCompanies);
                        localStorage.setItem('blockedCompanies', JSON.stringify(blockedCompanies));
                        localStorage.setItem('customCategories', JSON.stringify(customCategories));
                        localStorage.setItem('deletedCategories', JSON.stringify(deletedCategories));
                    } catch (e) {
                        console.warn('Failed to flush data on unload:', e);
                    }
                };
                window.addEventListener('beforeunload', flushOnUnload);
                return () => window.removeEventListener('beforeunload', flushOnUnload);
            }, [jobs, customCompanies, blockedCompanies, customCategories, deletedCategories]);
            // Merge default and custom companies
            // Start with hardcoded companies and merge custom categories
            const mergedCompanies = { ...DEFAULT_COMPANIES, ...customCategories };
            
            // Filter out deleted categories
            const allCompanies = {};
            Object.keys(mergedCompanies).forEach(category => {
                if (!deletedCategories.includes(category)) {
                    allCompanies[category] = mergedCompanies[category];
                }
            });

            // Merge in custom company edits (URL, name, and fitLevel overrides)
            Object.entries(customCompanies).forEach(([companyName, customData]) => {
                let companyFound = false;
                let originalCategory = null;

                // Migrate old "Applied" category to "None"
                const normalizedData = {
                    ...customData,
                    category: customData.category === 'Applied' ? 'None' : customData.category
                };

                // Find and update the company across all categories
                Object.keys(allCompanies).forEach(category => {
                    const companyIndex = allCompanies[category].findIndex(c => c.name === companyName);
                    if (companyIndex !== -1) {
                        originalCategory = category;
                        
                        // If category has changed, remove from old category and add to new
                        if (normalizedData.category && normalizedData.category !== category) {
                            allCompanies[category].splice(companyIndex, 1);
                            
                            // Add to new category
                            if (!allCompanies[normalizedData.category]) {
                                allCompanies[normalizedData.category] = [];
                            }
                            allCompanies[normalizedData.category].push({
                                name: companyName,
                                ...normalizedData
                            });
                        } else {
                            // Category hasn't changed, just update in place
                            allCompanies[category][companyIndex] = {
                                ...allCompanies[category][companyIndex],
                                ...normalizedData
                            };
                        }
                        companyFound = true;
                    }
                });

                // If company wasn't found in existing categories, add it to its specified category
                if (!companyFound && normalizedData.category) {
                    if (!allCompanies[normalizedData.category]) {
                        allCompanies[normalizedData.category] = [];
                    }
                    allCompanies[normalizedData.category].push({
                        name: companyName,
                        ...normalizedData
                    });
                }
            });

            // Add companies from jobs data
            jobs.forEach(job => {
                if (!job.company) return;

                // Check if company already exists in any category
                const existsInDefaults = Object.values(DEFAULT_COMPANIES)
                    .flat()
                    .some(c => c.name === job.company);

                const existsInAllCompanies = Object.values(allCompanies)
                    .flat()
                    .some(c => c.name === job.company);

                if (!existsInDefaults && !existsInAllCompanies) {
                    // Add to "None" category for companies discovered from applications
                    const category = "None"; // or job.priority

                    if (!allCompanies[category]) {
                        allCompanies[category] = [];
                    }

                    // Check if already added from another job
                    if (!allCompanies[category].some(c => c.name === job.company)) {
                        const newCompany = {
                            name: job.company,
                            url: job.url || `https://www.google.com/search?q=${encodeURIComponent(job.company + ' careers')}`,
                        };

                        // Apply customCompanies data if it exists for this company
                        if (customCompanies[job.company]) {
                            Object.assign(newCompany, customCompanies[job.company]);
                        }

                        allCompanies[category].push(newCompany);
                    }
                }
            });

            const addJob = (job) => {
                try {
                    const startTime = performance.now();

                    // Rate limiting
                    SecurityUtil.checkRateLimit();

                    // Validate and sanitize job data
                    const validatedJob = SecurityUtil.validateJobData(job);

                    // Check total jobs limit
                    if (jobs.length >= SecurityUtil.CONFIG.MAX_JOBS_COUNT) {
                        throw new Error(`Maximum jobs limit (${SecurityUtil.CONFIG.MAX_JOBS_COUNT}) reached`);
                    }

                    setJobs(prevJobs => {
                        const updated = [...prevJobs, validatedJob];
                        return updated;
                    });

                    // Clear related caches
                    PerformanceUtil.clearCache('jobIndex', 'sortedJobs', ...Object.keys(PerformanceUtil.cache).filter(k => k.startsWith('filteredJobs_')));

                    const duration = performance.now() - startTime;
                    LoggerUtil.trackPerformance('addJob', duration, true);
                    LoggerUtil.trackAction('job_added', 'job_management', { jobId: validatedJob.id });

                    setShowModal(false);
                    setEditingJob(null);
                } catch (error) {
                    LoggerUtil.error('Error adding job', { error: error.message });
                    SecurityUtil.handleError(error, 'adding job');
                }
            };

            const addCompany = (company) => {
                try {
                    const startTime = performance.now();

                    // Rate limiting
                    SecurityUtil.checkRateLimit();

                    // Validate company data
                    const validatedCompany = SecurityUtil.validateCompanyData(company);

                    // Check total companies limit
                    const currentCount = Object.keys(customCompanies).length;
                    if (currentCount >= SecurityUtil.CONFIG.MAX_COMPANIES_COUNT) {
                        throw new Error(`Maximum companies limit (${SecurityUtil.CONFIG.MAX_COMPANIES_COUNT}) reached`);
                    }

                    setCustomCompanies(prev => ({
                        ...prev,
                        [validatedCompany.name]: validatedCompany
                    }));

                    // Clear related caches
                    PerformanceUtil.clearCache('jobIndex', 'sortedJobs', ...Object.keys(PerformanceUtil.cache).filter(k => k.startsWith('filteredJobs_')));

                    const duration = performance.now() - startTime;
                    LoggerUtil.trackPerformance('addCompany', duration, true);
                    LoggerUtil.trackAction('company_added', 'company_management', { company: validatedCompany.name });

                    setShowCompanyModal(false);
                } catch (error) {
                    LoggerUtil.error('Error adding company', { error: error.message });
                    SecurityUtil.handleError(error, 'adding company');
                }
            };

            // Lightweight confetti without external dependencies (colored paper bits)
            const launchConfetti = () => {
                const container = document.createElement('div');
                container.style.cssText = 'position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:9999';
                document.body.appendChild(container);

                const colors = ['#6b8aff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                const total = 36;

                for (let i = 0; i < total; i++) {
                    const piece = document.createElement('div');
                    const width = 6 + Math.random() * 6;
                    const height = width * (1.4 + Math.random() * 0.6);
                    const startLeft = Math.random() * 100;
                    const rotateStart = Math.random() * 360;

                    piece.style.cssText = `position:absolute;top:-16px;left:${startLeft}%;width:${width}px;height:${height}px;background:${colors[i % colors.length]};opacity:1;border-radius:2px;transform:translate3d(0,0,0) rotate(${rotateStart}deg);`;
                    piece.style.mixBlendMode = 'screen';
                    container.appendChild(piece);

                    const xOffset = (Math.random() - 0.5) * 220;
                    const yOffset = window.innerHeight * 0.98 + Math.random() * 200;
                    const rotateEnd = rotateStart + (Math.random() - 0.5) * 1440;

                    requestAnimationFrame(() => {
                        piece.style.transition = `transform 2.2s ease-out, opacity 2.2s ease-out`;
                        piece.style.transitionDelay = `${Math.random() * 0.16}s`;
                        piece.style.transform = `translate(${xOffset}px, ${yOffset}px) rotate(${rotateEnd}deg)`;
                        piece.style.opacity = '0.4';
                    });
                }

                setTimeout(() => container.remove(), 2600);
            };

            const updateJob = (updatedJob) => {
                try {
                    const startTime = performance.now();

                    // Rate limiting
                    SecurityUtil.checkRateLimit();

                    // Validate updated job data
                    const validatedJob = SecurityUtil.validateJobData(updatedJob);

                    const oldJob = jobs.find(j => j.id === validatedJob.id);
                    const wasApplied = oldJob?.status === JOB_STATUSES.APPLIED;
                    const nowInProgress = validatedJob.status === JOB_STATUSES.IN_PROGRESS;

                    // Check if progression moved forward
                    const progressionOrder = [
                        PROGRESSION_STAGES.APPLICATION,
                        PROGRESSION_STAGES.RECRUITER_SCREEN,
                        PROGRESSION_STAGES.PARTIAL_LOOP,
                        PROGRESSION_STAGES.FULL_LOOP,
                        PROGRESSION_STAGES.OFFER
                    ];
                    const oldProgression = oldJob?.progression || PROGRESSION_STAGES.APPLICATION;
                    const newProgression = validatedJob.progression || PROGRESSION_STAGES.APPLICATION;
                    const progressionMovedForward = progressionOrder.indexOf(newProgression) > progressionOrder.indexOf(oldProgression);

                    setJobs(jobs.map(j => j.id === validatedJob.id ? validatedJob : j));

                    // Clear related caches
                    PerformanceUtil.clearCache('jobIndex', 'sortedJobs', ...Object.keys(PerformanceUtil.cache).filter(k => k.startsWith('filteredJobs_')));

                    const duration = performance.now() - startTime;
                    LoggerUtil.trackPerformance('updateJob', duration, true);
                    LoggerUtil.trackAction('job_updated', 'job_management', { jobId: validatedJob.id });

                    if ((wasApplied && nowInProgress) || progressionMovedForward) {
                        launchConfetti();
                    }

                    setShowModal(false);
                    setEditingJob(null);
                } catch (error) {
                    LoggerUtil.error('Error updating job', { error: error.message });
                    SecurityUtil.handleError(error, 'updating job');
                }
            };

            const deleteJob = (id) => {
                if (confirm("Are you sure you want to delete this job?")) {
                    const startTime = performance.now();

                    setJobs(jobs.filter(j => j.id !== id));

                    // Clear related caches
                    PerformanceUtil.clearCache('jobIndex', 'sortedJobs', ...Object.keys(PerformanceUtil.cache).filter(k => k.startsWith('filteredJobs_')));

                    const duration = performance.now() - startTime;
                    LoggerUtil.trackPerformance('deleteJob', duration, true);
                    LoggerUtil.trackAction('job_deleted', 'job_management', { jobId: id });
                }
            };

            const exportToCSV = () => {
                const headers = ["Company", "Role", "Status", "Priority", "Date applied", "URL", "Salary", "Location", "Contact name", "Notes"];
                const rows = jobs.map(j => [
                    j.company,
                    j.role,
                    j.status,
                    j.priority,
                    new Date(j.dateApplied).toLocaleDateString(),
                    j.url,
                    j.salary || "",
                    j.location || "",
                    j.contact || "",
                    j.notes || ""
                ]);
                const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
                const blob = new Blob([csv], { type: "text/csv" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `job-search-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            const exportBackup = () => {
                try {
                    const backupData = {
                        jobs: jobs,
                        customCompanies: customCompanies,
                        blockedCompanies: blockedCompanies
                    };

                    const backup = {
                        version: APP_CONFIG.VERSION,
                        exportDate: new Date().toISOString(),
                        checksum: SecurityUtil.generateChecksum(backupData),
                        data: backupData
                    };

                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `job-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();

                    // Clean up
                    window.URL.revokeObjectURL(url);

                    // Update last backup time
                    const now = new Date();
                    setLastBackupTime(now);
                    StorageUtil.set(APP_CONFIG.STORAGE_KEYS.LAST_BACKUP, now.toISOString());

                    alert("Backup downloaded successfully!");
                } catch (error) {
                    SecurityUtil.handleError(error, 'exporting backup');
                }
            };

            const importBackup = (fileContent, mode = 'replace') => {
                try {
                    // Validate import data structure and size
                    const backup = SecurityUtil.validateImportData(fileContent);

                    // Verify checksum if present (new format)
                    if (backup.checksum && backup.data) {
                        if (!SecurityUtil.verifyChecksum(backup.data, backup.checksum)) {
                            const proceed = confirm(
                                'Warning: Data integrity check failed. The backup file may be corrupted or tampered with.\\n\\n' +
                                'Do you want to proceed anyway? (Not recommended)'
                            );
                            if (!proceed) {
                                throw new Error('Import cancelled: integrity check failed');
                            }
                        }
                    }

                    // Extract data (handle both old and new format)
                    const importData = backup.data || backup;
                    const jobsToImport = importData.jobs || [];

                    // Validate and sanitize each job
                    const validJobs = [];
                    const validationErrors = [];

                    for (let i = 0; i < jobsToImport.length; i++) {
                        try {
                            const validatedJob = SecurityUtil.validateJobData(jobsToImport[i]);
                            validJobs.push(validatedJob);
                        } catch (err) {
                            validationErrors.push(`Job ${i + 1}: ${err.message}`);
                        }
                    }

                    // Warn if some jobs were invalid
                    if (validationErrors.length > 0) {
                        const proceed = confirm(
                            `Warning: ${validationErrors.length} out of ${jobsToImport.length} jobs failed validation and will be skipped.\\n\\n` +
                            `Continue with ${validJobs.length} valid jobs?`
                        );
                        if (!proceed) {
                            throw new Error('Import cancelled');
                        }
                    }

                    if (mode === 'merge') {
                        // Merge mode: check for duplicates
                        const existingJobKeys = new Set(
                            jobs.map(j => `${j.company.toLowerCase()}-${j.role.toLowerCase()}-${j.dateApplied}`)
                        );

                        const newJobs = validJobs.filter(job => {
                            const key = `${job.company.toLowerCase()}-${job.role.toLowerCase()}-${job.dateApplied}`;
                            return !existingJobKeys.has(key);
                        });

                        // Check total limit after merge
                        if (jobs.length + newJobs.length > SecurityUtil.CONFIG.MAX_JOBS_COUNT) {
                            throw new Error(
                                `Merge would exceed maximum jobs limit (${SecurityUtil.CONFIG.MAX_JOBS_COUNT}). ` +
                                `Current: ${jobs.length}, New: ${newJobs.length}`
                            );
                        }
                        // Compute merged jobs and persist immediately to avoid loss on quick refresh
                        const mergedJobs = [...jobs, ...newJobs];
                        setJobs(mergedJobs);
                        StorageUtil.set(APP_CONFIG.STORAGE_KEYS.JOBS, mergedJobs);
                        // Invalidate performance caches to reflect new data immediately
                        PerformanceUtil.clearCache('jobIndex');
                        PerformanceUtil.clearCacheByPrefix('sortedJobs_', 'filteredJobs_');

                        // Merge and validate custom companies
                        if (importData.customCompanies && typeof importData.customCompanies === 'object') {
                            const mergedCompanies = { ...customCompanies };

                            for (const [name, data] of Object.entries(importData.customCompanies)) {
                                try {
                                    mergedCompanies[name] = SecurityUtil.validateCompanyData({ ...data, name });
                                } catch (err) {
                                    console.warn(`Skipping invalid company ${name}:`, err);
                                }
                            }
                            // Update state and persist immediately
                            setCustomCompanies(mergedCompanies);
                            StorageUtil.set(APP_CONFIG.STORAGE_KEYS.CUSTOM_COMPANIES, mergedCompanies);
                            PerformanceUtil.clearCache('jobIndex');
                            PerformanceUtil.clearCacheByPrefix('sortedJobs_', 'filteredJobs_');
                        }

                        // Merge blocked companies with sanitization
                        if (importData.blockedCompanies && Array.isArray(importData.blockedCompanies)) {
                            const sanitizedBlocked = importData.blockedCompanies
                                .filter(name => typeof name === 'string')
                                .map(name => SecurityUtil.sanitizeInput(name, 200));
                            const mergedBlocked = [...new Set([...blockedCompanies, ...sanitizedBlocked])];
                            setBlockedCompanies(mergedBlocked);
                            try { localStorage.setItem('blockedCompanies', JSON.stringify(mergedBlocked)); } catch { }
                            PerformanceUtil.clearCache('jobIndex');
                            PerformanceUtil.clearCacheByPrefix('sortedJobs_', 'filteredJobs_');
                        }

                        const skipped = validJobs.length - newJobs.length;
                        alert(
                            `Merge complete!\n\n` +
                            `Added: ${newJobs.length} new jobs\n` +
                            `Skipped: ${skipped} duplicates\n` +
                            `Total jobs: ${jobs.length + newJobs.length}`
                        );
                    } else {
                        // Replace mode: validate limits
                        if (validJobs.length > SecurityUtil.CONFIG.MAX_JOBS_COUNT) {
                            throw new Error(
                                `Import exceeds maximum jobs limit: ${validJobs.length} > ${SecurityUtil.CONFIG.MAX_JOBS_COUNT}`
                            );
                        }
                        // Set and persist jobs immediately
                        setJobs(validJobs);
                        StorageUtil.set(APP_CONFIG.STORAGE_KEYS.JOBS, validJobs);
                        PerformanceUtil.clearCache('jobIndex');
                        PerformanceUtil.clearCacheByPrefix('sortedJobs_', 'filteredJobs_');

                        // Validate and import companies
                        if (importData.customCompanies && typeof importData.customCompanies === 'object') {
                            const validCompanies = {};
                            for (const [name, data] of Object.entries(importData.customCompanies)) {
                                try {
                                    validCompanies[name] = SecurityUtil.validateCompanyData({ ...data, name });
                                } catch (err) {
                                    console.warn(`Skipping invalid company ${name}:`, err);
                                }
                            }
                            setCustomCompanies(validCompanies);
                            StorageUtil.set(APP_CONFIG.STORAGE_KEYS.CUSTOM_COMPANIES, validCompanies);
                            PerformanceUtil.clearCache('jobIndex');
                            PerformanceUtil.clearCacheByPrefix('sortedJobs_', 'filteredJobs_');
                        }

                        // Sanitize blocked companies
                        if (importData.blockedCompanies && Array.isArray(importData.blockedCompanies)) {
                            const sanitized = importData.blockedCompanies
                                .filter(name => typeof name === 'string')
                                .map(name => SecurityUtil.sanitizeInput(name, 200));
                            setBlockedCompanies(sanitized);
                            try { localStorage.setItem('blockedCompanies', JSON.stringify(sanitized)); } catch { }
                            PerformanceUtil.clearCache('jobIndex');
                            PerformanceUtil.clearCacheByPrefix('sortedJobs_', 'filteredJobs_');
                        }

                        alert(
                            `Import complete!\n\n` +
                            `Imported ${validJobs.length} jobs successfully!`
                        );
                    }

                    setShowImportModal(false);
                } catch (error) {
                    SecurityUtil.handleError(error, 'importing backup');
                }
            };

            const autoBackup = () => {
                // Auto-backup when there's data and last backup was more than 1 hour ago
                if (jobs.length > 0) {
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                    if (!lastBackupTime || lastBackupTime < oneHourAgo) {
                        console.log("Auto-backup triggered");
                        exportBackup();
                    }
                }
            };

            // Check for auto-backup need when jobs change
            useEffect(() => {
                if (jobs.length > 0) {
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                    if (!lastBackupTime || lastBackupTime < oneHourAgo) {
                        // Show reminder instead of auto-downloading
                        const daysSinceBackup = lastBackupTime
                            ? Math.floor((Date.now() - lastBackupTime.getTime()) / (1000 * 60 * 60 * 24))
                            : null;

                        if (daysSinceBackup === null || daysSinceBackup >= 1) {
                            console.log("Backup reminder: It's been a while since your last backup");
                        }
                    }
                }
            }, [jobs, lastBackupTime]);

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
                // Clear caches so sorting updates immediately
                PerformanceUtil.clearCacheByPrefix('sortedJobs_', 'filteredJobs_');
            };

            const getSortIcon = (columnKey) => {
                if (sortConfig.key !== columnKey) return ' â‡…';
                return sortConfig.direction === 'asc' ? ' â†‘' : ' â†“';
            };

            // Build index for faster lookups
            const jobIndex = PerformanceUtil.memoize('jobIndex', () => {
                const index = {
                    byId: new Map(),
                    byStatus: {},
                    byPriority: {},
                    byCompany: {}
                };

                jobs.forEach(job => {
                    index.byId.set(job.id, job);

                    // Index by status
                    if (!index.byStatus[job.status]) index.byStatus[job.status] = [];
                    index.byStatus[job.status].push(job);

                    // Index by priority
                    if (!index.byPriority[job.priority]) index.byPriority[job.priority] = [];
                    index.byPriority[job.priority].push(job);

                    // Index by company
                    if (!index.byCompany[job.company]) index.byCompany[job.company] = [];
                    index.byCompany[job.company].push(job);
                });

                return index;
            }, 10000);

            const sortedJobs = PerformanceUtil.memoize(`sortedJobs_${sortConfig.key}_${sortConfig.direction}`, () => {
                return PerformanceUtil.measure('sorting', () => {
                    return [...jobs].sort((a, b) => {
                        if (!sortConfig.key) return 0;
                        const aVal = (a[sortConfig.key] || '').toString().toLowerCase();
                        const bVal = (b[sortConfig.key] || '').toString().toLowerCase();
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                });
            }, 1000);

            const filteredJobs = PerformanceUtil.memoize(
                `filteredJobs_${JSON.stringify(filters)}_${sortConfig.key}_${sortConfig.direction}`,
                () => {
                    return PerformanceUtil.measure('filtering', () => {
                        return sortedJobs.filter(job => {
                            if (filters.status !== "all" && job.status !== filters.status) return false;
                            if (filters.priority !== "all" && job.priority !== filters.priority) return false;
                            if (filters.search) {
                                const searchLower = filters.search.toLowerCase();
                                const matchesRole = job.role.toLowerCase().includes(searchLower);
                                const matchesCompany = job.company.toLowerCase().includes(searchLower);
                                if (!matchesRole && !matchesCompany) return false;
                            }
                            return true;
                        });
                    });
                },
                1000
            );

            // Log performance metrics periodically and cleanup memory
            useEffect(() => {
                const interval = setInterval(() => {
                    const report = PerformanceUtil.getReport();
                    if (Object.keys(report.operationStats).length > 0) {
                        LoggerUtil.info('Performance Report', report);
                    }

                    // Cleanup every 5 minutes to prevent memory leaks
                    PerformanceUtil.cleanup();
                    LoggerUtil.info('Memory Cleanup', PerformanceUtil.getMemoryStats());
                }, 60000); // Every 60 seconds

                // Cleanup on unmount
                return () => {
                    clearInterval(interval);
                    PerformanceUtil.cleanup();
                };
            }, []);

            return (
                <div className="app">
                    <Header
                        view={view}
                        setView={setView}
                        onBackup={exportBackup}
                        onImport={() => setShowImportModal(true)}
                        lastBackupTime={lastBackupTime}
                        theme={theme}
                        toggleTheme={toggleTheme}
                    />
                    <main className="main">
                        {view === "dashboard" && <Dashboard jobs={jobs} />}
                        {view === "companies" && <Companies
                            companies={allCompanies}
                            jobs={jobs}
                            customCompanies={customCompanies}
                            blockedCompanies={blockedCompanies}
                            deletedCategories={deletedCategories}
                            onUpdateCompany={(companyName, updates) => {
                                // Handle category management operations
                                if (updates.newCategory) {
                                    // Add new category
                                    setCustomCategories(prev => ({
                                        ...prev,
                                        [updates.newCategory]: []
                                    }));
                                    return;
                                }

                                if (updates.deleteCategory) {
                                    // Delete category - move companies to None
                                    const categoryToDelete = updates.deleteCategory;
                                    const companiesInCategory = allCompanies[categoryToDelete] || [];
                                    
                                    // Add to deleted categories list
                                    setDeletedCategories(prev => {
                                        if (!prev.includes(categoryToDelete)) {
                                            return [...prev, categoryToDelete];
                                        }
                                        return prev;
                                    });
                                    
                                    // Move companies to None if there are any
                                    if (companiesInCategory.length > 0) {
                                        setCustomCategories(prev => {
                                            const updated = { ...prev };
                                            if (!updated['None']) {
                                                updated['None'] = [];
                                            }
                                            // Add companies that were in the deleted category
                                            updated['None'] = [...updated['None'], ...companiesInCategory];
                                            return updated;
                                        });
                                    }
                                    
                                    // If it's a custom category, also remove it from customCategories
                                    setCustomCategories(prev => {
                                        const updated = { ...prev };
                                        delete updated[categoryToDelete];
                                        return updated;
                                    });
                                    return;
                                }

                                if (updates.renameCategory) {
                                    // Rename category
                                    const { oldName, newName } = updates.renameCategory;
                                    const companiesInCategory = allCompanies[oldName] || [];
                                    
                                    setCustomCategories(prev => {
                                        const updated = { ...prev };
                                        updated[newName] = companiesInCategory;
                                        delete updated[oldName];
                                        return updated;
                                    });
                                    return;
                                }

                                // Standard company update
                                let categoryFound = null;
                                let companyFound = null;

                                // Search through all categories to find the company
                                Object.entries(allCompanies).forEach(([category, companiesList]) => {
                                    const company = companiesList.find(c => c.name === companyName);
                                    if (company) {
                                        categoryFound = category;
                                        companyFound = company;
                                    }
                                });

                                // If not found in allCompanies and there's a custom entry, use that
                                if (!companyFound && customCompanies[companyName]) {
                                    companyFound = customCompanies[companyName];
                                    categoryFound = customCompanies[companyName].category || 'None';
                                }

                                if (companyFound) {
                                    // Update customCompanies with the new data
                                    // Structure: customCompanies[companyName] = { ...updates }
                                    setCustomCompanies(prev => ({
                                        ...prev,
                                        [companyName]: {
                                            ...(prev[companyName] || {}),
                                            ...updates,
                                            name: companyName, // preserve name
                                            url: companyFound.url || updates.url, // preserve url if not updating
                                        }
                                    }));
                                }
                            }}
                            onDeleteCompany={(companyName) => {
                                setBlockedCompanies([...blockedCompanies, companyName]);
                            }}
                            onUnhideCompany={(companyName) => {
                                setBlockedCompanies(blockedCompanies.filter(name => name !== companyName));
                            }}
                            onAddJob={(company) => {
                                setEditingJob({ company: company.name, url: company.url });
                                setShowModal(true);
                            }}
                            onAddCompany={() => setShowCompanyModal(true)}
                            onViewCompanyJobs={(companyName) => {
                                setView('jobs');
                                setFilters({ ...filters, search: companyName });
                            }}
                        />}
                        {view === "jobs" && <JobsTable
                            jobs={filteredJobs}
                            filters={filters}
                            setFilters={setFilters}
                            onAdd={() => {
                                setEditingJob(null);
                                setShowModal(true);
                            }}
                            onEdit={(job) => {
                                setEditingJob(job);
                                setShowModal(true);
                            }}
                            onUpdateJob={updateJob}
                            onDelete={deleteJob}
                            onExport={exportToCSV}
                            onBackup={exportBackup}
                            requestSort={requestSort}
                            getSortIcon={getSortIcon}
                        />}
                        {view === "stats" && <Stats jobs={jobs} />}
                    </main>
                    {showModal && (
                        <JobModal
                            job={editingJob}
                            onSave={editingJob?.id ? updateJob : addJob}
                            onClose={() => { setShowModal(false); setEditingJob(null); }}
                        />
                    )}
                    {showCompanyModal && (
                        <CompanyModal
                            onSave={addCompany}
                            onClose={() => setShowCompanyModal(false)}
                            existingCategories={Object.keys(allCompanies)}
                        />
                    )}
                    {showImportModal && (
                        <ImportModal
                            onImport={importBackup}
                            onClose={() => setShowImportModal(false)}
                        />
                    )}

                    <footer className="footer">
                        <div className="footer-content">
                            <div className="footer-text">
                                Built by a job seeker, for job seekers, shared freely.
                            </div>
                            <div className="footer-links">
                                <a
                                    href="https://paypal.me/jillshaheen"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="footer-link"
                                >
                                    <svg
                                        className="footer-icon"
                                        viewBox="0 0 24 24"
                                        fill="currentColor"
                                    >
                                        <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.254-.93 4.778-4.005 7.201-9.138 7.201h-2.19a.563.563 0 0 0-.556.479l-1.187 7.527h-.506l-.24 1.516a.56.56 0 0 0 .554.647h3.882c.46 0 .85-.334.922-.788.06-.26.76-4.852.76-4.852a.932.932 0 0 1 .924-.788h.58c3.76 0 6.705-1.528 7.565-5.946.36-1.847.174-3.388-.777-4.471z" />
                                    </svg>
                                    Thank me
                                </a>
                                <a
                                    href="https://github.com/jburgh/job-search-dashboard/deployments"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="footer-link"
                                >
                                    <svg
                                        className="footer-icon"
                                        viewBox="0 0 16 16"
                                        fill="currentColor"
                                    >
                                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
                                    </svg>
                                    Change log
                                </a>
                            </div>
                        </div>
                    </footer>

                </div>
            );
        }

        // Header Component
        function Header({ view, setView, onBackup, onImport, lastBackupTime, theme, toggleTheme }) {
            const [showPerf, setShowPerf] = React.useState(false);

            const daysSinceBackup = lastBackupTime
                ? Math.floor((Date.now() - lastBackupTime.getTime()) / (1000 * 60 * 60 * 24))
                : null;

            const backupWarning = daysSinceBackup === null || daysSinceBackup >= 1;

            return (
                <>
                    <header className="header">
                        <div className="header-content">
                            <div className="logo">
                                <div className="theme-toggle">ðŸŽ¯</div>
                                <span>Job Search Dashboard</span>
                            </div>
                            <div className="header-controls">
                                <nav className="nav">
                                    <button className={`nav-btn ${view === "dashboard" ? "active" : ""}`} onClick={() => setView("dashboard")}>Dashboard</button>
                                    <button className={`nav-btn ${view === "companies" ? "active" : ""}`} onClick={() => setView("companies")}>Companies</button>
                                    <button className={`nav-btn ${view === "jobs" ? "active" : ""}`} onClick={() => setView("jobs")}>Applications</button>
                                    <button
                                        className="nav-btn"
                                        onClick={onBackup}
                                        style={{
                                            borderColor: backupWarning ? "var(--warning)" : undefined,
                                            background: backupWarning ? (theme === 'dark' ? '#7c2d12' : '#faa29d') : undefined,
                                            color: backupWarning ? (theme === 'dark' ? '#fed7aa' : 'var(--text-primary)') : undefined
                                        }}
                                        title={lastBackupTime ? `Last backup: ${lastBackupTime.toLocaleDateString()}` : "No backup yet"}
                                    >
                                        ðŸ’¾ Back up {backupWarning && "âš ï¸"}
                                    </button>
                                    <button className="nav-btn" onClick={onImport}>ðŸ“¥ Import</button>
                                </nav>

                                <button
                                    className="theme-toggle"
                                    onClick={() => window.open('https://github.com/jburgh/job-search-dashboard', '_blank')}
                                    title="View on GitHub"
                                    style={{ fontSize: '1.2rem' }}
                                >
                                    <svg
                                        width="22"
                                        height="22"
                                        viewBox="0 0 16 16"
                                        fill="currentColor"
                                    >
                                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
                                    </svg>
                                </button>
                                
                                <button
                                    className="theme-toggle"
                                    onClick={() => setShowPerf(!showPerf)}
                                    title="Toggle performance metrics"
                                    style={{ fontSize: '1.2rem' }}
                                >
                                    âš¡
                                </button>
                                
                                <button
                                    className="theme-toggle"
                                    onClick={toggleTheme}
                                    title={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}
                                >
                                    {theme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸'}
                                </button>
                            </div>
                        </div>
                    </header>
                    {showPerf && (
                        <div style={{
                            background: 'var(--bg-tertiary)',
                            border: '1px solid var(--border-primary)',
                            padding: '1rem',
                            margin: '1rem auto 1rem auto',
                            marginLeft: 'auto',
                            marginRight: 'auto',
                            maxWidth: '1336px',
                            width: '100%',
                            borderRadius: '6px',
                            fontSize: '0.85rem',
                            fontFamily: 'monospace',
                            maxHeight: '300px',
                            overflow: 'auto',
                            boxSizing: 'border-box'
                        }}>
                            <PerformanceMonitor />
                        </div>
                    )}
                </>
            );
        }

        // Performance Monitor Component
        function PerformanceMonitor() {
            const [stats, setStats] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);

            React.useEffect(() => {
                // Fetch initial stats immediately
                setStats(PerformanceUtil.getReport());
                setIsLoading(false);

                const interval = setInterval(() => {
                    setStats(PerformanceUtil.getReport());
                }, 2000);

                return () => clearInterval(interval);
            }, []);

            if (isLoading) {
                return (
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', color: 'var(--text-secondary)' }}>
                        <span style={{ fontSize: '1.2rem', animation: 'spin 1s linear infinite', display: 'inline-block' }}>âš™ï¸</span>
                        <span>Loading performance metrics...</span>
                    </div>
                );
            }

            if (!stats) return null;

            return (
                <div>
                    <div style={{ marginBottom: '0.5rem', fontWeight: 'bold' }}>ðŸ“Š Performance metrics</div>
                    <div style={{ color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>
                        Cache Hit Rate: {stats.cacheStats.hitRate} (Hits: {stats.cacheStats.hits} | Misses: {stats.cacheStats.misses})
                    </div>
                    {Object.entries(stats.operationStats).slice(0, 5).map(([op, data]) => (
                        <div key={op} style={{ marginBottom: '0.3rem', color: 'var(--text-secondary)' }}>
                            {op}: {data.avg} avg | min: {data.min} | max: {data.max} | calls: {data.count}
                        </div>
                    ))}
                </div>
            );
        }

        // Dashboard Component
        const Dashboard = ({ jobs }) => {
            return <AnalyticsDashboard jobs={jobs} />;
        };

        // Companies Component
        function Companies({ companies, jobs, customCompanies, blockedCompanies, deletedCategories, onUpdateCompany, onDeleteCompany, onAddJob, onAddCompany, onViewCompanyJobs, onUnhideCompany }) {
            const [searchTerm, setSearchTerm] = useState("");
            const [sortConfig, setSortConfig] = useState({ key: 'company', direction: 'asc' });
            const [editingCompany, setEditingCompany] = useState(null);
            const [editUrl, setEditUrl] = useState('');
            const [editCompanyName, setEditCompanyName] = useState('');
            const [editCategory, setEditCategory] = useState('');
            const [editNewCategory, setEditNewCategory] = useState('');
            const [showHidden, setShowHidden] = useState(false);
            const [selectedCategories, setSelectedCategories] = useState([]);
            const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
            const [appliedFilter, setAppliedFilter] = useState('all'); // 'all', 'applied', 'not-applied'
            const [showAppliedDropdown, setShowAppliedDropdown] = useState(false);
            const [selectedFitLevels, setSelectedFitLevels] = useState([]);
            const [showFitLevelDropdown, setShowFitLevelDropdown] = useState(false);
            const [showCategoryManager, setShowCategoryManager] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [editingCategoryName, setEditingCategoryName] = useState(null);
            const [editingCategoryNewName, setEditingCategoryNewName] = useState('');


            if (!companies || typeof companies !== 'object') {
                console.error("Invalid companies prop:", companies);
                return <div className="empty-state"><h3>Error loading companies</h3></div>;
            }

            // Get all unique categories from companies object
            const allCategories = Object.keys(companies).sort();

            // Get all companies from all categories
            const allCompaniesList = Object.values(companies)
                .flat()
                .filter((company, index, self) =>
                    index === self.findIndex(c => c.name === company.name)
                )
                .filter(company => showHidden || !blockedCompanies.includes(company.name));

            // Filter by search term and selected categories
            const filteredCompaniesList = allCompaniesList.filter(company => {
                const matchesSearch = company && company.name && company.name.toLowerCase().includes(searchTerm.toLowerCase());

                // If no filters selected, show all companies
                if (selectedCategories.length === 0 && appliedFilter === 'all' && selectedFitLevels.length === 0) return matchesSearch;

                // Find which category this company belongs to
                const companyCategory = Object.entries(companies).find(([_, companiesList]) =>
                    companiesList.some(c => c.name === company.name)
                )?.[0];

                // Apply category filter
                if (selectedCategories.length > 0 && !(companyCategory && selectedCategories.includes(companyCategory))) {
                    return false;
                }

                // Apply "Applied" filter
                if (appliedFilter !== 'all') {
                    const applicationCount = jobs.filter(j => j.company === company.name).length;
                    if (appliedFilter === 'applied' && applicationCount === 0) return false;
                    if (appliedFilter === 'not-applied' && applicationCount > 0) return false;
                }

                // Apply fit level filter
                if (selectedFitLevels.length > 0) {
                    const companyFitLabel = getFitLevelLabel(company.fitLevel || null);
                    if (!selectedFitLevels.includes(companyFitLabel)) return false;
                }

                return matchesSearch;
            });

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }

                // Special case: fitLevel should start with descending order
                if (key === 'fitLevel' && sortConfig.key !== 'fitLevel') {
                    direction = 'desc';
                }

                setSortConfig({ key, direction });
            };

            const getSortIcon = (columnKey) => {
                if (sortConfig.key !== columnKey) return ' â‡…';
                return sortConfig.direction === 'asc' ? ' â†‘' : ' â†“';
            };

            const handleFitLevelChange = (companyName, newValue) => {
                onUpdateCompany(companyName, { fitLevel: newValue });
            };

            const handleAddCategory = () => {
                if (!newCategoryName.trim()) return;
                if (deletedCategories.includes(newCategoryName)) {
                    alert("You can't recreate a category with the same name as one you've deleted. Choose a different category name.");
                    return;
                }
                if (allCategories.includes(newCategoryName)) {
                    alert('Category already exists');
                    return;
                }
                // Create new category with empty array
                onUpdateCompany(null, { newCategory: newCategoryName });
                setNewCategoryName('');
            };

            const handleDeleteCategory = (categoryName) => {
                if (categoryName === 'None') {
                    alert("You can't delete the \"None\" category.");
                    return;
                }
                if (!confirm(`Delete category "${categoryName}"? Companies in this category will be moved to "None".`)) return;
                // Call a function to handle category deletion
                onUpdateCompany(null, { deleteCategory: categoryName });
            };

            const handleRenameCategory = (oldName, newName) => {
                if (!newName.trim()) return;
                if (allCategories.includes(newName) && newName !== oldName) {
                    alert('Category name already exists');
                    return;
                }
                onUpdateCompany(null, { renameCategory: { oldName, newName } });
                setEditingCategoryName(null);
                setEditingCategoryNewName('');
            };

            // Sort the filtered list
            const sortedCompaniesList = [...filteredCompaniesList].sort((a, b) => {
                if (!sortConfig.key) return 0;

                let aVal, bVal;
                if (sortConfig.key === 'applications') {
                    aVal = jobs.filter(j => j.company === a.name).length;
                    bVal = jobs.filter(j => j.company === b.name).length;
                } else if (sortConfig.key === 'company') {
                    aVal = a.name.toLowerCase();
                    bVal = b.name.toLowerCase();
                } else if (sortConfig.key === 'fitLevel') {
                    return sortByFitLevel(a.fitLevel || null, b.fitLevel || null, sortConfig.direction);
                }

                if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Close dropdowns when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (showCategoryDropdown && !event.target.closest('.filter-select') && !event.target.closest('[data-dropdown="category"]')) {
                        setShowCategoryDropdown(false);
                    }
                    if (showAppliedDropdown && !event.target.closest('.filter-select') && !event.target.closest('[data-dropdown="applied"]')) {
                        setShowAppliedDropdown(false);
                    }
                    if (showFitLevelDropdown && !event.target.closest('.filter-select') && !event.target.closest('[data-dropdown="fitlevel"]')) {
                        setShowFitLevelDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showCategoryDropdown, showAppliedDropdown, showFitLevelDropdown]);

            return (
                <div>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: "1.5rem", flexWrap: "wrap", gap: "1rem" }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <h1 style={{ color: "#6b8aff" }}>Target companies</h1>
                            <span style={{ color: "#9ca3af", fontSize: "0.9rem", marginLeft: "0.5rem" }}>
                                {filteredCompaniesList.length} {filteredCompaniesList.length === 1 ? 'company' : 'companies'}
                            </span>
                        </div>

                        <div style={{ display: "flex", gap: "0.5rem", alignItems: "center" }}>
                            <label style={{ display: "flex", alignItems: "center", gap: "0.5rem", color: "#9ca3af", cursor: "pointer" }}>
                                <input
                                    type="checkbox"
                                    checked={showHidden}
                                    onChange={(e) => setShowHidden(e.target.checked)}
                                    style={{ cursor: "pointer" }}
                                />
                                Show hidden ({blockedCompanies.length})
                            </label>
                            <button className="btn" onClick={onAddCompany}>Add company</button>
                        </div>
                    </div>

                    <div className="action-bar" style={{ marginBottom: "2rem" }}>
                        <div className="filters" style={{ flex: 1 }}>
                            <div className="search-container">
                                <input
                                    type="text"
                                    className="search-input"
                                    placeholder="Search companies..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                                {searchTerm && (
                                    <button
                                        className="clear-search"
                                        onClick={() => setSearchTerm("")}
                                    >
                                        Ã—
                                    </button>
                                )}
                            </div>

                            {/* Category Multiselect Filter - matching status/priority styling */}
                            <div style={{ position: "relative" }}>
                                <button
                                    className="filter-select"
                                    onClick={() => setShowCategoryDropdown(!showCategoryDropdown)}
                                    style={{
                                        display: "flex",
                                        alignItems: "center",
                                        justifyContent: "space-between",
                                        gap: "0.5rem",
                                        minWidth: "160px",
                                        cursor: "pointer"
                                    }}
                                >
                                    <span>
                                        {selectedCategories.length === 0
                                            ? 'All categories'
                                            : `Categories (${selectedCategories.length})`}
                                    </span>
                                    <span style={{ fontSize: "0.7rem" }}>â–¼</span>
                                </button>
                                {showCategoryDropdown && (
                                    <div data-dropdown="category" style={{
                                        position: "absolute",
                                        top: "calc(100% + 4px)",
                                        left: 0,
                                        background: "var(--bg-elevated)",
                                        border: "1px solid var(--border-primary)",
                                        borderRadius: "10px",
                                        padding: "0.5rem",
                                        boxShadow: "var(--shadow-lg)",
                                        zIndex: 1000,
                                        minWidth: "200px",
                                        maxHeight: "300px",
                                        overflowY: "auto"
                                    }}>
                                        <button
                                            onClick={() => setSelectedCategories([])}
                                            style={{
                                                width: "100%",
                                                padding: "0.5rem",
                                                marginBottom: "0.5rem",
                                                background: "var(--bg-hover)",
                                                border: "1px solid var(--border-primary)",
                                                borderRadius: "6px",
                                                cursor: "pointer",
                                                fontSize: "0.85rem",
                                                color: "var(--text-secondary)",
                                                fontWeight: "500",
                                                transition: "all 0.2s"
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.background = "var(--accent-primary)";
                                                e.currentTarget.style.color = "white";
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.background = "var(--bg-hover)";
                                                e.currentTarget.style.color = "var(--text-secondary)";
                                            }}
                                        >
                                            Clear all
                                        </button>
                                        {allCategories.map(category => (
                                            <label
                                                key={category}
                                                style={{
                                                    display: "flex",
                                                    alignItems: "center",
                                                    gap: "0.5rem",
                                                    padding: "0.5rem",
                                                    cursor: "pointer",
                                                    borderRadius: "6px",
                                                    transition: "background 0.2s",
                                                    fontSize: "0.9rem",
                                                    color: "var(--text-primary)"
                                                }}
                                                onMouseEnter={(e) => e.currentTarget.style.background = "var(--bg-hover)"}
                                                onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={selectedCategories.includes(category)}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setSelectedCategories([...selectedCategories, category]);
                                                        } else {
                                                            setSelectedCategories(selectedCategories.filter(c => c !== category));
                                                        }
                                                    }}
                                                    style={{
                                                        width: "16px",
                                                        height: "16px",
                                                        cursor: "pointer",
                                                        accentColor: "var(--accent-primary)"
                                                    }}
                                                />
                                                <span>{category}</span>
                                            </label>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Fit Level Filter */}
                            <div style={{ position: "relative" }}>
                                <button
                                    className="filter-select"
                                    onClick={() => setShowFitLevelDropdown(!showFitLevelDropdown)}
                                    style={{
                                        display: "flex",
                                        alignItems: "center",
                                        justifyContent: "space-between",
                                        gap: "0.5rem",
                                        minWidth: "150px",
                                        cursor: "pointer"
                                    }}
                                >
                                    <span>
                                        {selectedFitLevels.length === 0
                                            ? 'All fit levels'
                                            : `Fit level (${selectedFitLevels.length})`}
                                    </span>
                                    <span style={{ fontSize: "0.7rem" }}>â–¼</span>
                                </button>
                                {showFitLevelDropdown && (
                                    <div data-dropdown="fitlevel" style={{
                                        position: "absolute",
                                        top: "calc(100% + 4px)",
                                        left: 0,
                                        background: "var(--bg-elevated)",
                                        border: "1px solid var(--border-primary)",
                                        borderRadius: "10px",
                                        padding: "0.5rem",
                                        boxShadow: "var(--shadow-lg)",
                                        zIndex: 1000,
                                        minWidth: "200px"
                                    }}>
                                        <button
                                            onClick={() => setSelectedFitLevels([])}
                                            style={{
                                                width: "100%",
                                                padding: "0.5rem",
                                                marginBottom: "0.5rem",
                                                background: "var(--bg-hover)",
                                                border: "1px solid var(--border-primary)",
                                                borderRadius: "6px",
                                                cursor: "pointer",
                                                fontSize: "0.85rem",
                                                color: "var(--text-secondary)",
                                                fontWeight: "500",
                                                transition: "all 0.2s"
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.background = "var(--accent-primary)";
                                                e.currentTarget.style.color = "white";
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.background = "var(--bg-hover)";
                                                e.currentTarget.style.color = "var(--text-secondary)";
                                            }}
                                        >
                                            Clear all
                                        </button>
                                        {['Strong', 'Decent', 'Long shot', 'â€”'].map(level => (
                                            <label
                                                key={level}
                                                style={{
                                                    display: "flex",
                                                    alignItems: "center",
                                                    gap: "0.5rem",
                                                    padding: "0.5rem",
                                                    cursor: "pointer",
                                                    borderRadius: "6px",
                                                    transition: "background 0.2s",
                                                    fontSize: "0.9rem",
                                                    color: "var(--text-primary)"
                                                }}
                                                onMouseEnter={(e) => e.currentTarget.style.background = "var(--bg-hover)"}
                                                onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={selectedFitLevels.includes(level)}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setSelectedFitLevels([...selectedFitLevels, level]);
                                                        } else {
                                                            setSelectedFitLevels(selectedFitLevels.filter(l => l !== level));
                                                        }
                                                    }}
                                                    style={{
                                                        width: "16px",
                                                        height: "16px",
                                                        cursor: "pointer",
                                                        accentColor: "var(--accent-primary)"
                                                    }}
                                                />
                                                <span>{level}</span>
                                            </label>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Applied Filter */}
                            {/* Applied Filter Dropdown */}
                            <div style={{ position: "relative" }}>
                                <button
                                    className="filter-select"
                                    onClick={() => setShowAppliedDropdown(!showAppliedDropdown)}
                                    style={{
                                        display: "flex",
                                        alignItems: "center",
                                        justifyContent: "space-between",
                                        gap: "0.5rem",
                                        minWidth: "150px",
                                        cursor: "pointer"
                                    }}
                                >
                                    <span>
                                        {appliedFilter === 'all' ? 'Applied or not' : (appliedFilter === 'applied' ? 'Applied' : 'Not applied')}
                                    </span>
                                    <span style={{ fontSize: "0.7rem" }}>â–¼</span>
                                </button>
                                {showAppliedDropdown && (
                                    <div data-dropdown="applied" style={{
                                        position: "absolute",
                                        top: "calc(100% + 4px)",
                                        left: 0,
                                        background: "var(--bg-elevated)",
                                        border: "1px solid var(--border-primary)",
                                        borderRadius: "10px",
                                        padding: "0.5rem",
                                        boxShadow: "var(--shadow-lg)",
                                        zIndex: 1000,
                                        minWidth: "160px"
                                    }}>
                                        {['All companies', 'Applied', 'Not applied'].map(option => {
                                            const value = option === 'All companies' ? 'all' : (option === 'Applied' ? 'applied' : 'not-applied');
                                            return (
                                                <label
                                                    key={option}
                                                    style={{
                                                        display: "flex",
                                                        alignItems: "center",
                                                        gap: "0.5rem",
                                                        padding: "0.5rem",
                                                        cursor: "pointer",
                                                        borderRadius: "6px",
                                                        transition: "background 0.2s",
                                                        fontSize: "0.9rem",
                                                        color: "var(--text-primary)",
                                                        background: appliedFilter === value ? "var(--bg-hover)" : "transparent"
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.background = "var(--bg-hover)"}
                                                    onMouseLeave={(e) => e.currentTarget.style.background = appliedFilter === value ? "var(--bg-hover)" : "transparent"}
                                                >
                                                    <input
                                                        type="radio"
                                                        name="applied-filter"
                                                        checked={appliedFilter === value}
                                                        onChange={() => {
                                                            setAppliedFilter(value);
                                                            setShowAppliedDropdown(false);
                                                        }}
                                                        style={{
                                                            width: "16px",
                                                            height: "16px",
                                                            cursor: "pointer",
                                                            accentColor: "var(--accent-primary)"
                                                        }}
                                                    />
                                                    <span>{option}</span>
                                                </label>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* Clear All Filters */}
                            {(searchTerm || selectedCategories.length > 0 || selectedFitLevels.length > 0 || appliedFilter !== 'all') && (
                                <button
                                    onClick={() => {
                                        setSearchTerm('');
                                        setSelectedCategories([]);
                                        setSelectedFitLevels([]);
                                        setAppliedFilter('all');
                                    }}
                                    style={{
                                        background: "transparent",
                                        color: "var(--accent-primary)",
                                        border: "none",
                                        padding: "0.6rem 0.75rem",
                                        borderRadius: "10px",
                                        cursor: "pointer",
                                        fontSize: "0.85rem",
                                        fontWeight: "500",
                                        transition: "all 0.2s ease",
                                        whiteSpace: "nowrap"
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.textDecoration = "underline"}
                                    onMouseLeave={(e) => e.currentTarget.style.textDecoration = "none"}
                                >
                                    Clear all
                                </button>
                            )}

                        </div>

                    </div>

                    {filteredCompaniesList.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">ðŸ”</div>
                            <h3>No companies found</h3>
                            <p>Try adjusting your search</p>
                        </div>
                    ) : (
                        <div className="table-container">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th onClick={() => requestSort('company')} style={{ cursor: 'pointer' }}>
                                            Company{getSortIcon('company')}
                                        </th>
                                        <th style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            Category
                                            <button
                                                onClick={() => setShowCategoryManager(true)}
                                                title="Manage categories"
                                                aria-label="Manage categories"
                                                style={{
                                                    background: 'none',
                                                    border: 'none',
                                                    color: 'var(--text-secondary)',
                                                    cursor: 'pointer',
                                                    fontSize: '1rem',
                                                    padding: '0',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    transition: 'color 0.2s'
                                                }}
                                                onMouseEnter={(e) => e.currentTarget.style.color = 'var(--accent-primary)'}
                                                onMouseLeave={(e) => e.currentTarget.style.color = 'var(--text-secondary)'}
                                            >
                                                âš™ï¸
                                            </button>
                                        </th>
                                        <th onClick={() => requestSort('fitLevel')} style={{ cursor: 'pointer' }} title="Fit level reflects how well this company tends to match your goals based on role availability, location, hiring patterns, or past experience. It's subjective and can change over time.">
                                            Fit level{getSortIcon('fitLevel')}
                                        </th>
                                        <th onClick={() => requestSort('applications')} style={{ cursor: 'pointer' }}>
                                            Applications{getSortIcon('applications')}
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedCompaniesList.map(company => {
                                        const isHidden = blockedCompanies.includes(company.name);

                                        // Find which category this company belongs to
                                        const companyCategory = Object.entries(companies).find(([_, companiesList]) =>
                                            companiesList.some(c => c.name === company.name)
                                        )?.[0] || 'None';

                                        // Get CSS class name for category
                                        const getCategoryClassName = (category) => {
                                            const classMap = {
                                                'Developer Tools': 'category-developer-tools',
                                                'Data Infrastructure': 'category-data-infrastructure',
                                                'Cloud/Infrastructure': 'category-cloud-infrastructure',
                                                'Enterprise Software': 'category-enterprise-software',
                                                'Consumer Tech': 'category-consumer-tech',
                                                'None': 'category-none'
                                            };

                                            // If it's a predefined category, use its specific class
                                            if (classMap[category]) {
                                                return `category-pill ${classMap[category]}`;
                                            }

                                            // For custom categories, hash the name to pick a color consistently
                                            let hash = 0;
                                            for (let i = 0; i < category.length; i++) {
                                                hash = ((hash << 5) - hash) + category.charCodeAt(i);
                                                hash = hash & hash; // Convert to 32-bit integer
                                            }
                                            const colorIndex = Math.abs(hash) % 12; // 12 custom color variations
                                            return `category-pill category-custom-${colorIndex}`;
                                        };

                                        return (
                                            <tr key={company.name} style={isHidden ? { opacity: 0.6, background: 'var(--bg-tertiary)' } : {}}>
                                                <td>
                                                    <a href={company.url} target="_blank" rel="noopener noreferrer" className="link">
                                                        {company.name}&nbsp;<span style={{ fontSize: '0.85em', marginLeft: '0.25rem' }}>â†—</span>
                                                    </a>
                                                </td>
                                                <td>
                                                    <span className={getCategoryClassName(companyCategory)}>
                                                        {companyCategory}
                                                    </span>
                                                </td>
                                                <td>
                                                    <select
                                                        value={getFitLevelLabel(company.fitLevel || null)}
                                                        onChange={(e) => handleFitLevelChange(company.name, getFitLevelValue(e.target.value))}
                                                        style={{
                                                            background: 'var(--bg-tertiary)',
                                                            color: 'var(--text-primary)',
                                                            border: '1px solid var(--border-primary)',
                                                            padding: '0.375rem 0.5rem',
                                                            borderRadius: '6px',
                                                            fontSize: '0.875rem',
                                                            cursor: 'pointer',
                                                            fontWeight: company.fitLevel === 3 ? '600' : company.fitLevel === 1 ? '400' : '500',
                                                            opacity: company.fitLevel === 1 ? 0.7 : 1
                                                        }}
                                                        aria-label={`Fit level: ${getFitLevelLabel(company.fitLevel || null)}`}
                                                    >
                                                        <option value="â€”">â€”</option>
                                                        <option value="Strong">Strong</option>
                                                        <option value="Decent">Decent</option>
                                                        <option value="Long Shot">Long shot</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    {jobs.filter(j => j.company === company.name).length > 0 ? (
                                                        <button
                                                            onClick={() => onViewCompanyJobs(company.name)}
                                                            style={{
                                                                background: 'none',
                                                                border: 'none',
                                                                color: '#6b8aff',
                                                                cursor: 'pointer',
                                                                textDecoration: 'underline',
                                                                fontSize: 'inherit',
                                                                padding: 0
                                                            }}
                                                        >
                                                            {jobs.filter(j => j.company === company.name).length}
                                                        </button>
                                                    ) : (
                                                        <span style={{ color: '#6b7280' }}>0</span>
                                                    )}
                                                </td>
                                                <td>
                                                    {isHidden ? (
                                                        <button
                                                            className="btn btn-sm"
                                                            onClick={() => onUnhideCompany(company.name)}
                                                            style={{ marginRight: '0.5rem' }}
                                                        >
                                                            Unhide
                                                        </button>
                                                    ) : (
                                                        <>
                                                            <button className="btn btn-sm" onClick={() => onAddJob(company)} style={{ marginRight: '0.5rem' }}>
                                                                Add application
                                                            </button>
                                                            <button
                                                                className="btn btn-sm btn-secondary"
                                                                onClick={() => {
                                                                    if (confirm(`Hide ${company.name} from this list?`)) {
                                                                        onDeleteCompany(company.name);
                                                                    }
                                                                }}
                                                                style={{ marginRight: '0.5rem' }}
                                                            >
                                                                Hide
                                                            </button>
                                                        </>
                                                    )}
                                                    <button className="btn btn-sm btn-secondary" onClick={() => {
                                                        setEditingCompany(company);
                                                        setEditUrl(company.url);
                                                        setEditCompanyName(company.name);
                                                        setEditCategory(companyCategory);
                                                        setEditNewCategory('');
                                                    }}>
                                                        Edit
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                    {editingCompany && (
                        <div className="modal-overlay" onClick={() => setEditingCompany(null)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>Edit company</h2>
                                </div>
                                <div className="modal-body">
                                    <div className="form-group">
                                        <label>Company name</label>
                                        <input
                                            type="text"
                                            value={editCompanyName}
                                            onChange={(e) => setEditCompanyName(e.target.value)}
                                            placeholder="Company name"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>URL</label>
                                        <input
                                            type="url"
                                            value={editUrl}
                                            onChange={(e) => setEditUrl(e.target.value)}
                                            placeholder="https://company.com/careers"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Category</label>
                                        <select
                                            value={editCategory}
                                            onChange={(e) => {
                                                setEditCategory(e.target.value);
                                                setEditNewCategory("");
                                            }}
                                        >
                                            {allCategories.map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                            <option value="">Create new category</option>
                                        </select>
                                    </div>
                                    {editCategory === "" && (
                                        <div className="form-group">
                                            <label>New category name</label>
                                            <input
                                                type="text"
                                                value={editNewCategory}
                                                onChange={(e) => setEditNewCategory(e.target.value)}
                                                placeholder="e.g., SaaS Platforms"
                                            />
                                        </div>
                                    )}
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-secondary" onClick={() => setEditingCompany(null)}>
                                        Cancel
                                    </button>
                                    <button className="btn" onClick={() => {
                                        onUpdateCompany(editingCompany.name, {
                                            name: editCompanyName,
                                            url: editUrl,
                                            category: editCategory === "" ? editNewCategory : editCategory
                                        });
                                        setEditingCompany(null);
                                    }}>
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Category Manager Modal */}
                    {showCategoryManager && (
                        <div className="modal-overlay" onClick={() => setShowCategoryManager(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>Manage categories</h2>
                                    <button className="modal-close" onClick={() => setShowCategoryManager(false)}>Ã—</button>
                                </div>
                                <div className="modal-body" style={{ maxHeight: "60vh", overflowY: "auto" }}>
                                    {/* Add new category */}
                                    <div style={{ marginBottom: "2rem", padding: "1rem", background: "var(--bg-elevated)", borderRadius: "10px" }}>
                                        <h3 style={{ marginBottom: "1rem", fontSize: "0.95rem", fontWeight: "600" }}>Add new category</h3>
                                        <div style={{ display: "flex", gap: "0.5rem" }}>
                                            <input
                                                type="text"
                                                placeholder="Category name"
                                                value={newCategoryName}
                                                onChange={(e) => setNewCategoryName(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && handleAddCategory()}
                                                style={{
                                                    flex: 1,
                                                    padding: "0.5rem",
                                                    background: "var(--bg-primary)",
                                                    border: "1px solid var(--border-primary)",
                                                    borderRadius: "6px",
                                                    color: "var(--text-primary)",
                                                    fontSize: "0.9rem"
                                                }}
                                                autoFocus
                                            />
                                            <button 
                                                onClick={handleAddCategory}
                                                className="btn"
                                                style={{ whiteSpace: "nowrap" }}
                                            >
                                                Add
                                            </button>
                                        </div>
                                    </div>

                                    {/* Existing categories */}
                                    <div>
                                        <h3 style={{ marginBottom: "1rem", fontSize: "0.95rem", fontWeight: "600" }}>Categories ({allCategories.length})</h3>
                                        {allCategories.length === 0 ? (
                                            <p style={{ color: "var(--text-secondary)", fontSize: "0.9rem" }}>No categories yet</p>
                                        ) : (
                                            <div style={{ display: "flex", flexDirection: "column", gap: "0.75rem" }}>
                                                {allCategories.map(category => {
                                                    const companyCount = companies[category]?.length || 0;
                                                    const isEditing = editingCategoryName === category;

                                                    return (
                                                        <div
                                                            key={category}
                                                            style={{
                                                                display: "flex",
                                                                justifyContent: "space-between",
                                                                alignItems: "center",
                                                                padding: "0.75rem",
                                                                background: "var(--bg-elevated)",
                                                                borderRadius: "8px",
                                                                border: "1px solid var(--border-primary)"
                                                            }}
                                                        >
                                                            {isEditing ? (
                                                                <input
                                                                    type="text"
                                                                    value={editingCategoryNewName}
                                                                    onChange={(e) => setEditingCategoryNewName(e.target.value)}
                                                                    onKeyPress={(e) => e.key === 'Enter' && handleRenameCategory(category, editingCategoryNewName)}
                                                                    style={{
                                                                        flex: 1,
                                                                        padding: "0.5rem",
                                                                        background: "var(--bg-primary)",
                                                                        border: "1px solid var(--accent-primary)",
                                                                        borderRadius: "4px",
                                                                        color: "var(--text-primary)",
                                                                        marginRight: "0.5rem"
                                                                    }}
                                                                    autoFocus
                                                                />
                                                            ) : (
                                                                <div>
                                                                    <span style={{ fontWeight: "500", color: "var(--text-primary)" }}>{category}</span>
                                                                    <span style={{ color: "var(--text-secondary)", fontSize: "0.85rem", marginLeft: "0.5rem" }}>
                                                                        ({companyCount} {companyCount === 1 ? 'company' : 'companies'})
                                                                    </span>
                                                                </div>
                                                            )}
                                                            <div style={{ display: "flex", gap: "0.5rem" }}>
                                                                {isEditing ? (
                                                                    <>
                                                                        <button
                                                                            onClick={() => handleRenameCategory(category, editingCategoryNewName)}
                                                                            style={{
                                                                                padding: "0.4rem 0.8rem",
                                                                                background: "var(--accent-primary)",
                                                                                color: "white",
                                                                                border: "none",
                                                                                borderRadius: "4px",
                                                                                cursor: "pointer",
                                                                                fontSize: "0.8rem"
                                                                            }}
                                                                        >
                                                                            Save
                                                                        </button>
                                                                        <button
                                                                            onClick={() => setEditingCategoryName(null)}
                                                                            style={{
                                                                                padding: "0.4rem 0.8rem",
                                                                                background: "var(--bg-hover)",
                                                                                color: "var(--text-secondary)",
                                                                                border: "1px solid var(--border-primary)",
                                                                                borderRadius: "4px",
                                                                                cursor: "pointer",
                                                                                fontSize: "0.8rem"
                                                                            }}
                                                                        >
                                                                            Cancel
                                                                        </button>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setEditingCategoryName(category);
                                                                                setEditingCategoryNewName(category);
                                                                            }}
                                                                            style={{
                                                                                padding: "0.4rem 0.8rem",
                                                                                background: "var(--bg-hover)",
                                                                                color: "var(--text-secondary)",
                                                                                border: "1px solid var(--border-primary)",
                                                                                borderRadius: "4px",
                                                                                cursor: "pointer",
                                                                                fontSize: "0.8rem"
                                                                            }}
                                                                        >
                                                                            Edit
                                                                        </button>
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleDeleteCategory(category);
                                                                            }}
                                                                            style={{
                                                                                padding: "0.4rem 0.8rem",
                                                                                background: "rgba(255, 0, 0, 0.1)",
                                                                                color: "#ff4444",
                                                                                border: "1px solid rgba(255, 0, 0, 0.2)",
                                                                                borderRadius: "4px",
                                                                                cursor: "pointer",
                                                                                fontSize: "0.8rem"
                                                                            }}
                                                                        >
                                                                            Delete
                                                                        </button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button className="btn" onClick={() => setShowCategoryManager(false)}>
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Jobs Table Component
        function JobsTable({ jobs, filters, setFilters, onAdd, onEdit, onUpdateJob, onDelete, onExport, onBackup, requestSort, getSortIcon }) {
            // View modal state
            const [viewModalOpen, setViewModalOpen] = useState(false);
            const [viewModalJob, setViewModalJob] = useState(null);
            const [viewModalEdit, setViewModalEdit] = useState(false);
            const [editedJobData, setEditedJobData] = useState(null);
            const notesTextareaRef = useRef(null);

            // Auto-expand textarea based on content
            const autoExpandTextarea = () => {
                if (notesTextareaRef.current) {
                    notesTextareaRef.current.style.height = 'auto';
                    notesTextareaRef.current.style.height = Math.max(notesTextareaRef.current.scrollHeight, 120) + 'px';
                }
            };

            useEffect(() => {
                autoExpandTextarea();
            }, [viewModalJob, editedJobData, viewModalEdit]);

            // Read-only styling for view mode fields in job modal
            const viewFieldStyle = viewModalEdit ? {} : {
                background: 'var(--bg-tertiary)',
                border: '1px dashed var(--border-primary)',
                color: 'var(--text-secondary)',
                cursor: 'not-allowed'
            };
            // Column visibility state - updated defaults
            const [visibleColumns, setVisibleColumns] = useState({
                company: true,
                role: true,
                status: true,
                priority: false,
                dateApplied: true,
                salary: false,
                closeReason: false,
                progression: true,
                followUp: false,
                notes: false,
                resumeUrl: false,
                coverLetterUrl: false
            });
            const [showColumnSelector, setShowColumnSelector] = useState(false);

            // Advanced filters state
            const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
            const [dateRangeFilter, setDateRangeFilter] = useState({ start: '', end: '' });

            // Multiselect filters
            const [selectedStatuses, setSelectedStatuses] = useState([]);
            const [selectedPriorities, setSelectedPriorities] = useState([]);
            const [showStatusDropdown, setShowStatusDropdown] = useState(false);
            const [showPriorityDropdown, setShowPriorityDropdown] = useState(false);

            // Close dropdowns when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (showStatusDropdown && !event.target.closest('.filter-select') && !event.target.closest('[data-dropdown="status"]')) {
                        setShowStatusDropdown(false);
                    }
                    if (showPriorityDropdown && !event.target.closest('.filter-select') && !event.target.closest('[data-dropdown="priority"]')) {
                        setShowPriorityDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showStatusDropdown, showPriorityDropdown]);

            // Apply all filters to jobs
            const filteredJobs = jobs.filter(job => {
                // Status multiselect filter
                if (selectedStatuses.length > 0 && !selectedStatuses.includes(job.status)) {
                    return false;
                }

                // Priority multiselect filter
                if (selectedPriorities.length > 0 && !selectedPriorities.includes(job.priority)) {
                    return false;
                }

                // Date range filter
                if (dateRangeFilter.start || dateRangeFilter.end) {
                    const jobDate = new Date(job.dateApplied);
                    if (dateRangeFilter.start) {
                        const startDate = new Date(dateRangeFilter.start);
                        if (jobDate < startDate) return false;
                    }
                    if (dateRangeFilter.end) {
                        const endDate = new Date(dateRangeFilter.end);
                        if (jobDate > endDate) return false;
                    }
                }

                return true;
            });

            // Pagination state
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 20;

            // Calculate pagination
            const totalPages = Math.ceil(filteredJobs.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedJobs = filteredJobs.slice(startIndex, startIndex + itemsPerPage);

            // Reset to first page when filters change
            useEffect(() => {
                setCurrentPage(1);
            }, [filters.search, selectedStatuses.length, selectedPriorities.length, dateRangeFilter]);

            // Count active filters
            const activeFiltersCount = [
                filters.search,
                selectedStatuses.length > 0,
                selectedPriorities.length > 0,
                dateRangeFilter.start || dateRangeFilter.end
            ].filter(Boolean).length;

            const clearFilters = () => {
                setFilters({ status: 'all', priority: 'all', company: '', search: '' });
                setSelectedStatuses([]);
                setSelectedPriorities([]);
                setDateRangeFilter({ start: '', end: '' });
            };

            const handleQuickClose = (job) => {
                const today = new Date().toISOString().split('T')[0];
                const proceed = confirm(`Close "${job.role}" at ${job.company} as Rejected today?`);
                if (!proceed) return;

                onUpdateJob({
                    ...job,
                    status: JOB_STATUSES.CLOSED,
                    closeReason: CLOSE_REASONS.REJECTED,
                    followUp: today
                });
            };

            const toggleColumn = (key) => {
                setVisibleColumns(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const toggleStatus = (status) => {
                setSelectedStatuses(prev =>
                    prev.includes(status)
                        ? prev.filter(s => s !== status)
                        : [...prev, status]
                );
            };

            const togglePriority = (priority) => {
                setSelectedPriorities(prev =>
                    prev.includes(priority)
                        ? prev.filter(p => p !== priority)
                        : [...prev, priority]
                );
            };

            const columns = [
                { key: 'company', label: 'Company' },
                { key: 'role', label: 'Role' },
                { key: 'status', label: 'Status' },
                { key: 'priority', label: 'Priority' },
                { key: 'dateApplied', label: 'Date applied' },
                { key: 'salary', label: 'Salary' },
                { key: 'closeReason', label: 'Reason' },
                { key: 'progression', label: 'Progress' },
                { key: 'followUp', label: 'Close date' },
                { key: 'notes', label: 'Notes' },
                { key: 'resumeUrl', label: 'Resume' },
                { key: 'coverLetterUrl', label: 'Cover letter' }
            ];

            return (
                <div>
                    <div className="action-bar">
                        <div style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                            <h1 style={{ color: "var(--accent-primary)", fontFamily: "'Bricolage Grotesque', sans-serif", fontSize: "1.75rem" }}>Applications</h1>
                            <span style={{ color: "var(--text-tertiary)", fontSize: "0.9rem" }}>
                                {filteredJobs.length === jobs.length
                                    ? `${jobs.length} ${jobs.length === 1 ? 'application' : 'applications'}`
                                    : `${filteredJobs.length} of ${jobs.length}`
                                }
                            </span>
                        </div>

                        <div style={{ display: "flex", gap: "0.5rem" }}>
                            <button className="btn btn-secondary" onClick={onExport}>ðŸ“Š Export CSV</button>
                            <button className="btn" onClick={onAdd}>Add application</button>
                        </div>
                    </div>

                    <div className="action-bar" style={{ marginTop: "1rem" }}>
                        <div className="filters-section" data-filter-group="applications-filters" style={{ flex: 1 }}>
                            <div className="filters-row" style={{ display: "flex", gap: "0.75rem", flexWrap: "wrap", alignItems: "center" }}>
                                <div className="search-container">
                                    <input
                                        type="text"
                                        className="search-input"
                                        placeholder="Search applications by role or company"
                                        value={filters.search}
                                        onChange={(e) => setFilters({ ...filters, search: e.target.value })}
                                    />
                                    {filters.search && (
                                        <button
                                            className="clear-search"
                                            onClick={() => setFilters({ ...filters, search: "" })}
                                        >
                                            Ã—
                                        </button>
                                    )}
                                </div>

                                {/* Status Multiselect */}
                                <div style={{ position: "relative" }}>
                                    <button
                                        className="filter-select"
                                        onClick={() => setShowStatusDropdown(!showStatusDropdown)}
                                        style={{
                                            display: "flex",
                                            alignItems: "center",
                                            justifyContent: "space-between",
                                            gap: "0.5rem",
                                            minWidth: "160px",
                                            cursor: "pointer"
                                        }}
                                    >
                                        <span>
                                            {selectedStatuses.length === 0
                                                ? 'All statuses'
                                                : `Status (${selectedStatuses.length})`}
                                        </span>
                                        <span style={{ fontSize: "0.7rem" }}>â–¼</span>
                                    </button>
                                    {showStatusDropdown && (
                                        <div data-dropdown="status" style={{
                                            position: "absolute",
                                            top: "calc(100% + 4px)",
                                            left: 0,
                                            background: "var(--bg-elevated)",
                                            border: "1px solid var(--border-primary)",
                                            borderRadius: "10px",
                                            padding: "0.5rem",
                                            boxShadow: "var(--shadow-lg)",
                                            zIndex: 1000,
                                            minWidth: "200px",
                                            maxHeight: "300px",
                                            overflowY: "auto"
                                        }}>
                                            <button
                                                onClick={() => setSelectedStatuses([])}
                                                style={{
                                                    width: "100%",
                                                    padding: "0.5rem",
                                                    marginBottom: "0.5rem",
                                                    background: "var(--bg-hover)",
                                                    border: "1px solid var(--border-primary)",
                                                    borderRadius: "6px",
                                                    cursor: "pointer",
                                                    fontSize: "0.85rem",
                                                    color: "var(--text-secondary)",
                                                    fontWeight: "500",
                                                    transition: "all 0.2s"
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = "var(--accent-primary)";
                                                    e.currentTarget.style.color = "white";
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = "var(--bg-hover)";
                                                    e.currentTarget.style.color = "var(--text-secondary)";
                                                }}
                                            >
                                                Clear all
                                            </button>
                                            {STATUSES.map(status => (
                                                <label
                                                    key={status}
                                                    style={{
                                                        display: "flex",
                                                        alignItems: "center",
                                                        gap: "0.5rem",
                                                        padding: "0.5rem",
                                                        cursor: "pointer",
                                                        borderRadius: "6px",
                                                        transition: "background 0.2s",
                                                        fontSize: "0.9rem",
                                                        color: "var(--text-primary)"
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.background = "var(--bg-hover)"}
                                                    onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedStatuses.includes(status)}
                                                        onChange={() => toggleStatus(status)}
                                                        style={{
                                                            width: "16px",
                                                            height: "16px",
                                                            cursor: "pointer",
                                                            accentColor: "var(--accent-primary)"
                                                        }}
                                                    />
                                                    <span>{status}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Priority Multiselect */}
                                <div style={{ position: "relative" }}>
                                    <button
                                        className="filter-select"
                                        onClick={() => setShowPriorityDropdown(!showPriorityDropdown)}
                                        style={{
                                            display: "flex",
                                            alignItems: "center",
                                            justifyContent: "space-between",
                                            gap: "0.5rem",
                                            minWidth: "160px",
                                            cursor: "pointer"
                                        }}
                                    >
                                        <span>
                                            {selectedPriorities.length === 0
                                                ? 'All priorities'
                                                : `Priority (${selectedPriorities.length})`}
                                        </span>
                                        <span style={{ fontSize: "0.7rem" }}>â–¼</span>
                                    </button>
                                    {showPriorityDropdown && (
                                        <div data-dropdown="priority" style={{
                                            position: "absolute",
                                            top: "calc(100% + 4px)",
                                            left: 0,
                                            background: "var(--bg-elevated)",
                                            border: "1px solid var(--border-primary)",
                                            borderRadius: "10px",
                                            padding: "0.5rem",
                                            boxShadow: "var(--shadow-lg)",
                                            zIndex: 1000,
                                            minWidth: "200px"
                                        }}>
                                            <button
                                                onClick={() => setSelectedPriorities([])}
                                                style={{
                                                    width: "100%",
                                                    padding: "0.5rem",
                                                    marginBottom: "0.5rem",
                                                    background: "var(--bg-hover)",
                                                    border: "1px solid var(--border-primary)",
                                                    borderRadius: "6px",
                                                    cursor: "pointer",
                                                    fontSize: "0.85rem",
                                                    color: "var(--text-secondary)",
                                                    fontWeight: "500",
                                                    transition: "all 0.2s"
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = "var(--accent-primary)";
                                                    e.currentTarget.style.color = "white";
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = "var(--bg-hover)";
                                                    e.currentTarget.style.color = "var(--text-secondary)";
                                                }}
                                            >
                                                Clear all
                                            </button>
                                            {PRIORITIES.map(priority => (
                                                <label
                                                    key={priority}
                                                    style={{
                                                        display: "flex",
                                                        alignItems: "center",
                                                        gap: "0.5rem",
                                                        padding: "0.5rem",
                                                        cursor: "pointer",
                                                        borderRadius: "6px",
                                                        transition: "background 0.2s",
                                                        fontSize: "0.9rem",
                                                        color: "var(--text-primary)"
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.background = "var(--bg-hover)"}
                                                    onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedPriorities.includes(priority)}
                                                        onChange={() => togglePriority(priority)}
                                                        style={{
                                                            width: "16px",
                                                            height: "16px",
                                                            cursor: "pointer",
                                                            accentColor: "var(--accent-primary)"
                                                        }}
                                                    />
                                                    <span>{priority}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <button
                                    className={`advanced-filters-toggle ${showAdvancedFilters ? 'active' : ''}`}
                                    onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                                    style={{
                                        background: showAdvancedFilters ? "var(--accent-primary)" : "var(--bg-tertiary)",
                                        color: showAdvancedFilters ? "white" : "var(--text-secondary)",
                                        border: "1px solid var(--border-primary)",
                                        padding: "0.6rem 1rem",
                                        borderRadius: "10px",
                                        cursor: "pointer",
                                        fontSize: "0.85rem",
                                        fontWeight: "500",
                                        display: "flex",
                                        alignItems: "center",
                                        gap: "0.5rem",
                                        transition: "all 0.2s ease"
                                    }}
                                >
                                    ðŸ“… Application date
                                    {activeFiltersCount > 0 && ` (${activeFiltersCount})`}
                                </button>

                                {/* Clear All Filters */}
                                {(filters.search || selectedStatuses.length > 0 || selectedPriorities.length > 0 || dateRangeFilter.start || dateRangeFilter.end) && (
                                    <button
                                        onClick={clearFilters}
                                        style={{
                                            background: "transparent",
                                            color: "var(--accent-primary)",
                                            border: "none",
                                            padding: "0.6rem 0.75rem",
                                            borderRadius: "10px",
                                            cursor: "pointer",
                                            fontSize: "0.85rem",
                                            fontWeight: "500",
                                            transition: "all 0.2s ease",
                                            whiteSpace: "nowrap"
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.textDecoration = "underline"}
                                        onMouseLeave={(e) => e.currentTarget.style.textDecoration = "none"}
                                    >
                                        Clear all
                                    </button>
                                )}
                            </div>
                        </div>
                        <button
                            className="btn btn-secondary"
                            onClick={() => setShowColumnSelector(!showColumnSelector)}
                        >
                            âš™ï¸ Columns
                        </button>
                    </div>

                    {showAdvancedFilters && (
                        <div style={{
                            background: "var(--bg-secondary)",
                            border: "1px solid var(--border-primary)",
                            borderRadius: "12px",
                            padding: "1.5rem",
                            marginBottom: "1.5rem",
                            boxShadow: "var(--shadow-md)",
                            animation: "slideDown 0.3s ease"
                        }}>
                            <div style={{
                                display: "grid",
                                gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
                                gap: "1rem"
                            }}>
                                <div className="filter-group">
                                    <label className="filter-label" style={{ fontSize: "0.85rem", color: "var(--text-secondary)", fontWeight: "500", marginBottom: "0.5rem", display: "block" }}>
                                        Date from
                                    </label>
                                    <input
                                        type="date"
                                        className="filter-select"
                                        value={dateRangeFilter.start}
                                        onChange={(e) => setDateRangeFilter(prev => ({ ...prev, start: e.target.value }))}
                                    />
                                </div>
                                <div className="filter-group">
                                    <label className="filter-label" style={{ fontSize: "0.85rem", color: "var(--text-secondary)", fontWeight: "500", marginBottom: "0.5rem", display: "block" }}>
                                        Date to
                                    </label>
                                    <input
                                        type="date"
                                        className="filter-select"
                                        value={dateRangeFilter.end}
                                        onChange={(e) => setDateRangeFilter(prev => ({ ...prev, end: e.target.value }))}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {showColumnSelector && (
                        <div style={{
                            background: "var(--bg-secondary)",
                            border: "1px solid var(--border-primary)",
                            borderRadius: "12px",
                            padding: "1.5rem",
                            marginBottom: "1.5rem"
                        }}>
                            <h4 style={{ fontSize: "0.95rem", fontWeight: "600", marginBottom: "1rem", color: "var(--text-primary)" }}>
                                Visible columns
                            </h4>
                            <div style={{
                                display: "grid",
                                gridTemplateColumns: "repeat(auto-fill, minmax(150px, 1fr))",
                                gap: "0.75rem"
                            }}>
                                {columns.map(col => (
                                    <label key={col.key} className="checkbox-label" style={{
                                        display: "flex",
                                        alignItems: "center",
                                        gap: "0.5rem",
                                        cursor: "pointer",
                                        fontSize: "0.9rem",
                                        color: "var(--text-secondary)",
                                        padding: "0.5rem",
                                        borderRadius: "6px",
                                        transition: "all 0.2s ease"
                                    }}>
                                        <input
                                            type="checkbox"
                                            checked={visibleColumns[col.key]}
                                            onChange={() => toggleColumn(col.key)}
                                            style={{ width: "18px", height: "18px", cursor: "pointer", accentColor: "var(--accent-primary)" }}
                                        />
                                        <span>{col.label}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    )}

                    {filteredJobs.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">ðŸ”</div>
                            <h3>No applications. Let's change that!</h3>
                            <p>Add an application or adjust your filters</p>
                        </div>
                    ) : (
                        <>
                            <div className="table-container">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            {visibleColumns.company && (
                                                <th onClick={() => requestSort('company')} style={{ cursor: 'pointer' }}>
                                                    Company{getSortIcon('company')}
                                                </th>
                                            )}
                                            {visibleColumns.role && (
                                                <th onClick={() => requestSort('role')} style={{ cursor: 'pointer' }}>
                                                    Role{getSortIcon('role')}
                                                </th>
                                            )}
                                            {visibleColumns.status && (
                                                <th onClick={() => requestSort('status')} style={{ cursor: 'pointer' }}>
                                                    Status{getSortIcon('status')}
                                                </th>
                                            )}
                                            {visibleColumns.priority && (
                                                <th onClick={() => requestSort('priority')} style={{ cursor: 'pointer' }}>
                                                    Priority{getSortIcon('priority')}
                                                </th>
                                            )}
                                            {visibleColumns.dateApplied && (
                                                <th onClick={() => requestSort('dateApplied')} style={{ cursor: 'pointer' }}>
                                                    Date applied{getSortIcon('dateApplied')}
                                                </th>
                                            )}
                                            {visibleColumns.salary && (
                                                <th onClick={() => requestSort('salary')} style={{ cursor: 'pointer' }}>
                                                    Salary{getSortIcon('salary')}
                                                </th>
                                            )}
                                            {visibleColumns.closeReason && (
                                                <th onClick={() => requestSort('closeReason')} style={{ cursor: 'pointer' }}>
                                                    Reason{getSortIcon('closeReason')}
                                                </th>
                                            )}
                                            {visibleColumns.progression && (
                                                <th onClick={() => requestSort('progression')} style={{ cursor: 'pointer' }}>
                                                    Progress{getSortIcon('progression')}
                                                </th>
                                            )}
                                            {visibleColumns.followUp && (
                                                <th onClick={() => requestSort('followUp')} style={{ cursor: 'pointer' }}>
                                                    Close date{getSortIcon('followUp')}
                                                </th>
                                            )}
                                            {visibleColumns.notes && (
                                                <th>Notes</th>
                                            )}
                                            {visibleColumns.resumeUrl && (
                                                <th>Resume</th>
                                            )}
                                            {visibleColumns.coverLetterUrl && (
                                                <th>Cover letter</th>
                                            )}
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {paginatedJobs.map(job => (
                                            <tr key={job.id}>
                                                {visibleColumns.company && <td><strong>{job.company}</strong></td>}
                                                {visibleColumns.role && (
                                                    <td style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                                                        <button
                                                            className="icon-btn"
                                                            title="View"
                                                            style={{
                                                                background: "var(--bg-tertiary)",
                                                                border: "1px solid var(--border-primary)",
                                                                width: "32px",
                                                                height: "32px",
                                                                borderRadius: "6px",
                                                                cursor: "pointer",
                                                                display: "inline-flex",
                                                                alignItems: "center",
                                                                justifyContent: "center",
                                                                transition: "all 0.2s ease",
                                                                color: "var(--text-secondary)",
                                                                fontSize: "1.1rem"
                                                            }}
                                                            onClick={() => {
                                                                setViewModalJob(job);
                                                                setViewModalOpen(true);
                                                                setViewModalEdit(false);
                                                            }}
                                                        >
                                                            <span role="img" aria-label="View">ðŸ‘ï¸</span>
                                                        </button>
                                                        {job.url ? (
                                                            <a href={job.url} target="_blank" rel="noopener noreferrer" style={{ color: "var(--accent-primary)", textDecoration: "none" }}>{job.role}&nbsp;<span style={{ fontSize: '0.85em', marginLeft: '0.25rem' }}>â†—</span></a>
                                                        ) : job.role}
                                                    </td>
                                                )}
                                                {visibleColumns.status && <td><StatusBadge status={job.status} /></td>}
                                                {visibleColumns.priority && <td><PriorityBadge priority={job.priority} /></td>}
                                                {visibleColumns.dateApplied && <td>{job.dateApplied ? new Date(job.dateApplied + 'T00:00:00').toLocaleDateString() : '-'}</td>}
                                                {visibleColumns.salary && <td>{job.salary || "-"}</td>}
                                                {visibleColumns.closeReason && <td>{job.closeReason || "-"}</td>}
                                                {visibleColumns.progression && <td>{job.progression || "-"}</td>}
                                                {visibleColumns.followUp && <td>{job.followUp ? new Date(job.followUp + 'T00:00:00').toLocaleDateString() : "-"}</td>}
                                                {visibleColumns.notes && (
                                                    <td style={{ maxWidth: "200px", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                                                        {job.notes || "-"}
                                                    </td>
                                                )}
                                                {visibleColumns.resumeUrl && (
                                                    <td>
                                                        {job.resumeUrl ? (
                                                            <a href={job.resumeUrl} target="_blank" rel="noopener noreferrer" style={{ color: "var(--accent-primary)", textDecoration: "none" }}>
                                                                ðŸ“„&nbsp;View
                                                            </a>
                                                        ) : "-"}
                                                    </td>
                                                )}
                                                {visibleColumns.coverLetterUrl && (
                                                    <td>
                                                        {job.coverLetterUrl ? (
                                                            <a href={job.coverLetterUrl} target="_blank" rel="noopener noreferrer" style={{ color: "var(--accent-primary)", textDecoration: "none" }}>
                                                                ðŸ“&nbsp;View
                                                            </a>
                                                        ) : "-"}
                                                    </td>
                                                )}
                                                <td>
                                                    <div style={{ display: "flex", gap: "0.5rem" }}>
                                                        <button
                                                            className="icon-btn"
                                                            onClick={() => onEdit(job)}
                                                            title="Edit"
                                                            style={{
                                                                background: "var(--bg-tertiary)",
                                                                border: "1px solid var(--border-primary)",
                                                                width: "32px",
                                                                height: "32px",
                                                                borderRadius: "6px",
                                                                cursor: "pointer",
                                                                display: "flex",
                                                                alignItems: "center",
                                                                justifyContent: "center",
                                                                transition: "all 0.2s ease",
                                                                color: "var(--text-secondary)",
                                                                fontSize: "0.9rem"
                                                            }}
                                                        >
                                                            âœï¸
                                                        </button>
                                                        <button
                                                            className="icon-btn"
                                                            onClick={() => handleQuickClose(job)}
                                                            title="Close as rejected today"
                                                            style={{
                                                                background: "var(--bg-tertiary)",
                                                                border: "1px solid var(--border-primary)",
                                                                width: "32px",
                                                                height: "32px",
                                                                borderRadius: "6px",
                                                                cursor: "pointer",
                                                                display: "flex",
                                                                alignItems: "center",
                                                                justifyContent: "center",
                                                                transition: "all 0.2s ease",
                                                                color: "var(--text-secondary)",
                                                                fontSize: "0.9rem"
                                                            }}
                                                        >
                                                            ðŸš«
                                                        </button>
                                                        <button
                                                            className="icon-btn danger"
                                                            onClick={() => onDelete(job.id)}
                                                            title="Delete"
                                                            style={{
                                                                background: "var(--bg-tertiary)",
                                                                border: "1px solid var(--border-primary)",
                                                                width: "32px",
                                                                height: "32px",
                                                                borderRadius: "6px",
                                                                cursor: "pointer",
                                                                display: "flex",
                                                                alignItems: "center",
                                                                justifyContent: "center",
                                                                transition: "all 0.2s ease",
                                                                color: "var(--text-secondary)",
                                                                fontSize: "0.9rem"
                                                            }}
                                                        >
                                                            ðŸ—‘ï¸
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            {totalPages > 1 && (
                                <div style={{
                                    display: "flex",
                                    justifyContent: "center",
                                    alignItems: "center",
                                    gap: "0.5rem",
                                    marginTop: "2rem",
                                    padding: "1rem"
                                }}>
                                    <button
                                        className="pagination-btn"
                                        onClick={() => setCurrentPage(1)}
                                        disabled={currentPage === 1}
                                        style={{
                                            background: "var(--bg-secondary)",
                                            border: "1px solid var(--border-primary)",
                                            color: "var(--text-primary)",
                                            padding: "0.5rem 1rem",
                                            borderRadius: "8px",
                                            cursor: currentPage === 1 ? "not-allowed" : "pointer",
                                            fontSize: "0.9rem",
                                            transition: "all 0.2s ease",
                                            opacity: currentPage === 1 ? 0.4 : 1
                                        }}
                                    >
                                        Â«Â«
                                    </button>
                                    <button
                                        className="pagination-btn"
                                        onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                        disabled={currentPage === 1}
                                        style={{
                                            background: "var(--bg-secondary)",
                                            border: "1px solid var(--border-primary)",
                                            color: "var(--text-primary)",
                                            padding: "0.5rem 1rem",
                                            borderRadius: "8px",
                                            cursor: currentPage === 1 ? "not-allowed" : "pointer",
                                            fontSize: "0.9rem",
                                            transition: "all 0.2s ease",
                                            opacity: currentPage === 1 ? 0.4 : 1
                                        }}
                                    >
                                        â€¹
                                    </button>
                                    <span style={{ color: "var(--text-secondary)", fontSize: "0.9rem" }}>
                                        Page {currentPage} of {totalPages} ({filteredJobs.length} total)
                                    </span>
                                    <button
                                        className="pagination-btn"
                                        onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                        disabled={currentPage === totalPages}
                                        style={{
                                            background: "var(--bg-secondary)",
                                            border: "1px solid var(--border-primary)",
                                            color: "var(--text-primary)",
                                            padding: "0.5rem 1rem",
                                            borderRadius: "8px",
                                            cursor: currentPage === totalPages ? "not-allowed" : "pointer",
                                            fontSize: "0.9rem",
                                            transition: "all 0.2s ease",
                                            opacity: currentPage === totalPages ? 0.4 : 1
                                        }}
                                    >
                                        â€º
                                    </button>
                                    <button
                                        className="pagination-btn"
                                        onClick={() => setCurrentPage(totalPages)}
                                        disabled={currentPage === totalPages}
                                        style={{
                                            background: "var(--bg-secondary)",
                                            border: "1px solid var(--border-primary)",
                                            color: "var(--text-primary)",
                                            padding: "0.5rem 1rem",
                                            borderRadius: "8px",
                                            cursor: currentPage === totalPages ? "not-allowed" : "pointer",
                                            fontSize: "0.9rem",
                                            transition: "all 0.2s ease",
                                            opacity: currentPage === totalPages ? 0.4 : 1
                                        }}
                                    >
                                        Â»Â»
                                    </button>
                                </div>
                            )}
                        </>
                    )}
                    {/* View Modal for job details */}
                    {viewModalOpen && (
                        <div className="modal-overlay" onClick={() => setViewModalOpen(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '700px' }}>
                                <div className="modal-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <h2>Application details</h2>
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        {viewModalEdit ? (
                                            <button
                                                className="btn"
                                                onClick={() => {
                                                    onUpdateJob(editedJobData);
                                                    setViewModalOpen(false);
                                                    setViewModalEdit(false);
                                                    setEditedJobData(null);
                                                }}
                                            >
                                                Save & close
                                            </button>
                                        ) : (
                                            <button className="icon-btn" title="Edit" style={{
                                                background: 'var(--bg-tertiary)',
                                                border: '1px solid var(--border-primary)',
                                                width: '32px', height: '32px', borderRadius: '6px', cursor: 'pointer',
                                                display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-secondary)', fontSize: '1.1rem'
                                            }} onClick={() => {
                                                if (!viewModalEdit) {
                                                    setEditedJobData({ ...viewModalJob });
                                                }
                                                setViewModalEdit(true);
                                            }}>
                                                <span role="img" aria-label="Edit">âœï¸</span>
                                            </button>
                                        )}
                                        <button className="modal-close" onClick={() => setViewModalOpen(false)}>Ã—</button>
                                    </div>
                                </div>
                                <div className="modal-body">
                                    { /* Use a subtle read-only style in view mode */}
                                    {viewModalJob ? (
                                        <div style={{ borderBottom: '1px solid var(--border-primary)', marginBottom: '1.5rem', paddingBottom: '1.5rem' }}>
                                            <h3 style={{ color: 'var(--accent-primary)', marginBottom: '0.5rem' }}>{viewModalEdit ? editedJobData?.role : viewModalJob.role} @ {viewModalEdit ? editedJobData?.company : viewModalJob.company}</h3>
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Company</label>
                                                    <input type="text" value={viewModalEdit ? editedJobData?.company || '' : viewModalJob.company} readOnly={!viewModalEdit} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, company: e.target.value });
                                                    }} style={viewFieldStyle} />
                                                </div>
                                                <div className="form-group">
                                                    <label>Role</label>
                                                    <input type="text" value={viewModalEdit ? editedJobData?.role || '' : viewModalJob.role} readOnly={!viewModalEdit} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, role: e.target.value });
                                                    }} style={viewFieldStyle} />
                                                </div>
                                            </div>
                                            <div className="form-group">
                                                <label>Job URL</label>
                                                {viewModalEdit ? (
                                                    <input type="url" value={editedJobData?.url || ''} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, url: e.target.value });
                                                    }} />
                                                ) : (
                                                    viewModalJob.url ? (
                                                        <div style={{
                                                            ...viewFieldStyle,
                                                            cursor: 'default',
                                                            padding: '0.75rem',
                                                            wordBreak: 'break-all'
                                                        }}>
                                                            <a
                                                                href={viewModalJob.url}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                style={{ color: 'var(--accent-primary)', textDecoration: 'underline' }}
                                                                onClick={(e) => e.stopPropagation()}
                                                            >
                                                                {viewModalJob.url}
                                                            </a>
                                                        </div>
                                                    ) : (
                                                        <div style={viewFieldStyle}>-</div>
                                                    )
                                                )}
                                            </div>
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Resume URL</label>
                                                    {viewModalEdit ? (
                                                        <input type="url" value={editedJobData?.resumeUrl || ''} onChange={e => {
                                                            setEditedJobData({ ...editedJobData, resumeUrl: e.target.value });
                                                        }} />
                                                    ) : (
                                                        viewModalJob.resumeUrl ? (
                                                            <div style={{
                                                                ...viewFieldStyle,
                                                                cursor: 'default',
                                                                padding: '0.75rem',
                                                                wordBreak: 'break-all'
                                                            }}>
                                                                <a
                                                                    href={viewModalJob.resumeUrl}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    style={{ color: 'var(--accent-primary)', textDecoration: 'underline' }}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                >
                                                                    {viewModalJob.resumeUrl}
                                                                </a>
                                                            </div>
                                                        ) : (
                                                            <div style={viewFieldStyle}>-</div>
                                                        )
                                                    )}
                                                </div>
                                                <div className="form-group">
                                                    <label>Cover letter URL</label>
                                                    {viewModalEdit ? (
                                                        <input type="url" value={editedJobData?.coverLetterUrl || ''} onChange={e => {
                                                            setEditedJobData({ ...editedJobData, coverLetterUrl: e.target.value });
                                                        }} />
                                                    ) : (
                                                        viewModalJob.coverLetterUrl ? (
                                                            <div style={{
                                                                ...viewFieldStyle,
                                                                cursor: 'default',
                                                                padding: '0.75rem',
                                                                wordBreak: 'break-all'
                                                            }}>
                                                                <a
                                                                    href={viewModalJob.coverLetterUrl}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    style={{ color: 'var(--accent-primary)', textDecoration: 'underline' }}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                >
                                                                    {viewModalJob.coverLetterUrl}
                                                                </a>
                                                            </div>
                                                        ) : (
                                                            <div style={viewFieldStyle}>-</div>
                                                        )
                                                    )}
                                                </div>
                                            </div>
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Status</label>
                                                    <input type="text" value={viewModalEdit ? editedJobData?.status || '' : viewModalJob.status || ''} readOnly={!viewModalEdit} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, status: e.target.value });
                                                    }} style={viewFieldStyle} />
                                                </div>
                                                <div className="form-group">
                                                    <label>Date applied</label>
                                                    <input type="date" value={viewModalEdit ? editedJobData?.dateApplied || '' : viewModalJob.dateApplied || ''} readOnly={!viewModalEdit} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, dateApplied: e.target.value });
                                                    }} style={viewFieldStyle} />
                                                </div>
                                            </div>
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Progression</label>
                                                    <input type="text" value={viewModalEdit ? editedJobData?.progression || '' : viewModalJob.progression || ''} readOnly={!viewModalEdit} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, progression: e.target.value });
                                                    }} style={viewFieldStyle} />
                                                </div>
                                                <div className="form-group">
                                                    <label>Priority</label>
                                                    <input type="text" value={viewModalEdit ? editedJobData?.priority || '' : viewModalJob.priority || ''} readOnly={!viewModalEdit} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, priority: e.target.value });
                                                    }} style={viewFieldStyle} />
                                                </div>
                                            </div>
                                            {(viewModalJob.closeReason || viewModalJob.followUp) && (
                                                <div className="form-row">
                                                    <div className="form-group">
                                                        <label>Close reason</label>
                                                        <input type="text" value={viewModalEdit ? editedJobData?.closeReason || '' : viewModalJob.closeReason || ''} readOnly={!viewModalEdit} onChange={e => {
                                                            setEditedJobData({ ...editedJobData, closeReason: e.target.value });
                                                        }} style={viewFieldStyle} />
                                                    </div>
                                                    <div className="form-group">
                                                        <label>Close date</label>
                                                        <input type="date" value={viewModalEdit ? editedJobData?.followUp || '' : viewModalJob.followUp || ''} readOnly={!viewModalEdit} onChange={e => {
                                                            setEditedJobData({ ...editedJobData, followUp: e.target.value });
                                                        }} style={viewFieldStyle} />
                                                    </div>
                                                </div>
                                            )}
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Salary</label>
                                                    <input type="text" value={viewModalEdit ? editedJobData?.salary || '' : viewModalJob.salary || ''} readOnly={!viewModalEdit} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, salary: e.target.value });
                                                    }} style={viewFieldStyle} />
                                                </div>
                                                <div className="form-group">
                                                    <label>Location</label>
                                                    <input type="text" value={viewModalEdit ? editedJobData?.location || '' : viewModalJob.location || ''} readOnly={!viewModalEdit} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, location: e.target.value });
                                                    }} style={viewFieldStyle} />
                                                </div>
                                            </div>
                                            <div className="form-group">
                                                <label>Contact name</label>
                                                <input type="text" value={viewModalEdit ? editedJobData?.contact || '' : viewModalJob.contact || ''} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, contact: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                            <div className="form-group">
                                                <label>Notes</label>
                                                {viewModalEdit ? (
                                                    <textarea value={editedJobData?.notes || ''} onChange={e => {
                                                        setEditedJobData({ ...editedJobData, notes: e.target.value });
                                                        autoExpandTextarea();
                                                    }} ref={notesTextareaRef} style={{ minHeight: '120px', resize: 'vertical', overflow: 'hidden' }} />
                                                ) : (
                                                    <div style={{
                                                        ...viewFieldStyle,
                                                        cursor: 'default',
                                                        minHeight: '120px',
                                                        padding: '0.75rem',
                                                        whiteSpace: 'pre-wrap',
                                                        wordBreak: 'break-word'
                                                    }} dangerouslySetInnerHTML={{ __html: viewModalJob.notes ? UIUtil.linkify(viewModalJob.notes) : '-' }}>
                                                    </div>
                                                )}
                                            </div>
                                            {viewModalEdit && (
                                                <div className="modal-footer" style={{ marginTop: '1.5rem', borderTop: '1px solid var(--border-primary)', paddingTop: '1.5rem', display: 'flex', gap: '0.75rem', justifyContent: 'flex-end' }}>
                                                    <button className="btn btn-secondary" onClick={() => {
                                                        setViewModalEdit(false);
                                                        setEditedJobData(null);
                                                    }}>Cancel</button>
                                                    <button className="btn" onClick={() => {
                                                        onUpdateJob(editedJobData);
                                                        setViewModalOpen(false);
                                                        setViewModalEdit(false);
                                                        setEditedJobData(null);
                                                    }}>Save & Close</button>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div>No job found.</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        // Stats Component
        function Stats({ jobs }) {
            const statusCounts = STATUSES.reduce((acc, status) => {
                acc[status] = jobs.filter(j => j.status === status).length;
                return acc;
            }, {});

            const priorityCounts = PRIORITIES.reduce((acc, priority) => {
                acc[priority] = jobs.filter(j => j.priority === priority).length;
                return acc;
            }, {});

            return (
                <div>
                    <h2 style={{ marginBottom: "1rem", color: "#6b8aff" }}>Application statuses</h2>
                    <div className="table-container" style={{ marginBottom: "2rem" }}>
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {STATUSES.map(status => (
                                    <tr key={status}>
                                        <td><StatusBadge status={status} /></td>
                                        <td>{statusCounts[status]}</td>
                                        <td>{jobs.length > 0 ? Math.round((statusCounts[status] / jobs.length) * 100) : 0}%</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <h2 style={{ marginBottom: "1rem", color: "#6b8aff" }}>Priority Breakdown</h2>
                    <div className="table-container">
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {PRIORITIES.map(priority => (
                                    <tr key={priority}>
                                        <td><PriorityBadge priority={priority} /></td>
                                        <td>{priorityCounts[priority]}</td>
                                        <td>{jobs.length > 0 ? Math.round((priorityCounts[priority] / jobs.length) * 100) : 0}%</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // Job Modal Component
        function JobModal({ job, onSave, onClose }) {
            const [formData, setFormData] = useState(() => {
                const today = new Date().toISOString().split('T')[0];
                const defaults = {
                    company: "",
                    role: "",
                    url: "",
                    status: "Applied",
                    priority: "Tier 2",
                    salary: "",
                    location: "",
                    contact: "",
                    notes: "",
                    followUp: "",
                    dateApplied: today,
                    closeReason: "",
                    progression: "Application",
                    resumeUrl: "",
                    coverLetterUrl: ""
                };

                if (job) {
                    return {
                        ...defaults,
                        ...job,
                        // Ensure status and priority are never undefined
                        status: job.status || "Applied",
                        priority: job.priority || "Tier 2",
                        progression: job.progression || "Application",
                        // Keep existing dateApplied or use today
                        dateApplied: job.dateApplied || today
                    };
                }

                return defaults;
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                try {
                    if (!formData.company.trim() || !formData.role.trim()) {
                        alert("Company and Role are required");
                        return;
                    }

                    // Ensure status, priority, and progression are set before saving
                    const jobToSave = {
                        ...formData,
                        status: formData.status || "Applied",
                        priority: formData.priority || "Tier 2",
                        progression: formData.progression || "Application"
                    };

                    console.log("Submitting job:", jobToSave);
                    onSave(jobToSave);
                } catch (error) {
                    console.error("Error submitting job:", error);
                    alert("Error saving job: " + error.message);
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>{job?.id ? "Edit application" : "Add application"}</h2>
                            <button className="modal-close" onClick={onClose}>Ã—</button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Company *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.company}
                                            onChange={(e) => setFormData({ ...formData, company: e.target.value })}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Role title *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.role}
                                            onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Job URL</label>
                                    <input
                                        type="url"
                                        value={formData.url}
                                        onChange={(e) => setFormData({ ...formData, url: e.target.value })}
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Resume URL</label>
                                        <input
                                            type="url"
                                            placeholder="Link to resume used for this application"
                                            value={formData.resumeUrl}
                                            onChange={(e) => setFormData({ ...formData, resumeUrl: e.target.value })}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Cover letter URL</label>
                                        <input
                                            type="url"
                                            placeholder="Link to cover letter used for this application"
                                            value={formData.coverLetterUrl}
                                            onChange={(e) => setFormData({ ...formData, coverLetterUrl: e.target.value })}
                                        />
                                    </div>
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Status *</label>
                                        <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })}>
                                            {STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label>Date applied</label>
                                        <input
                                            type="date"
                                            value={formData.dateApplied}
                                            onChange={(e) => setFormData({ ...formData, dateApplied: e.target.value })}
                                        />
                                    </div>

                                </div>

                                <div className="form-row">
                                    {(formData.status === "In Progress" || formData.status === "Closed") && (
                                        <div className="form-group">
                                            <label>Progression {formData.status === "Closed" && "(final stage)"}</label>
                                            <select
                                                value={formData.progression || ""}
                                                onChange={(e) => setFormData({ ...formData, progression: e.target.value })}
                                                disabled={formData.status === "Closed"}
                                                style={formData.status === "Closed" ? { backgroundColor: '#2a3248', cursor: 'not-allowed' } : {}}
                                            >
                                                <option value="">Select progression...</option>
                                                {PROGRESSIONS.map(p => <option key={p} value={p}>{p}</option>)}
                                            </select>
                                        </div>
                                    )}
                                    <div className="form-group">
                                        <label>Priority</label>
                                        <select value={formData.priority} onChange={(e) => setFormData({ ...formData, priority: e.target.value })}>
                                            {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
                                        </select>
                                    </div>
                                </div>

                                {/* Conditional: Show Close Reason and Close Date side by side if status is "Closed" */}
                                {formData.status === "Closed" && (
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Close reason *</label>
                                            <select
                                                required
                                                value={formData.closeReason || ""}
                                                onChange={(e) => setFormData({ ...formData, closeReason: e.target.value })}
                                            >
                                                <option value="">Select a reason...</option>
                                                {Object.values(CLOSE_REASONS).map(r => <option key={r} value={r}>{r}</option>)}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Close date</label>
                                            <input
                                                type="date"
                                                value={formData.followUp}
                                                onChange={(e) => setFormData({ ...formData, followUp: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                )}

                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Salary range</label>
                                        <input
                                            type="text"
                                            placeholder="e.g., $150k-$180k"
                                            value={formData.salary}
                                            onChange={(e) => setFormData({ ...formData, salary: e.target.value })}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Location</label>
                                        <input
                                            type="text"
                                            placeholder="Remote, Pittsburgh, etc."
                                            value={formData.location}
                                            onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Contact name</label>
                                    <input
                                        type="text"
                                        placeholder="Recruiter or hiring manager"
                                        value={formData.contact}
                                        onChange={(e) => setFormData({ ...formData, contact: e.target.value })}
                                    />
                                </div>

                                <div className="form-group">
                                    <label>Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        placeholder="Interview notes, referral info, etc."
                                    />
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn">Save application</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Import Modal Component
        function ImportModal({ onImport, onClose }) {
            const [dragActive, setDragActive] = useState(false);
            const [selectedFile, setSelectedFile] = useState(null);
            const [fileContent, setFileContent] = useState(null);
            const [preview, setPreview] = useState(null);
            const [importMode, setImportMode] = useState('replace');

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);

                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            };

            const handleFileInput = (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            };

            const handleFile = (file) => {
                if (!file.name.endsWith('.json')) {
                    alert('Please select a JSON backup file');
                    return;
                }

                setSelectedFile(file);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const data = JSON.parse(content);

                        if (!data.jobs || !Array.isArray(data.jobs)) {
                            alert('Invalid backup file: missing jobs data');
                            return;
                        }

                        setFileContent(content);
                        setPreview({
                            jobCount: data.jobs.length,
                            companyCount: data.customCompanies ? Object.keys(data.customCompanies).length : 0,
                            exportDate: data.exportDate ? new Date(data.exportDate).toLocaleString() : 'Unknown',
                            companies: data.jobs.map(j => j.company).filter((v, i, a) => a.indexOf(v) === i).slice(0, 10)
                        });
                    } catch (error) {
                        alert('Error reading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            const handleImport = () => {
                if (fileContent) {
                    onImport(fileContent, importMode);
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px' }}>
                        <div className="modal-header">
                            <h2>Import backup</h2>
                            <button className="modal-close" onClick={onClose}>Ã—</button>
                        </div>
                        <div className="modal-body">
                            {!preview ? (
                                <>
                                    <div
                                        style={{
                                            border: `2px dashed ${dragActive ? 'var(--accent-primary)' : 'var(--border-primary)'}`,
                                            borderRadius: '8px',
                                            padding: '3rem 2rem',
                                            textAlign: 'center',
                                            background: dragActive ? 'var(--bg-hover)' : 'var(--bg-tertiary)',
                                            transition: 'all 0.3s'
                                        }}
                                        onDragEnter={handleDrag}
                                        onDragLeave={handleDrag}
                                        onDragOver={handleDrag}
                                        onDrop={handleDrop}
                                    >
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>ðŸ“</div>
                                        <h3 style={{ marginBottom: '0.5rem', color: 'var(--text-primary)' }}>
                                            Drop your backup file here
                                        </h3>
                                        <p style={{ color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>
                                            or click to browse
                                        </p>
                                        <input
                                            type="file"
                                            accept=".json"
                                            onChange={handleFileInput}
                                            style={{ display: 'none' }}
                                            id="backup-file-input"
                                        />
                                        <label htmlFor="backup-file-input">
                                            <span className="btn">Choose file</span>
                                        </label>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'var(--bg-tertiary)', borderRadius: '6px', border: '1px solid var(--border-primary)' }}>
                                        <h3 style={{ color: 'var(--accent-primary)', marginBottom: '1rem' }}>ðŸ“Š Preview</h3>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                                            <div>
                                                <div style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>Jobs to import</div>
                                                <div style={{ color: 'var(--text-primary)', fontSize: '1.5rem', fontWeight: 'bold' }}>{preview.jobCount}</div>
                                            </div>
                                            <div>
                                                <div style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>Custom categories</div>
                                                <div style={{ color: 'var(--text-primary)', fontSize: '1.5rem', fontWeight: 'bold' }}>{preview.companyCount}</div>
                                            </div>
                                        </div>
                                        <div style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', marginTop: '0.5rem' }}>
                                            Backup created: {preview.exportDate}
                                        </div>
                                        {preview.companies.length > 0 && (
                                            <div style={{ marginTop: '1rem' }}>
                                                <div style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                    Companies (first 10):
                                                </div>
                                                <div style={{ color: 'var(--text-primary)', fontSize: '0.9rem' }}>
                                                    {preview.companies.join(', ')}
                                                    {preview.jobCount > 10 && '...'}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'var(--bg-tertiary)', borderRadius: '6px', border: '1px solid var(--border-primary)' }}>
                                        <h3 style={{ color: 'var(--accent-primary)', marginBottom: '1rem' }}>Import mode</h3>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                            <label style={{
                                                display: 'flex',
                                                alignItems: 'flex-start',
                                                cursor: 'pointer',
                                                padding: '0.75rem',
                                                background: importMode === 'merge' ? 'var(--bg-hover)' : 'transparent',
                                                borderRadius: '6px',
                                                border: `1px solid ${importMode === 'merge' ? 'var(--accent-primary)' : 'var(--border-primary)'}`
                                            }}>
                                                <input
                                                    type="radio"
                                                    name="importMode"
                                                    value="merge"
                                                    checked={importMode === 'merge'}
                                                    onChange={(e) => setImportMode(e.target.value)}
                                                    style={{ marginRight: '0.75rem', marginTop: '0.25rem' }}
                                                />
                                                <div>
                                                    <div style={{ color: 'var(--text-primary)', fontWeight: '600', marginBottom: '0.25rem' }}>
                                                        ðŸ”„ Merge (recommended for historical data)
                                                    </div>
                                                    <div style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>
                                                        Adds new jobs and companies without deleting existing data. Skips duplicates based on company + role + date.
                                                    </div>
                                                </div>
                                            </label>

                                            <label style={{
                                                display: 'flex',
                                                alignItems: 'flex-start',
                                                cursor: 'pointer',
                                                padding: '0.75rem',
                                                background: importMode === 'replace' ? 'var(--bg-hover)' : 'transparent',
                                                borderRadius: '6px',
                                                border: `1px solid ${importMode === 'replace' ? 'var(--accent-primary)' : 'var(--border-primary)'}`
                                            }}>
                                                <input
                                                    type="radio"
                                                    name="importMode"
                                                    value="replace"
                                                    checked={importMode === 'replace'}
                                                    onChange={(e) => setImportMode(e.target.value)}
                                                    style={{ marginRight: '0.75rem', marginTop: '0.25rem' }}
                                                />
                                                <div>
                                                    <div style={{ color: 'var(--text-primary)', fontWeight: '600', marginBottom: '0.25rem' }}>
                                                        âš ï¸ Replace all
                                                    </div>
                                                    <div style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>
                                                        Deletes all current data and replaces with backup. Use when restoring from backup.
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <button
                                        className="btn btn-secondary"
                                        onClick={() => { setPreview(null); setSelectedFile(null); setFileContent(null); }}
                                        style={{ width: '100%' }}
                                    >
                                        â† Choose different file
                                    </button>
                                </>
                            )}
                        </div>
                        <div className="modal-footer">
                            <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            {preview && (
                                <button type="button" className="btn" onClick={handleImport}>
                                    {importMode === 'merge' ? 'ðŸ”„ Merge data' : 'âš ï¸ Replace all data'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Company Modal Component
        function CompanyModal({ onSave, onClose, existingCategories }) {
            const [formData, setFormData] = useState({
                name: "",
                url: "",
                category: existingCategories[0] || "",
                newCategory: ""
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                try {
                    const category = formData.newCategory.trim() || formData.category;
                    if (!category || !formData.name.trim() || !formData.url.trim()) {
                        alert("Please fill in all required fields");
                        return;
                    }
                    onSave({
                        name: formData.name.trim(),
                        url: formData.url.trim(),
                        category: category.trim()
                    });
                } catch (error) {
                    console.error("Error submitting company:", error);
                    alert("Error saving company. Please try again.");
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Add company</h2>
                            <button className="modal-close" onClick={onClose}>Ã—</button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                <div className="form-group">
                                    <label>Company name *</label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.name}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        placeholder="e.g., Acme Corp"
                                    />
                                </div>

                                <div className="form-group">
                                    <label>Careers page URL *</label>
                                    <input
                                        type="url"
                                        required
                                        value={formData.url}
                                        onChange={(e) => setFormData({ ...formData, url: e.target.value })}
                                        placeholder="https://company.com/careers/jobs"
                                    />
                                </div>

                                <div className="form-group">
                                    <label>Category *</label>
                                    <select
                                        value={formData.category}
                                        onChange={(e) => setFormData({ ...formData, category: e.target.value, newCategory: "" })}
                                        required={!formData.newCategory}
                                    >
                                        {existingCategories.map(cat => (
                                            <option key={cat} value={cat}>{cat}</option>
                                        ))}
                                        <option value="">Create new category</option>
                                    </select>
                                </div>

                                {formData.category === "" && (
                                    <div className="form-group">
                                        <label>New category name *</label>
                                        <input
                                            type="text"
                                            required={formData.category === ""}
                                            value={formData.newCategory}
                                            onChange={(e) => setFormData({ ...formData, newCategory: e.target.value })}
                                            placeholder="e.g., SaaS Platforms"
                                        />
                                    </div>
                                )}
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn">Add company</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Status Badge Component
        function StatusBadge({ status }) {
            if (!status) {
                console.warn("StatusBadge received undefined status");
                return <span className="status-badge status-not-applied">Unknown</span>;
            }
            const className = `status-badge status-${status.toLowerCase().replace(/\s+/g, "-")}`;
            return <span className={className}>{status}</span>;
        }

        // Priority Badge Component
        function PriorityBadge({ priority }) {
            if (!priority) {
                console.warn("PriorityBadge received undefined priority");
                return <span className="priority-badge priority-tier2">No priority</span>;
            }
            const className = `priority-badge priority-${priority.toLowerCase().replace(/\s+/g, "")}`;
            return <span className={className}>{priority}</span>;
        }

        // Render App
        ReactDOM.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>,
            document.getElementById("root")
        );
    </script>
</body>

</html>