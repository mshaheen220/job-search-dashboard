<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Search Dashboard - Jill Shaheen</title>

    <!-- 1. React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    
    <!-- 2. React DOM -->
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Chart.js (replaces Recharts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts - Professional Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --bg-elevated: #ffffff;
            --bg-hover: #f8f8f8;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-primary: #e5e5e5;
            --border-secondary: #f0f0f0;
            --accent-primary: #2563eb;
            --accent-secondary: #3b82f6;
            --accent-hover: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.12);
        }

        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1a1a1a;
            --bg-elevated: #1f1f1f;
            --bg-hover: #242424;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --text-tertiary: #737373;
            --border-primary: #2a2a2a;
            --border-secondary: #1f1f1f;
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --accent-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .app {
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border-primary);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .logo {
            font-family: 'Bricolage Grotesque', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: scale(1.05);
        }

        .nav {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.25rem;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: 'DM Sans', sans-serif;
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card, .chart-card {
            background: var(--bg-secondary);
            padding: 1.75rem;
            margin-bottom: 30px;
            border-radius: 16px;
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card h3, .chart-card h3 {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .stat-card .value, .chart-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'Bricolage Grotesque', sans-serif;
            line-height: 1.2;
        }

        .stat-card .subtext, .chart-card .subtext {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
        }

        /* Lighter background for stat-cards in light mode */
        [data-theme="light"] .stat-card {
            background: #ffffff;
        }

        /* Chart layout styles */
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .chart-large {
            width: 100%;
        }

        .chart-medium {
            width: 100%;
        }

        .chart-medium canvas {
            min-height: 300px;
        }

        /* Stack on mobile */
        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-select, .search-input {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            padding: 0.6rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s ease;
        }

        .filter-select:focus, .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-input {
            min-width: 200px;
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            font-family: 'DM Sans', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .table-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-primary);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border-primary);
        }

        .table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-secondary);
            color: var(--text-primary);
        }

        .table tbody tr {
            transition: background 0.2s;
        }

        .table tbody tr:hover {
            background: var(--bg-hover);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-not-applied { background: #f3f4f6; color: #6b7280; }
        [data-theme="dark"] .status-not-applied { background: #374151; color: #9ca3af; }
        
        .status-applied { background: #dbeafe; color: #1e40af; }
        [data-theme="dark"] .status-applied { background: #1e3a8a; color: #93c5fd; }
        
        /* In Progress - Vibrant and eye-catching for important opportunities */
        .status-in-progress { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
            color: #78350f;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3);
        }
        [data-theme="dark"] .status-in-progress { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fef3c7;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.4);
        }
        
        .status-recruiter-contact { background: #ede9fe; color: #6b21a8; }
        [data-theme="dark"] .status-recruiter-contact { background: #7c3aed; color: #c4b5fd; }
        
        .status-phone-screen { background: #cffafe; color: #0e7490; }
        [data-theme="dark"] .status-phone-screen { background: #0891b2; color: #a5f3fc; }
        
        .status-interview-loop { background: #d1fae5; color: #065f46; }
        [data-theme="dark"] .status-interview-loop { background: #059669; color: #6ee7b7; }
        
        .status-final-round { background: #fed7aa; color: #9a3412; }
        [data-theme="dark"] .status-final-round { background: #ea580c; color: #fed7aa; }
        
        .status-offer { background: #d1fae5; color: #065f46; }
        [data-theme="dark"] .status-offer { background: #16a34a; color: #86efac; }
        
        .status-declined-offer { background: #e0e7ff; color: #3730a3; }
        [data-theme="dark"] .status-declined-offer { background: #4338ca; color: #a5b4fc; }
        
        .status-declined-\(withdrew\) { background: #e0e7ff; color: #4338ca; }
        [data-theme="dark"] .status-declined-\(withdrew\) { background: #6366f1; color: #c7d2fe; }
        
        .status-rejected { background: #fee2e2; color: #991b1b; }
        [data-theme="dark"] .status-rejected { background: #7f1d1d; color: #fca5a5; }
        
        .status-ghosted { background: #f5f5f4; color: #57534e; }
        [data-theme="dark"] .status-ghosted { background: #44403c; color: #a8a29e; }

        .priority-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .priority-tier1 { background: #fecaca; color: #991b1b; }
        [data-theme="dark"] .priority-tier1 { background: #991b1b; color: #fca5a5; }
        
        .priority-tier2 { background: #fed7aa; color: #9a3412; }
        [data-theme="dark"] .priority-tier2 { background: #ea580c; color: #fed7aa; }
        
        .priority-tier3 { background: #fef3c7; color: #78350f; }
        [data-theme="dark"] .priority-tier3 { background: #854d0e; color: #fcd34d; }

        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .company-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .company-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .company-card h3 {
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .company-card .category {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .company-card .actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .modal-close {
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--danger);
        }

        .modal-body {
            padding: 1.5rem 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-primary);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-tertiary);
        }

        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .link {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .link:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .main {
                padding: 1rem;
            }

            .table-container {
                overflow-x: auto;
            }

            .table {
                min-width: 800px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .company-grid {
                grid-template-columns: 1fr;
            }
        }

        .search-container {
    position: relative;
    flex: 1;
}
    .clear-search {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6b8aff;
        font-size: 1.5rem;
        cursor: pointer;
    }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    window.analytics = (() => {

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        const parseDate = (dateString) => {
        if (!dateString) return null;
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? null : date;
        };

        const getWeekNumber = (date) => {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };

        const getMonthYear = (date) => {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        };

        const getWeekYear = (date) => {
        const week = getWeekNumber(date);
        return `${date.getFullYear()}-W${String(week).padStart(2, '0')}`;
        };

        const filterByDateRange = (jobs, startDate, endDate) => {
        return jobs.filter(job => {
            const appliedDate = parseDate(job.dateApplied);
            if (!appliedDate) return false;
            if (startDate && appliedDate < startDate) return false;
            if (endDate && appliedDate > endDate) return false;
            return true;
        });
        };

        // ============================================
        // CORE METRICS CALCULATIONS
        // ============================================

        const getTotalApplications = (jobs) => {
        return jobs.filter(job => job.dateApplied).length;
        };

        const getApplicationsByTimeWindow = (jobs) => {
        const now = new Date();
        
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay());
        startOfWeek.setHours(0, 0, 0, 0);
        
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
        
        return {
            today: filterByDateRange(jobs, startOfToday, null).length,
            thisWeek: filterByDateRange(jobs, startOfWeek, null).length,
            thisMonth: filterByDateRange(jobs, startOfMonth, null).length,
            lastMonth: filterByDateRange(jobs, startOfLastMonth, endOfLastMonth).length,
            total: getTotalApplications(jobs)
        };
        };

        const getResponseRate = (jobs) => {
        const applicationsWithDate = jobs.filter(job => job.dateApplied);
        const total = applicationsWithDate.length;
        
        if (total === 0) return { 
            count: 0, 
            percentage: 0, 
            total,
            waiting: 0
        };
        
        const responded = applicationsWithDate.filter(job => {
            /* Count as response if status is "In Progress" */
            if (job.status === "In Progress") return true;
            
            /* Count as response if progression moved beyond "Application" */
            const prog = job.progression || "Application";
            if (prog !== "Application") return true;
            
            /* Count as response if closed due to withdrawal (you withdrew after engagement) */
            if (job.status === "Closed" && job.closeReason === "Withdrew") return true;
            
            return false;
        });
        
        const waiting = applicationsWithDate.filter(job => {
            return job.status === "Applied" && (job.progression || "Application") === "Application";
        });
        
        return {
            count: responded.length,
            percentage: Math.round((responded.length / total) * 100),
            total,
            waiting: waiting.length
        };
        };

        const getWaitingStatus = (jobs) => {
        const waiting = jobs.filter(job => 
            job.status === "Applied" && 
            (job.progression || "Application") === "Application"
        );
        
        const now = new Date();
        const waitingByDuration = {
            "0-7 days": 0,
            "8-14 days": 0,
            "15-30 days": 0,
            "31-60 days": 0,
            "60+ days": 0
        };
        
        waiting.forEach(job => {
            if (!job.dateApplied) return;
            
            const appliedDate = new Date(job.dateApplied);
            const daysWaiting = Math.floor((now - appliedDate) / (1000 * 60 * 60 * 24));
            
            if (daysWaiting <= 7) {
            waitingByDuration["0-7 days"]++;
            } else if (daysWaiting <= 14) {
            waitingByDuration["8-14 days"]++;
            } else if (daysWaiting <= 30) {
            waitingByDuration["15-30 days"]++;
            } else if (daysWaiting <= 60) {
            waitingByDuration["31-60 days"]++;
            } else {
            waitingByDuration["60+ days"]++;
            }
        });
        
        return {
            total: waiting.length,
            byDuration: waitingByDuration,
            jobs: waiting
        };
        };

        const getInterviewConversionRate = (jobs) => {
        const applicationsWithDate = jobs.filter(job => job.dateApplied);
        const total = applicationsWithDate.length;
        
        if (total === 0) return { count: 0, percentage: 0, total };
        
        const interviewStages = ["Recruiter Screen", "Partial Loop", "Full Loop", "Offer"];
        const interviewed = applicationsWithDate.filter(job => 
            interviewStages.includes(job.progression)
        );
        
        return {
            count: interviewed.length,
            percentage: Math.round((interviewed.length / total) * 100),
            total
        };
        };

        const getOfferRate = (jobs) => {
        const applicationsWithDate = jobs.filter(job => job.dateApplied);
        const total = applicationsWithDate.length;
        
        if (total === 0) return { count: 0, percentage: 0, total };
        
        const offers = applicationsWithDate.filter(job => job.progression === "Offer");
        
        return {
            count: offers.length,
            percentage: Math.round((offers.length / total) * 100),
            total
        };
        };

        const getPipelineStatus = (jobs) => {
        const activePipeline = jobs.filter(job => 
            job.status === "Applied" || job.status === "In Progress"
        );
        
        const byStage = {
            "Application": 0,
            "Recruiter Screen": 0,
            "Partial Loop": 0,
            "Full Loop": 0,
            "Offer": 0
        };
        
        const byStatus = {
            "Applied": 0,
            "In Progress": 0
        };
        
        activePipeline.forEach(job => {
            const stage = job.progression || "Application";
            if (byStage.hasOwnProperty(stage)) {
            byStage[stage]++;
            }
            
            if (job.status === "Applied") {
            byStatus["Applied"]++;
            } else if (job.status === "In Progress") {
            byStatus["In Progress"]++;
            }
        });
        
        return {
            total: activePipeline.length,
            byStage,
            byStatus,
            jobs: activePipeline
        };
        };

        const getClosureReasons = (jobs) => {
        const closed = jobs.filter(job => job.status === "Closed");
        
        const counts = {
            "Rejected": 0,
            "Ghosted": 0,
            "Withdrew": 0,
            "Unknown": 0
        };
        
        closed.forEach(job => {
            const reason = job.closeReason || "Unknown";
            if (counts.hasOwnProperty(reason)) {
            counts[reason]++;
            } else {
            counts["Unknown"]++;
            }
        });
        
        return {
            total: closed.length,
            counts
        };
        };

        const getRejectionRate = (jobs) => {
        const closed = jobs.filter(job => job.status === "Closed");
        const total = closed.length;
        
        if (total === 0) return { count: 0, percentage: 0, total };
        
        const rejected = closed.filter(job => job.closeReason === "Rejected");
        
        return {
            count: rejected.length,
            percentage: Math.round((rejected.length / total) * 100),
            total
        };
        };

        const getClosedProgressionBreakdown = (jobs) => {
        const closed = jobs.filter(job => job.status === "Closed");
        
        const byProgression = {
            "Application": 0,
            "Recruiter Screen": 0,
            "Partial Loop": 0,
            "Full Loop": 0,
            "Offer": 0
        };
        
        closed.forEach(job => {
            const prog = job.progression || "Application";
            if (byProgression.hasOwnProperty(prog)) {
            byProgression[prog]++;
            }
        });
        
        return {
            total: closed.length,
            byProgression
        };
        };

        const getApplicationsPerWeek = (jobs) => {
        const jobsWithDates = jobs.filter(job => job.dateApplied);
        
        const weekMap = {};
        
        jobsWithDates.forEach(job => {
            const date = parseDate(job.dateApplied);
            if (!date) return;
            
            const weekKey = getWeekYear(date);
            weekMap[weekKey] = (weekMap[weekKey] || 0) + 1;
        });
        
        const weeks = Object.entries(weekMap)
            .map(([week, count]) => ({ week, count }))
            .sort((a, b) => a.week.localeCompare(b.week));
        
        const totalWeeks = weeks.length;
        const totalApps = weeks.reduce((sum, w) => sum + w.count, 0);
        const average = totalWeeks > 0 ? Math.round(totalApps / totalWeeks) : 0;
        
        return {
            byWeek: weeks,
            average,
            total: totalApps
        };
        };

        const getApplicationsPerMonth = (jobs) => {
        const jobsWithDates = jobs.filter(job => job.dateApplied);
        
        const monthMap = {};
        
        jobsWithDates.forEach(job => {
            const date = parseDate(job.dateApplied);
            if (!date) return;
            
            const monthKey = getMonthYear(date);
            monthMap[monthKey] = (monthMap[monthKey] || 0) + 1;
        });
        
        const months = Object.entries(monthMap)
            .map(([month, count]) => {
            const [year, monthNum] = month.split('-');
            const date = new Date(parseInt(year), parseInt(monthNum) - 1);
            const label = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            return { month, label, count };
            })
            .sort((a, b) => a.month.localeCompare(b.month));
        
        const totalMonths = months.length;
        const totalApps = months.reduce((sum, m) => sum + m.count, 0);
        const average = totalMonths > 0 ? Math.round(totalApps / totalMonths) : 0;
        
        return {
            byMonth: months,
            average,
            total: totalApps
        };
        };

        const getResponseRateByMonth = (jobs) => {
        // Count follow-ups by the `followUp` date field. "responded" here means
        // the job has a followUp date in the month AND `progression` is not "Application".
        const monthMap = {};

        jobs.forEach(job => {
            if (!job.followUp) return;
            const date = parseDate(job.followUp);
            if (!date) return;

            const monthKey = getMonthYear(date);
            if (!monthMap[monthKey]) {
                monthMap[monthKey] = { followUps: 0, responded: 0 };
            }

            monthMap[monthKey].followUps++;
            if (job.progression && job.progression !== "Application") {
                monthMap[monthKey].responded++;
            }
        });

        const months = Object.entries(monthMap)
            .map(([month, data]) => {
                const [year, monthNum] = month.split('-');
                const date = new Date(parseInt(year), parseInt(monthNum) - 1);
                const label = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                const responsePercentage = data.followUps > 0 ? Math.round((data.responded / data.followUps) * 100) : 0;

                return {
                    month,
                    label,
                    followUps: data.followUps,
                    responded: data.responded,
                    responsePercentage
                };
            })
            .sort((a, b) => a.month.localeCompare(b.month));

        return months;
        };

        const getHotApplicationPeriods = (jobs) => {
        const monthlyData = getApplicationsPerMonth(jobs);
        const hotThreshold = monthlyData.average * 1.25;
        
        const hotPeriods = monthlyData.byMonth
            .filter(item => item.count >= hotThreshold)
            .map(item => ({
            period: item.label,
            applications: item.count,
            vsAverage: Math.round(((item.count - monthlyData.average) / monthlyData.average) * 100)
            }));
        
        return {
            hotPeriods,
            threshold: Math.round(hotThreshold),
            average: monthlyData.average
        };
        };

        const getHotResponsePeriods = (jobs) => {
        const monthlyResponses = getResponseRateByMonth(jobs);
        
        const totalApps = monthlyResponses.reduce((sum, item) => sum + item.total, 0);
        const totalResponses = monthlyResponses.reduce((sum, item) => sum + item.responded, 0);
        const overallAverage = totalApps > 0 ? (totalResponses / totalApps) * 100 : 0;
        
        const hotThreshold = overallAverage * 1.25;
        
        const hotPeriods = monthlyResponses
            .filter(item => item.percentage >= hotThreshold && item.total >= 3)
            .map(item => ({
            period: item.label,
            responseRate: item.percentage,
            applications: item.total,
            responses: item.responded
            }));
        
        return {
            hotPeriods,
            threshold: Math.round(hotThreshold),
            average: Math.round(overallAverage)
        };
        };

        const getApplicationsByCompany = (jobs) => {
        const jobsWithDates = jobs.filter(job => job.dateApplied);
        
        const companyData = {};
        
        jobsWithDates.forEach(job => {
            const company = job.company || "Unknown";
            
            if (!companyData[company]) {
            companyData[company] = {
                total: 0,
                applied: 0,
                inProgress: 0,
                closed: 0,
                responded: 0,
                rejected: 0,
                offers: 0
            };
            }
            
            companyData[company].total++;
            
            if (job.status === "Applied") {
            companyData[company].applied++;
            } else if (job.status === "In Progress") {
            companyData[company].inProgress++;
            } else if (job.status === "Closed") {
            companyData[company].closed++;
            }
            
            const prog = job.progression || "Application";
            if (job.status === "In Progress" || prog !== "Application") {
            companyData[company].responded++;
            }
            
            if (job.closeReason === "Rejected") {
            companyData[company].rejected++;
            }
            
            if (prog === "Offer") {
            companyData[company].offers++;
            }
        });
        
        const companies = Object.entries(companyData)
            .map(([name, data]) => ({
            name,
            ...data,
            responseRate: data.total > 0 
                ? Math.round((data.responded / data.total) * 100) 
                : 0
            }))
            .sort((a, b) => b.total - a.total);
        
        return companies;
        };

        const getSuccessRateByPriority = (jobs) => {
        const jobsWithDates = jobs.filter(job => job.dateApplied);
        
        const priorityData = {
            "Tier 1": { total: 0, responded: 0, interviewed: 0, offers: 0 },
            "Tier 2": { total: 0, responded: 0, interviewed: 0, offers: 0 },
            "Tier 3": { total: 0, responded: 0, interviewed: 0, offers: 0 }
        };
        
        const interviewStages = ["Recruiter Screen", "Partial Loop", "Full Loop", "Offer"];
        
        jobsWithDates.forEach(job => {
            const tier = job.priority || "Tier 3";
            
            if (priorityData[tier]) {
            priorityData[tier].total++;
            
            if (job.status === "In Progress" || (job.progression && job.progression !== "Application")) {
                priorityData[tier].responded++;
            }
            
            if (job.progression && interviewStages.includes(job.progression)) {
                priorityData[tier].interviewed++;
            }
            
            if (job.progression === "Offer") {
                priorityData[tier].offers++;
            }
            }
        });
        
        const result = Object.entries(priorityData).map(([tier, data]) => {
            const responseRate = data.total > 0 ? Math.round((data.responded / data.total) * 100) : 0;
            const interviewRate = data.total > 0 ? Math.round((data.interviewed / data.total) * 100) : 0;
            const offerRate = data.total > 0 ? Math.round((data.offers / data.total) * 100) : 0;
            
            return {
            tier,
            total: data.total,
            responded: data.responded,
            interviewed: data.interviewed,
            offers: data.offers,
            responseRate,
            interviewRate,
            offerRate
            };
        });
        
        return result;
        };

        const getMostResponsiveCompanies = (jobs, minApplications = 2) => {
        const companies = getApplicationsByCompany(jobs);
        
        return companies
            .filter(company => company.total >= minApplications)
            .sort((a, b) => b.responseRate - a.responseRate)
            .slice(0, 10);
        };

        const getProgressionBreakdownForResponded = (jobs) => {
        const responded = jobs.filter(job => 
            job.progression && job.progression !== "Application"
        );
        
        const byProgression = {
            "Recruiter Screen": 0,
            "Partial Loop": 0,
            "Full Loop": 0,
            "Offer": 0
        };
        
        responded.forEach(job => {
            const prog = job.progression || "Application";
            if (byProgression.hasOwnProperty(prog)) {
                byProgression[prog]++;
            }
        });
        
        return Object.entries(byProgression)
            .filter(([_, count]) => count > 0)
            .map(([stage, count]) => ({
                label: stage,
                value: count
            }));
        };

        const getJobSearchOverview = (jobs) => {
        return {
            totalApplications: getTotalApplications(jobs),
            byTimeWindow: getApplicationsByTimeWindow(jobs),
            responseRate: getResponseRate(jobs),
            interviewConversionRate: getInterviewConversionRate(jobs),
            offerRate: getOfferRate(jobs),
            pipeline: getPipelineStatus(jobs),
            waiting: getWaitingStatus(jobs),
            closureReasons: getClosureReasons(jobs),
            rejectionRate: getRejectionRate(jobs),
            closedProgression: getClosedProgressionBreakdown(jobs)
        };
        };

        const getTimeBasedAnalytics = (jobs) => {
        return {
            applicationsPerWeek: getApplicationsPerWeek(jobs),
            applicationsPerMonth: getApplicationsPerMonth(jobs),
            responseRateByMonth: getResponseRateByMonth(jobs),
            hotApplicationPeriods: getHotApplicationPeriods(jobs),
            hotResponsePeriods: getHotResponsePeriods(jobs)
        };
        };

        const getCompanyPriorityAnalytics = (jobs) => {
        return {
            applicationsByCompany: getApplicationsByCompany(jobs),
            successRateByPriority: getSuccessRateByPriority(jobs),
            mostResponsiveCompanies: getMostResponsiveCompanies(jobs)
        };
        };

        const getCompleteAnalytics = (jobs) => {
        return {
            overview: getJobSearchOverview(jobs),
            timeBased: getTimeBasedAnalytics(jobs),
            companyPriority: getCompanyPriorityAnalytics(jobs),
            generatedAt: new Date().toISOString()
        };
        };

        /* Return all functions as a single object */
        return {
        getTotalApplications,
        getApplicationsByTimeWindow,
        getResponseRate,
        getWaitingStatus,
        getInterviewConversionRate,
        getOfferRate,
        getPipelineStatus,
        getClosureReasons,
        getRejectionRate,
        getClosedProgressionBreakdown,
        getApplicationsPerWeek,
        getApplicationsPerMonth,
        getResponseRateByMonth,
        getHotApplicationPeriods,
        getHotResponsePeriods,
        getApplicationsByCompany,
        getSuccessRateByPriority,
        getMostResponsiveCompanies,
        getProgressionBreakdownForResponded,
        getJobSearchOverview,
        getTimeBasedAnalytics,
        getCompanyPriorityAnalytics,
        getCompleteAnalytics
        };

        })(); /* End of analytics object */
        </script>

    <script type="text/babel">
        /* ===========================================
        CHART WRAPPER - Canvas-based charts
        =========================================== */

        const ChartCard = ({ title, children }) => {
        return (
            <div className="chart-card">
            <h3>{title}</h3>
            <div className="chart-content">
                {children}
            </div>
            </div>
        );
        };

        /* ===========================================
        CHART COMPONENTS using Chart.js
        =========================================== */

        const DualLineChartComponent = ({ data, label1, label2, color1 = '#6b8aff', color2 = '#10b981', isPercentage = false }) => {
        const { useEffect, useRef } = React;
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
            if (!canvasRef.current) return;

            // Destroy previous chart
            if (chartRef.current) {
            chartRef.current.destroy();
            }

            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.label),
                datasets: [
                {
                    label: label1,
                    data: data.map(d => d.value1),
                    borderColor: color1 + '60',  // Fainter (60% opacity)
                    backgroundColor: color1 + '10',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: color1 + '60'
                },
                {
                    label: label2,
                    data: data.map(d => d.value2),
                    borderColor: color2,  // Prominent (full opacity)
                    backgroundColor: color2 + '20',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: color2
                }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                mode: 'index',
                intersect: false
                },
                plugins: {
                legend: {
                    labels: { 
                    color: '#9ca3af',
                    usePointStyle: true,
                    padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                    label: function(context) {
                        const value = context.parsed.y;
                        return context.dataset.label + ': ' + value + (isPercentage ? '%' : '');
                    }
                    }
                }
                },
                scales: {
                y: {
                    beginAtZero: true,
                    max: isPercentage ? 100 : undefined,
                    ticks: { 
                    color: '#9ca3af',
                    stepSize: isPercentage ? undefined : 1,
                    callback: (value) => value + (isPercentage ? '%' : '')
                    },
                    grid: { color: '#2a3248' }
                },
                x: {
                    ticks: { color: '#9ca3af' },
                    grid: { color: '#2a3248' }
                }
                }
            }
            });

            return () => {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            };
        }, [data, label1, label2, color1, color2, isPercentage]);

        return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        const TripleLineChartComponent = ({ data, label1, label2, label3, color1 = '#6b8aff', color2 = '#f59e0b', color3 = '#10b981', isPercentage = false }) => {
            const { useEffect, useRef } = React;
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                const ctx = canvasRef.current.getContext('2d');

                const labels = data.map(d => d.label);
                const dataset1 = data.map(d => d.value1 ?? d.applications ?? 0);
                const dataset2 = data.map(d => d.value2 ?? d.followUps ?? 0);
                const dataset3 = data.map(d => d.value3 ?? d.responded ?? 0);

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: label1,
                                data: dataset1,
                                borderColor: color1,
                                backgroundColor: color1 + '33',
                                fill: false,
                                tension: 0.2,
                                pointRadius: 2
                            },
                            {
                                label: label2,
                                data: dataset2,
                                borderColor: color2,
                                backgroundColor: color2 + '33',
                                fill: false,
                                tension: 0.2,
                                pointRadius: 2
                            },
                            {
                                label: label3,
                                data: dataset3,
                                borderColor: color3,
                                backgroundColor: color3 + '33',
                                fill: false,
                                tension: 0.2,
                                pointRadius: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        stacked: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return isPercentage ? value + '%' : value;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) chartRef.current.destroy();
                };
            }, [data, label1, label2, label3, color1, color2, color3, isPercentage]);

            return <canvas ref={canvasRef} style={{ maxHeight: '360px' }}></canvas>;
        };

        const LineChartComponent = ({ data, label, color = '#6b8aff' }) => {
        const { useEffect, useRef } = React;
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
            if (!canvasRef.current) return;

            // Destroy previous chart
            if (chartRef.current) {
            chartRef.current.destroy();
            }

            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.label),
                datasets: [{
                label: label,
                data: data.map(d => d.value),
                borderColor: color,
                backgroundColor: color + '20',
                tension: 0.4,
                fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    labels: { color: '#9ca3af' }
                }
                },
                scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#9ca3af' },
                    grid: { color: '#2a3248' }
                },
                x: {
                    ticks: { color: '#9ca3af' },
                    grid: { color: '#2a3248' }
                }
                }
            }
            });

            return () => {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            };
        }, [data, label, color]);

        return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        const BarChartComponent = ({ data, color = '#6b8aff' }) => {
        const { useEffect, useRef } = React;
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
            if (!canvasRef.current) return;

            if (chartRef.current) {
            chartRef.current.destroy();
            }

            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.label),
                datasets: [{
                label: 'Count',
                data: data.map(d => d.value),
                backgroundColor: color,
                borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: { display: false }
                },
                scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#9ca3af', stepSize: 1 },
                    grid: { color: '#2a3248' }
                },
                x: {
                    ticks: { color: '#9ca3af' },
                    grid: { display: false }
                }
                }
            }
            });

            return () => {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            };
        }, [data, color]);

        return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        const PieChartComponent = ({ data }) => {
        const { useEffect, useRef } = React;
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
            if (!canvasRef.current) return;

            if (chartRef.current) {
            chartRef.current.destroy();
            }

            const colors = ['#6b8aff', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(d => d.label),
                datasets: [{
                data: data.map(d => d.value),
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 2,
                borderColor: '#0a0e1a'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    position: 'right',
                    labels: { color: '#9ca3af', padding: 15 }
                }
                }
            }
            });

            return () => {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            };
        }, [data]);

        return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        const FunnelChartComponent = ({ data }) => {
        const { useEffect, useRef } = React;
        const containerRef = useRef(null);

        useEffect(() => {
            if (!containerRef.current || !data || data.length === 0) return;

            // Sort data in funnel order
            const funnelOrder = ['Application', 'Recruiter Screen', 'Partial Loop', 'Full Loop', 'Offer'];
            const sortedData = funnelOrder
            .map(stage => data.find(d => d.label === stage))
            .filter(item => item && item.value > 0);

            if (sortedData.length === 0) return;

            // Calculate total for percentage calculations
            const totalValue = sortedData.reduce((sum, item) => sum + item.value, 0) || 1;

            // Clear previous content
            containerRef.current.innerHTML = '';

            // Colors matching dashboard theme
            const colors = ['#6b8aff', '#8b5cf6', '#f59e0b', '#10b981', '#34d399'];

            // Create funnel container
            const funnel = document.createElement('div');
            funnel.style.cssText = 'display: flex; flex-direction: column; gap: 20px; width: 100%; padding: 20px 0;';

            sortedData.forEach((item, index) => {
            // Calculate width percentage for bar (relative to total)
            const barWidthPercent = (item.value / totalValue) * 100;
            // Calculate percentage (relative to total)
            const percent = ((item.value / totalValue) * 100).toFixed(1);

            // Create row container
            const row = document.createElement('div');
            row.style.cssText = 'display: flex; align-items: center; gap: 16px;';

            // Create circle with percentage
            const circle = document.createElement('div');
            const circleSize = Math.max(60, 80 - index * 8); // Circles get slightly smaller
            circle.style.cssText = `
                width: ${circleSize}px;
                height: ${circleSize}px;
                border-radius: 50%;
                background-color: ${colors[index % colors.length]};
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                font-weight: 700;
                font-size: 18px;
                color: white;
            `;
            circle.textContent = `${percent}%`;

            // Create bar section
            const barSection = document.createElement('div');
            barSection.style.cssText = 'flex: 1; display: flex; flex-direction: column; gap: 6px;';

            // Create bar
            const bar = document.createElement('div');
            bar.style.cssText = `
                height: 32px;
                background-color: ${colors[index % colors.length]};
                border-radius: 4px;
                width: ${Math.max(barWidthPercent, 15)}%;
                min-width: 60px;
                transition: all 0.2s;
                cursor: pointer;
            `;
            
            bar.addEventListener('mouseenter', () => {
                bar.style.opacity = '0.8';
                bar.style.transform = 'scaleX(1.05)';
                bar.style.transformOrigin = 'left';
            });
            bar.addEventListener('mouseleave', () => {
                bar.style.opacity = '1';
                bar.style.transform = 'scaleX(1)';
            });

            // Create label and count container
            const labelCount = document.createElement('div');
            labelCount.style.cssText = 'display: flex; gap: 8px; font-size: 12px; color: var(--text-tertiary);';
            
            const label = document.createElement('span');
            label.textContent = item.label;
            label.style.cssText = 'font-weight: 600; color: var(--text-secondary);';
            
            const count = document.createElement('span');
            count.textContent = item.value.toLocaleString();

            labelCount.appendChild(label);
            labelCount.appendChild(count);

            barSection.appendChild(bar);
            barSection.appendChild(labelCount);

            row.appendChild(circle);
            row.appendChild(barSection);

            funnel.appendChild(row);
            });

            containerRef.current.appendChild(funnel);
        }, [data]);

        return <div ref={containerRef} style={{ width: '100%', minHeight: '300px' }}></div>;
        };

        const GroupedBarChartComponent = ({ data }) => {
        const { useEffect, useRef } = React;
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
            if (!canvasRef.current) return;

            if (chartRef.current) {
            chartRef.current.destroy();
            }

            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                {
                    label: 'Callback Rate',
                    data: data.responseRates,
                    backgroundColor: '#6b8aff'
                },
                {
                    label: 'Interview Rate',
                    data: data.interviewRates,
                    backgroundColor: '#10b981'
                }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    labels: { color: '#9ca3af' }
                }
                },
                scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { 
                    color: '#9ca3af',
                    callback: (value) => value + '%'
                    },
                    grid: { color: '#2a3248' }
                },
                x: {
                    ticks: { color: '#9ca3af' },
                    grid: { display: false }
                }
                }
            }
            });

            return () => {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            };
        }, [data]);

        return <canvas ref={canvasRef} style={{ maxHeight: '300px' }}></canvas>;
        };

        /* ===========================================
        KEY METRICS GRID
        =========================================== */

        const KeyMetricsGrid = ({ metrics }) => {
        return (
            <div className="metrics-grid" style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
            gap: '1rem',
            marginBottom: '2rem'
            }}>
            <div className="stat-card">
                <div className="stat-label" style={{ 
                fontSize: '0.85rem', 
                color: 'var(--text-tertiary)',
                marginBottom: '0.5rem'
                }}>Total Applications</div>
                <div className="stat-value" style={{ 
                fontSize: '2rem', 
                fontWeight: 'bold',
                color: 'var(--text-primary)',
                marginBottom: '0.25rem'
                }}>{metrics.totalApplications}</div>
                <div className="stat-detail" style={{ 
                fontSize: '0.8rem', 
                color: 'var(--text-tertiary)'
                }}>
                {metrics.byTimeWindow.thisMonth} this month
                </div>
            </div>

            <div className="stat-card">
                <div className="stat-label" style={{ 
                fontSize: '0.85rem', 
                color: 'var(--text-tertiary)',
                marginBottom: '0.5rem'
                }}>Callback Rate</div>
                <div className="stat-value" style={{ 
                fontSize: '2rem', 
                fontWeight: 'bold',
                color: 'var(--success)',
                marginBottom: '0.25rem'
                }}>{metrics.responseRate.percentage}%</div>
                <div className="stat-detail" style={{ 
                fontSize: '0.8rem', 
                color: 'var(--text-tertiary)'
                }}>
                {metrics.responseRate.count} of {metrics.responseRate.total}
                </div>
            </div>

            <div className="stat-card">
                <div className="stat-label" style={{ 
                fontSize: '0.85rem', 
                color: 'var(--text-tertiary)',
                marginBottom: '0.5rem'
                }}>Interview Rate</div>
                <div className="stat-value" style={{ 
                fontSize: '2rem', 
                fontWeight: 'bold',
                color: 'var(--accent-primary)',
                marginBottom: '0.25rem'
                }}>{metrics.interviewConversionRate.percentage}%</div>
                <div className="stat-detail" style={{ 
                fontSize: '0.8rem', 
                color: 'var(--text-tertiary)'
                }}>
                {metrics.interviewConversionRate.count} reached interviews
                </div>
            </div>

            <div className="stat-card">
                <div className="stat-label" style={{ 
                fontSize: '0.85rem', 
                color: 'var(--text-tertiary)',
                marginBottom: '0.5rem'
                }}>Active Pipeline</div>
                <div className="stat-value" style={{ 
                fontSize: '2rem', 
                fontWeight: 'bold',
                color: 'var(--text-primary)',
                marginBottom: '0.25rem'
                }}>{metrics.pipeline.total}</div>
                <div className="stat-detail" style={{ 
                fontSize: '0.8rem', 
                color: 'var(--text-tertiary)'
                }}>
                {metrics.pipeline.byStatus.Applied} Idle  {metrics.pipeline.byStatus["In Progress"]} In Progress
                </div>
            </div>

            <div className="stat-card">
                <div className="stat-label" style={{ 
                fontSize: '0.85rem', 
                color: 'var(--text-tertiary)',
                marginBottom: '0.5rem'
                }}>Offers</div>
                <div className="stat-value" style={{ 
                fontSize: '2rem', 
                fontWeight: 'bold',
                color: 'var(--warning)',
                marginBottom: '0.25rem'
                }}>{metrics.offerRate.count}</div>
                <div className="stat-detail" style={{ 
                fontSize: '0.8rem', 
                color: 'var(--text-tertiary)'
                }}>
                {metrics.offerRate.percentage}% of applications
                </div>
            </div>

            <div className="stat-card">
                <div className="stat-label" style={{ 
                fontSize: '0.85rem', 
                color: 'var(--text-tertiary)',
                marginBottom: '0.5rem'
                }}>This Week</div>
                <div className="stat-value" style={{ 
                fontSize: '2rem', 
                fontWeight: 'bold',
                color: 'var(--text-primary)',
                marginBottom: '0.25rem'
                }}>{metrics.byTimeWindow.thisWeek}</div>
                <div className="stat-detail" style={{ 
                fontSize: '0.8rem', 
                color: 'var(--text-tertiary)'
                }}>
                applications submitted
                </div>
            </div>
            </div>
        );
        };

        /* ===========================================
        INSIGHTS PANEL
        =========================================== */

        const InsightsPanel = ({ insights }) => {
        if (!insights || insights.length === 0) return null;

        return (
            <div className="insights-panel">
            <h3>Insights & Recommendations</h3>
            <div className="insights-list">
                {insights.map((insight, index) => (
                <div key={index} className={`insight-item insight-${insight.type}`}>
                    <div className="insight-icon">
                    {insight.type === 'success' && ''}
                    {insight.type === 'warning' && ''}
                    {insight.type === 'info' && ''}
                    </div>
                    <div className="insight-content">
                    <div className="insight-title">{insight.title}</div>
                    <div className="insight-description">{insight.description}</div>
                    </div>
                </div>
                ))}
            </div>
            </div>
        );
        };

        /* ===========================================
        GENERATE INSIGHTS
        =========================================== */

        const generateInsights = (metrics, timeData, companyData) => {
        const insights = [];


        // Stale applications
        if (metrics.waiting.byDuration["60+ days"] > 0) {
            insights.push({
            type: 'warning',
            title: 'Stale Applications',
            description: `${metrics.waiting.byDuration["60+ days"]} applications have been waiting 60+ days. Consider following up or marking as closed.`
            });
        }

        
        // Most responsive companies
        const topCompanies = companyData.mostResponsiveCompanies.slice(0, 3);
        if (topCompanies.length > 0 && topCompanies[0].responseRate > 50) {
            insights.push({
            type: 'success',
            title: 'Responsive Companies',
            description: `${topCompanies[0].name} has a ${topCompanies[0].responseRate}% response rate from your ${topCompanies[0].total} applications. Consider applying to more roles there.`
            });
        }

        return insights;
        };

        /* ===========================================
        MAIN DASHBOARD COMPONENT
        =========================================== */

        const AnalyticsDashboard = ({ jobs }) => {
        const { useMemo } = React;

        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
            return (
            <div style={{ padding: '2rem', color: '#ef4444' }}>
                <h2>Chart.js library not loaded</h2>
                <p>Please ensure Chart.js CDN is included in the HTML head:</p>
                <code style={{ 
                display: 'block', 
                padding: '1rem', 
                background: '#1a1f35', 
                borderRadius: '6px',
                marginTop: '1rem',
                color: '#10b981'
                }}>
                &lt;script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"&gt;&lt;/script&gt;
                </code>
            </div>
            );
        }

        // Calculate all metrics
        const { overview, timeData, companyData, insights } = useMemo(() => {
            const overview = analytics.getJobSearchOverview(jobs);
            const timeData = analytics.getTimeBasedAnalytics(jobs);
            const companyData = analytics.getCompanyPriorityAnalytics(jobs);
            const insights = generateInsights(overview, timeData, companyData);

            return { overview, timeData, companyData, insights };
        }, [jobs]);

        // Prepare chart data
        const applicationsChartData = timeData.applicationsPerMonth.byMonth.map(item => ({
            label: item.label,
            value: item.count
        }));

        const responseRateChartData = timeData.responseRateByMonth.map(item => ({
            label: item.label,
            value1: item.followUps,    // Count of all follow-ups (fainter)
            value2: item.responded      // Count of actual responses (prominent)
        }));

        const pipelineChartData = (() => {
            const stages = ['Application', 'Recruiter Screen', 'Partial Loop', 'Full Loop', 'Offer'];
            const activeJobs = jobs.filter(j => j.status === 'In Progress' || j.status === 'Applied');
            return stages.map(stage => ({
                label: stage,
                value: activeJobs.filter(j => j.progression === stage).length
            }));
        })();

        const closureChartData = Object.entries(overview.closureReasons.counts)
            .filter(([_, count]) => count > 0)
            .map(([reason, count]) => ({
            label: reason,
            value: count
            }));

        const progressionChartData = analytics.getProgressionBreakdownForResponded(jobs);

        // Combine monthly applications and response activity into a single dataset
        // Use the UNION of months from applications and follow-ups so months with
        // follow-ups but no applications are included.
        const appsByMonth = {};
        (timeData.applicationsPerMonth.byMonth || []).forEach(item => {
            appsByMonth[item.month] = { label: item.label, applications: item.count };
        });

        const respByMonth = {};
        (timeData.responseRateByMonth || []).forEach(item => {
            respByMonth[item.month] = { label: item.label, followUps: item.followUps || 0, responded: item.responded || 0 };
        });

        const monthKeys = Array.from(new Set([...Object.keys(appsByMonth), ...Object.keys(respByMonth)])).sort();

        const combinedChartData = monthKeys.map(monthKey => {
            const app = appsByMonth[monthKey] || { label: (() => {
                const [y, m] = monthKey.split('-');
                return new Date(parseInt(y), parseInt(m) - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            })(), applications: 0 };
            const resp = respByMonth[monthKey] || { followUps: 0, responded: 0 };
            return {
                label: app.label,
                applications: app.applications,
                followUps: resp.followUps,
                responded: resp.responded
            };
        });

        return (
            <div className="analytics-dashboard">
            {/* Key Metrics */}
            <KeyMetricsGrid metrics={overview} />

            {/* Charts Grid */}
            <div className="charts-section">
                {/* Large Charts */}
                {/* Large Charts - Full Width */}
    <div className="chart-large">
        <ChartCard title="Applications & Response Activity">
            <TripleLineChartComponent
                data={combinedChartData}
                label1="Applications"
                label2="Responses and rejections"
                label3="Actual Callbacks"
                color1="#6b8aff"
                color2="#f59e0b"
                color3="#10b981"
            />
        </ChartCard>
    </div>

    {/* Medium Charts - Side by Side */}
    <div className="chart-row">
        <div className="chart-medium">
            <ChartCard title="Active Pipeline Status">
                <FunnelChartComponent 
                    data={pipelineChartData}
                />
            </ChartCard>
        </div>

        <div className="chart-medium">
            <ChartCard title="Closure Reasons">
                <PieChartComponent data={closureChartData} />
            </ChartCard>
        </div>
    </div>
</div>


            {/* Application Status Table */}
            <div className="chart-row" style={{ marginTop: '2rem' }}>
                <div className="chart-medium">
                     <div className="stat-card">
                        <h3 style={{ 
                            fontSize: '0.8rem', 
                            color: 'var(--text-tertiary)', 
                            marginBottom: '0.75rem',
                            textTransform: 'uppercase',
                            letterSpacing: '0.1em',
                            fontWeight: '600'
                        }}>
                            Application Statuses
                        </h3>
                        <div className="table-container" style={{ border: 'none', background: 'transparent' }}>
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {STATUSES.map(status => {
                                        const count = jobs.filter(j => j.status === status).length;
                                        return (
                                            <tr key={status}>
                                                <td><StatusBadge status={status} /></td>
                                                <td><strong>{count}</strong></td>
                                                <td>{jobs.length > 0 ? Math.round((count / jobs.length) * 100) : 0}%</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                            {/* Responses by Progression Chart */}
            <div className="chart-medium">
                <ChartCard title="Responses by Progression">
                    <PieChartComponent data={progressionChartData} />
                </ChartCard>
            </div>
            </div>

            {/* Insights */}
            <InsightsPanel insights={insights} />
            </div>
        );
        };

        /* Export for global access */
        window.AnalyticsDashboard = AnalyticsDashboard;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('React Error Boundary caught:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '2rem', color: '#e4e6eb', background: '#0a0e1a', minHeight: '100vh' }}>
                            <h1 style={{ color: '#ff6b6b' }}>Something went wrong</h1>
                            <p>Error: {this.state.error?.message}</p>
                            <button 
                                onClick={() => window.location.reload()} 
                                style={{ 
                                    background: '#6b8aff', 
                                    color: 'white', 
                                    border: 'none', 
                                    padding: '0.75rem 1.5rem', 
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    marginTop: '1rem'
                                }}
                            >
                                Reload Page
                            </button>
                            <pre style={{ 
                                marginTop: '1rem', 
                                padding: '1rem', 
                                background: '#1a1f35', 
                                borderRadius: '6px',
                                overflow: 'auto'
                            }}>
                                {this.state.error?.stack}
                            </pre>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        // Target companies data
        const DEFAULT_COMPANIES = {
            "Developer Tools": [
                { name: "Stripe", url: "https://stripe.com/jobs/search" },
                { name: "Confluent", url: "https://careers.confluent.io/jobs" },
                { name: "DataDog", url: "https://careers.datadoghq.com/jobs" },
                { name: "MongoDB", url: "https://www.mongodb.com/careers/jobs" },
                { name: "Elastic", url: "https://jobs.elastic.co/" },
                { name: "Postman", url: "https://www.postman.com/company/careers/open-positions/" },
                { name: "HubSpot", url: "https://www.hubspot.com/careers/jobs" }
            ],
            "Data Infrastructure": [
                { name: "Snowflake", url: "https://careers.snowflake.com/us/en/search-results" },
                { name: "Databricks", url: "https://www.databricks.com/company/careers/open-positions" },
                { name: "ClickHouse", url: "https://clickhouse.com/company/careers#open-positions" }
            ],
            "Cloud/Infrastructure": [
                { name: "Anthropic", url: "https://www.anthropic.com/careers#open-roles" },
                { name: "OpenAI", url: "https://openai.com/careers/search" },
                { name: "Microsoft", url: "https://careers.microsoft.com/professionals/us/en/search-results" },
                { name: "Google", url: "https://www.google.com/about/careers/applications/jobs/results/" }
            ],
            "Healthcare Tech": [
                { name: "Epic Systems", url: "https://careers.epic.com/Jobs" },
                { name: "Veeva", url: "https://careers.veeva.com/job-search-results/" },
                { name: "Overjet", url: "https://www.overjet.com/careers#open-positions" }
            ],
            "Enterprise Software": [
                { name: "ServiceNow", url: "https://careers.servicenow.com/careers/jobs" },
                { name: "SailPoint", url: "https://www.sailpoint.com/company/careers/#open-positions" },
                { name: "Gorilla Logic", url: "https://gorillalogic.com/careers/#open-positions" },
                { name: "Huntress", url: "https://www.huntress.com/careers#open-positions" }
            ],
            "Consumer Tech": [
                { name: "DoorDash", url: "https://careers.doordash.com/jobs" },
                { name: "Netflix", url: "https://jobs.netflix.com/search" },
                { name: "Zillow", url: "https://www.zillow.com/careers/openings/" },
                { name: "Dropbox", url: "https://www.dropbox.com/jobs/all-jobs" }
            ]
        };

        const STATUSES = ["Applied", "In Progress", "Closed"];
        const CLOSE_REASONS = ["Ghosted", "Rejected", "Declined Offer", "Withdrew"];
        const PROGRESSIONS = ["Application", "Recruiter Screen", "Partial Loop", "Full Loop", "Offer"];

        const PRIORITIES = ["Tier 1", "Tier 2", "Tier 3"];

        // Fit Level utilities
        const FIT_LEVELS = {
            STRONG: 3,
            DECENT: 2,
            LONG_SHOT: 1,
            UNSET: null
        };

        const getFitLevelLabel = (value) => {
            switch(value) {
                case 3: return 'Strong';
                case 2: return 'Decent';
                case 1: return 'Long Shot';
                default: return '';
            }
        };

        const getFitLevelValue = (label) => {
            switch(label) {
                case 'Strong': return 3;
                case 'Decent': return 2;
                case 'Long Shot': return 1;
                default: return null;
            }
        };

        const sortByFitLevel = (a, b, direction) => {
            // Unset values always sort last
            if (a === null && b === null) return 0;
            if (a === null) return 1;
            if (b === null) return -1;
            
            // For descending: Strong (3)  Decent (2)  Long Shot (1)
            // For ascending: Long Shot (1)  Decent (2)  Strong (3)
            if (direction === 'desc') {
                return b - a;
            } else {
                return a - b;
            }
        };

        // Main App Component
        function App() {
            // Theme state
            const [theme, setTheme] = useState(() => {
                const saved = localStorage.getItem('theme');
                return saved || 'light';
            });

            // Apply theme to document
            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            };

            const [view, setView] = useState("dashboard");
            const [jobs, setJobs] = useState(() => {
            const saved = localStorage.getItem("jobs");
            return saved ? JSON.parse(saved) : [];
        });
            // Add blockedCompanies state
            const [customCompanies, setCustomCompanies] = useState({});
            const [blockedCompanies, setBlockedCompanies] = useState(() => {
                const saved = localStorage.getItem("blockedCompanies");
                return saved ? JSON.parse(saved) : [];
            });

            const [showModal, setShowModal] = useState(false);
            const [showCompanyModal, setShowCompanyModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [editingJob, setEditingJob] = useState(null);
            const [lastBackupTime, setLastBackupTime] = useState(null);
            const [filters, setFilters] = useState({
                status: "all",
                priority: "all",
                company: "",
                search: ""
            });
            const [sortConfig, setSortConfig] = useState({ key: 'dateApplied', direction: 'desc' });

            // Load jobs from localStorage
            useEffect(() => {
                try {
                    const savedJobs = localStorage.getItem("jobTrackerJobs");
                    if (savedJobs) {
                        const parsed = JSON.parse(savedJobs);
                        if (Array.isArray(parsed)) {
                            // Validate and clean job data
                            const validJobs = parsed.map(job => ({
                                ...job,
                                status: job.status || "Not Applied",
                                priority: job.priority || "Tier 2",
                                company: job.company || "Unknown",
                                role: job.role || "Unknown Role"
                            }));
                            console.log("Loaded jobs from localStorage:", validJobs);
                            setJobs(validJobs);
                        }
                    }
                    const savedCompanies = localStorage.getItem("jobTrackerCustomCompanies");
                    if (savedCompanies) {
                        const parsed = JSON.parse(savedCompanies);
                        if (typeof parsed === 'object' && parsed !== null) {
                            console.log("Loaded companies from localStorage:", parsed);
                            setCustomCompanies(parsed);
                        }
                    }
                    const savedBackupTime = localStorage.getItem("jobTrackerLastBackup");
                    if (savedBackupTime) {
                        setLastBackupTime(new Date(savedBackupTime));
                    }
                } catch (error) {
                    console.error("Error loading data from localStorage:", error);
                    alert("Error loading saved data. Starting fresh.");
                }
            }, []);

            // Save jobs to localStorage
            useEffect(() => {
                try {
                    console.log("Saving jobs to localStorage:", jobs);
                    localStorage.setItem("jobTrackerJobs", JSON.stringify(jobs));
                    console.log("Jobs saved successfully");
                } catch (error) {
                    console.error("Error saving jobs to localStorage:", error);
                    alert("Error saving jobs: " + error.message);
                }
            }, [jobs]);

            // Save custom companies to localStorage
            useEffect(() => {
                try {
                    console.log("Saving companies to localStorage:", customCompanies);
                    localStorage.setItem("jobTrackerCustomCompanies", JSON.stringify(customCompanies));
                    console.log("Companies saved successfully");
                } catch (error) {
                    console.error("Error saving companies to localStorage:", error);
                    alert("Error saving companies: " + error.message);
                }
            }, [customCompanies]);

            // Save to local storage when customCompanies change
            useEffect(() => {
                localStorage.setItem("customCompanies", JSON.stringify(customCompanies));
            }, [customCompanies]);
            // Save blockedCompanies to localStorage
            useEffect(() => {
                localStorage.setItem("blockedCompanies", JSON.stringify(blockedCompanies));
            }, [blockedCompanies]);
            // Merge default and custom companies
            // Start with hardcoded companies
            const allCompanies = { ...DEFAULT_COMPANIES };

            // Merge in custom company edits (URL, name, and fitLevel overrides)
            Object.entries(customCompanies).forEach(([companyName, customData]) => {
                let companyFound = false;
                
                // Find and update the company across all categories
                Object.keys(allCompanies).forEach(category => {
                    const companyIndex = allCompanies[category].findIndex(c => c.name === companyName);
                    if (companyIndex !== -1) {
                        allCompanies[category][companyIndex] = { 
                            ...allCompanies[category][companyIndex], 
                            ...customData 
                        };
                        companyFound = true;
                    }
                });
                
                // If company wasn't found in existing categories, add it to its specified category
                if (!companyFound && customData.category) {
                    if (!allCompanies[customData.category]) {
                        allCompanies[customData.category] = [];
                    }
                    allCompanies[customData.category].push({
                        name: companyName,
                        ...customData
                    });
                }
            });

            // Add companies from jobs data
            jobs.forEach(job => {
                if (!job.company) return;
                
                // Check if company already exists in any category
                const existsInDefaults = Object.values(DEFAULT_COMPANIES)
                    .flat()
                    .some(c => c.name === job.company);
                
                const existsInAllCompanies = Object.values(allCompanies)
                    .flat()
                    .some(c => c.name === job.company);
                
                if (!existsInDefaults && !existsInAllCompanies) {
                    // Add to "Applied" category (or use job.priority for tier-based categorization)
                    const category = "Applied"; // or job.priority
                    
                    if (!allCompanies[category]) {
                        allCompanies[category] = [];
                    }
                    
                    // Check if already added from another job
                    if (!allCompanies[category].some(c => c.name === job.company)) {
                        const newCompany = {
                            name: job.company,
                            url: job.url || `https://www.google.com/search?q=${encodeURIComponent(job.company + ' careers')}`,
                        };
                        
                        // Apply customCompanies data if it exists for this company
                        if (customCompanies[job.company]) {
                            Object.assign(newCompany, customCompanies[job.company]);
                        }
                        
                        allCompanies[category].push(newCompany);
                    }
                }
            });

            const addJob = (job) => {
                try {
                    console.log("addJob called with:", job);
                    const newJob = {
                        ...job,
                        id: Date.now(),
                        // Use the date from the form, or fall back to today if somehow missing
                        dateApplied: job.dateApplied || new Date().toISOString()
                    };
                    console.log("newJob created:", newJob);
                    console.log("Current jobs before update:", jobs);
                    setJobs(prevJobs => {
                        const updated = [...prevJobs, newJob];
                        console.log("Updated jobs array:", updated);
                        return updated;
                    });
                    console.log("About to close modal");
                    setShowModal(false);
                    setEditingJob(null);
                    console.log("addJob completed successfully");
                } catch (error) {
                    console.error("Error adding job:", error);
                    alert("Error adding job: " + error.message);
                }
            };

            const addCompany = (company) => {
                try {
                    const newCompany = { 
                        name: company.name, 
                        url: company.url,
                        category: company.category 
                    };
                    
                    // Store by company name, not by category
                    setCustomCompanies(prev => ({
                        ...prev,
                        [company.name]: newCompany
                    }));
                    
                    setShowCompanyModal(false);
                } catch (error) {
                    console.error("Error adding company:", error);
                    alert("Error adding company. Please try again.");
                }
            };

            const updateJob = (updatedJob) => {
                setJobs(jobs.map(j => j.id === updatedJob.id ? updatedJob : j));
                setShowModal(false);
                setEditingJob(null);
            };

            const deleteJob = (id) => {
                if (confirm("Are you sure you want to delete this job?")) {
                    setJobs(jobs.filter(j => j.id !== id));
                }
            };

            const exportToCSV = () => {
                const headers = ["Company", "Role", "Status", "Priority", "Date Applied", "URL", "Salary", "Location", "Contact", "Notes"];
                const rows = jobs.map(j => [
                    j.company,
                    j.role,
                    j.status,
                    j.priority,
                    new Date(j.dateApplied).toLocaleDateString(),
                    j.url,
                    j.salary || "",
                    j.location || "",
                    j.contact || "",
                    j.notes || ""
                ]);
                const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
                const blob = new Blob([csv], { type: "text/csv" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `job-search-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            const exportBackup = () => {
                const backup = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    jobs: jobs,
                    customCompanies: customCompanies,
                    blockedCompanies: blockedCompanies
                };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `job-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                // Update last backup time
                const now = new Date();
                setLastBackupTime(now);
                localStorage.setItem("jobTrackerLastBackup", now.toISOString());
                alert("Backup downloaded successfully!");
            };

            const importBackup = (fileContent, mode = 'replace') => {
                try {
                    const backup = JSON.parse(fileContent);
                    
                    if (!backup.jobs || !Array.isArray(backup.jobs)) {
                        throw new Error("Invalid backup file: missing jobs data");
                    }
                    
                    // Validate imported jobs
                    const validJobs = backup.jobs.map(job => ({
                        ...job,
                        status: job.status || "Not Applied",
                        priority: job.priority || "Tier 2",
                        company: job.company || "Unknown",
                        role: job.role || "Unknown Role",
                        id: job.id || Date.now() + Math.random() // Ensure unique ID
                    }));
                    
                    if (mode === 'merge') {
                        // Merge mode: check for duplicates and append new jobs
                        const existingJobKeys = new Set(
                            jobs.map(j => `${j.company.toLowerCase()}-${j.role.toLowerCase()}-${j.dateApplied}`)
                        );
                        
                        const newJobs = validJobs.filter(job => {
                            const key = `${job.company.toLowerCase()}-${job.role.toLowerCase()}-${job.dateApplied}`;
                            return !existingJobKeys.has(key);
                        });
                        
                        setJobs([...jobs, ...newJobs]);
                        
                        // Merge custom companies - handle both old and new structures
                        if (backup.customCompanies && typeof backup.customCompanies === 'object') {
                            const mergedCompanies = { ...customCompanies };
                            
                            // Check if it's the new structure (company-name keyed) or old (category keyed)
                            const firstKey = Object.keys(backup.customCompanies)[0];
                            const isNewStructure = firstKey && backup.customCompanies[firstKey] && 
                                                  (backup.customCompanies[firstKey].name || backup.customCompanies[firstKey].url);
                            
                            if (isNewStructure) {
                                // New structure: merge directly
                                Object.assign(mergedCompanies, backup.customCompanies);
                            } else {
                                // Old structure: convert to new structure
                                Object.entries(backup.customCompanies).forEach(([category, companies]) => {
                                    if (Array.isArray(companies)) {
                                        companies.forEach(company => {
                                            if (!mergedCompanies[company.name]) {
                                                mergedCompanies[company.name] = {
                                                    ...company,
                                                    category: category
                                                };
                                            }
                                        });
                                    }
                                });
                            }
                            
                            setCustomCompanies(mergedCompanies);
                        }
                        // Merge blocked companies
                        if (backup.blockedCompanies && Array.isArray(backup.blockedCompanies)) {
                                const mergedBlocked = [...new Set([...blockedCompanies, ...backup.blockedCompanies])];
                                setBlockedCompanies(mergedBlocked);
                            }
                        
                        const skipped = validJobs.length - newJobs.length;
                        alert(
                            `Merge complete!\n\n` +
                            `Added: ${newJobs.length} new jobs\n` +
                            `Skipped: ${skipped} duplicates\n` +
                            `Total jobs: ${jobs.length + newJobs.length}`
                        );
                    } else {
                        // Replace mode: overwrite everything
                        setJobs(validJobs);
                        
                        if (backup.customCompanies && typeof backup.customCompanies === 'object') {
                            setCustomCompanies(backup.customCompanies);
                        }

                        if (backup.blockedCompanies && Array.isArray(backup.blockedCompanies)) {
                            setBlockedCompanies(backup.blockedCompanies);
                        }
                        
                        alert(
                            `Import complete!\n\n` +
                            `Imported ${validJobs.length} jobs and ${Object.keys(backup.customCompanies || {}).length} custom company categories!`
                        );
                    }
                    
                    setShowImportModal(false);
                } catch (error) {
                    console.error("Error importing backup:", error);
                    alert("Error importing backup: " + error.message);
                }
            };

            const autoBackup = () => {
                // Auto-backup when there's data and last backup was more than 1 hour ago
                if (jobs.length > 0) {
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                    if (!lastBackupTime || lastBackupTime < oneHourAgo) {
                        console.log("Auto-backup triggered");
                        exportBackup();
                    }
                }
            };

            // Check for auto-backup need when jobs change
            useEffect(() => {
                if (jobs.length > 0) {
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                    if (!lastBackupTime || lastBackupTime < oneHourAgo) {
                        // Show reminder instead of auto-downloading
                        const daysSinceBackup = lastBackupTime 
                            ? Math.floor((Date.now() - lastBackupTime.getTime()) / (1000 * 60 * 60 * 24))
                            : null;
                        
                        if (daysSinceBackup === null || daysSinceBackup >= 1) {
                            console.log("Backup reminder: It's been a while since your last backup");
                        }
                    }
                }
            }, [jobs, lastBackupTime]);

            const requestSort = (key) => {
    let direction = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
        direction = 'desc';
    }
    setSortConfig({ key, direction });
};

const getSortIcon = (columnKey) => {
    if (sortConfig.key !== columnKey) return ' ';
    return sortConfig.direction === 'asc' ? ' ' : ' ';
};

const sortedJobs = [...jobs].sort((a, b) => {
    if (!sortConfig.key) return 0;
    const aVal = (a[sortConfig.key] || '').toString().toLowerCase();
    const bVal = (b[sortConfig.key] || '').toString().toLowerCase();
    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
    return 0;
});

            const filteredJobs = sortedJobs.filter(job => {
                if (filters.status !== "all" && job.status !== filters.status) return false;
                if (filters.priority !== "all" && job.priority !== filters.priority) return false;
                if (filters.search) {
                    const searchLower = filters.search.toLowerCase();
                    const matchesRole = job.role.toLowerCase().includes(searchLower);
                    const matchesCompany = job.company.toLowerCase().includes(searchLower);
                    if (!matchesRole && !matchesCompany) return false;
                }
                return true;
            });

            return (
                <div className="app">
                    <Header 
                        view={view} 
                        setView={setView} 
                        onBackup={exportBackup}
                        onImport={() => setShowImportModal(true)}
                        lastBackupTime={lastBackupTime}
                        theme={theme}
                        toggleTheme={toggleTheme}
                    />
                    <main className="main">
                        {view === "dashboard" && <Dashboard jobs={jobs} />}
                        {view === "companies" && <Companies 
                            companies={allCompanies}
                            jobs={jobs}
                            customCompanies={customCompanies}
                            blockedCompanies={blockedCompanies}
                            onUpdateCompany={(companyName, updates) => {
                                // Find which category this company belongs to in allCompanies
                                let categoryFound = null;
                                let companyFound = null;
                                
                                // Search through all categories to find the company
                                Object.entries(allCompanies).forEach(([category, companiesList]) => {
                                    const company = companiesList.find(c => c.name === companyName);
                                    if (company) {
                                        categoryFound = category;
                                        companyFound = company;
                                    }
                                });
                                
                                if (categoryFound && companyFound) {
                                    // Update customCompanies with the new data
                                    // Structure: customCompanies[companyName] = { ...updates }
                                    setCustomCompanies(prev => ({
                                        ...prev,
                                        [companyName]: {
                                            ...(prev[companyName] || {}),
                                            ...updates,
                                            name: companyName, // preserve name
                                            url: companyFound.url, // preserve url if not updating
                                        }
                                    }));
                                }
                            }}
                            onDeleteCompany={(companyName) => {
                                setBlockedCompanies([...blockedCompanies, companyName]);
                            }}
                            onUnhideCompany={(companyName) => {
                                setBlockedCompanies(blockedCompanies.filter(name => name !== companyName));
                            }}
                            onAddJob={(company) => {
                                setEditingJob({ company: company.name, url: company.url });
                                setShowModal(true);
                            }}
                            onAddCompany={() => setShowCompanyModal(true)}
                            onViewCompanyJobs={(companyName) => {
                                setView('jobs');
                                setFilters({ ...filters, search: companyName });
                            }}
                        />}                        
                        {view === "jobs" && <JobsTable
                            jobs={filteredJobs}
                            filters={filters}
                            setFilters={setFilters}
                            onAdd={() => {
                                setEditingJob(null);
                                setShowModal(true);
                            }}
                            onEdit={(job) => {
                                setEditingJob(job);
                                setShowModal(true);
                            }}
                            onDelete={deleteJob}
                            onExport={exportToCSV}
                            onBackup={exportBackup}
                            requestSort={requestSort}
                            getSortIcon={getSortIcon}
                        />}
                        {view === "stats" && <Stats jobs={jobs} />}
                    </main>
                    {showModal && (
                        <JobModal
                            job={editingJob}
                            onSave={editingJob?.id ? updateJob : addJob}
                            onClose={() => { setShowModal(false); setEditingJob(null); }}
                        />
                    )}
                    {showCompanyModal && (
                        <CompanyModal
                            onSave={addCompany}
                            onClose={() => setShowCompanyModal(false)}
                            existingCategories={Object.keys(allCompanies)}
                        />
                    )}
                    {showImportModal && (
                        <ImportModal
                            onImport={importBackup}
                            onClose={() => setShowImportModal(false)}
                        />
                    )}
                    
                </div>
            );
        }

        // Header Component
        function Header({ view, setView, onBackup, onImport, lastBackupTime, theme, toggleTheme }) {
            const daysSinceBackup = lastBackupTime 
                ? Math.floor((Date.now() - lastBackupTime.getTime()) / (1000 * 60 * 60 * 24))
                : null;
            
            const backupWarning = daysSinceBackup === null || daysSinceBackup >= 1;
            
            return (
                <header className="header">
                    <div className="header-content">
                        <div className="logo">
                            <div className="logo-icon"></div>
                            <span>Job Search Dashboard</span>
                        </div>
                        <div className="header-controls">
                            <button
                                className="theme-toggle"
                                onClick={toggleTheme}
                                title={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}
                            >
                                {theme === 'light' ? '' : ''}
                            </button>
                            <nav className="nav">
                                <button className={`nav-btn ${view === "dashboard" ? "active" : ""}`} onClick={() => setView("dashboard")}>Dashboard</button>
                                <button className={`nav-btn ${view === "companies" ? "active" : ""}`} onClick={() => setView("companies")}>Companies</button>
                                <button className={`nav-btn ${view === "jobs" ? "active" : ""}`} onClick={() => setView("jobs")}>Jobs</button>
                                <button 
                                    className="nav-btn" 
                                    onClick={onBackup}
                                    style={{ 
                                        borderColor: backupWarning ? "#ea580c" : undefined,
                                        background: backupWarning ? "#faa29d" : undefined
                                    }}
                                    title={lastBackupTime ? `Last backup: ${lastBackupTime.toLocaleDateString()}` : "No backup yet"}
                                >
                                     Back up {backupWarning && ""}
                                </button>
                                <button className="nav-btn" onClick={onImport}> Import</button>
                            </nav>
                        </div>
                    </div>
                </header>
            );
        }

        // Dashboard Component
        const Dashboard = ({ jobs }) => {
            return <AnalyticsDashboard jobs={jobs} />;
        };

        // Companies Component
        function Companies({ companies, jobs, customCompanies, blockedCompanies, onUpdateCompany, onDeleteCompany, onAddJob, onAddCompany, onViewCompanyJobs, onUnhideCompany }) {
            const [searchTerm, setSearchTerm] = useState("");
            const [sortConfig, setSortConfig] = useState({ key: 'company', direction: 'asc' });
            const [editingCompany, setEditingCompany] = useState(null);
            const [editUrl, setEditUrl] = useState('');
            const [editCompanyName, setEditCompanyName] = useState('');            
            const [showHidden, setShowHidden] = useState(false);


            if (!companies || typeof companies !== 'object') {
                console.error("Invalid companies prop:", companies);
                return <div className="empty-state"><h3>Error loading companies</h3></div>;
            }

            // Get all companies from all categories
            const allCompaniesList = Object.values(companies)
                .flat()
                .filter((company, index, self) => 
                    index === self.findIndex(c => c.name === company.name)
                )
                .filter(company => showHidden || !blockedCompanies.includes(company.name));
            // Filter by search term only
            const filteredCompaniesList = allCompaniesList.filter(company =>
                company && company.name && company.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                
                // Special case: fitLevel should start with descending order
                if (key === 'fitLevel' && sortConfig.key !== 'fitLevel') {
                    direction = 'desc';
                }
                
                setSortConfig({ key, direction });
            };

            const getSortIcon = (columnKey) => {
                if (sortConfig.key !== columnKey) return ' ';
                return sortConfig.direction === 'asc' ? ' ' : ' ';
            };

            const handleFitLevelChange = (companyName, newValue) => {
                onUpdateCompany(companyName, { fitLevel: newValue });
            };

            // Sort the filtered list
            const sortedCompaniesList = [...filteredCompaniesList].sort((a, b) => {
                if (!sortConfig.key) return 0;
                
                let aVal, bVal;
                if (sortConfig.key === 'applications') {
                    aVal = jobs.filter(j => j.company === a.name).length;
                    bVal = jobs.filter(j => j.company === b.name).length;
                } else if (sortConfig.key === 'company') {
                    aVal = a.name.toLowerCase();
                    bVal = b.name.toLowerCase();
                } else if (sortConfig.key === 'fitLevel') {
                    return sortByFitLevel(a.fitLevel || null, b.fitLevel || null, sortConfig.direction);
                }
                
                if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });

            return (
                <div>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "1.5rem", flexWrap: "wrap", gap: "1rem" }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <h1 style={{ color: "#6b8aff" }}>Target Companies</h1>
                            <span style={{ color: "#9ca3af", fontSize: "0.9rem", marginLeft: "0.5rem" }}>
                                {filteredCompaniesList.length} {filteredCompaniesList.length === 1 ? 'company' : 'companies'}
                            </span>
                        </div>

                        <div style={{ display: "flex", gap: "0.5rem" }}>
                            <label style={{ display: "flex", alignItems: "center", gap: "0.5rem", color: "#9ca3af", cursor: "pointer" }}>
                                <input 
                                    type="checkbox" 
                                    checked={showHidden}
                                    onChange={(e) => setShowHidden(e.target.checked)}
                                    style={{ cursor: "pointer" }}
                                />
                                Show Hidden ({blockedCompanies.length})
                            </label>
                            <button className="btn" onClick={onAddCompany}>+ Add Company</button>
                        </div>
                    </div>

                    <div className="action-bar" style={{ marginBottom: "2rem" }}>
                        <div className="filters">
                            <div className="search-container">
                            <input
                                type="text"
                                className="search-input"
                                placeholder="Search companies..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            {searchTerm && (
                                <button 
                                    className="clear-search"
                                    onClick={() => setSearchTerm("")}
                                >
                                    
                                </button>
                            )}
                            </div>
                        </div>
                        
                    </div>

                    {filteredCompaniesList.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon"></div>
                            <h3>No companies found</h3>
                            <p>Try adjusting your search</p>
                        </div>
                    ) : (
                        <div className="table-container">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th onClick={() => requestSort('company')} style={{cursor: 'pointer'}}>
                                            Company{getSortIcon('company')}
                                        </th>
                                        <th onClick={() => requestSort('fitLevel')} style={{cursor: 'pointer'}} title="Fit level reflects how well this company tends to match your goals based on role availability, location, hiring patterns, or past experience. It's subjective and can change over time.">
                                            Fit Level{getSortIcon('fitLevel')}
                                        </th>
                                        <th onClick={() => requestSort('applications')} style={{cursor: 'pointer'}}>
                                            Applications{getSortIcon('applications')}
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedCompaniesList.map(company => {
                                        const isHidden = blockedCompanies.includes(company.name);
                                        return (
                                            <tr key={company.name} style={isHidden ? { opacity: 0.6, background: 'var(--bg-tertiary)' } : {}}>
                                                <td>
                                                    <a href={company.url} target="_blank" rel="noopener noreferrer" className="link">
                                                        {company.name}
                                                    </a>
                                                </td>
                                                <td>
                                                    <select
                                                        value={getFitLevelLabel(company.fitLevel || null)}
                                                        onChange={(e) => handleFitLevelChange(company.name, getFitLevelValue(e.target.value))}
                                                        style={{
                                                            background: 'var(--bg-tertiary)',
                                                            color: 'var(--text-primary)',
                                                            border: '1px solid var(--border-primary)',
                                                            padding: '0.375rem 0.5rem',
                                                            borderRadius: '6px',
                                                            fontSize: '0.875rem',
                                                            cursor: 'pointer',
                                                            fontWeight: company.fitLevel === 3 ? '600' : company.fitLevel === 1 ? '400' : '500',
                                                            opacity: company.fitLevel === 1 ? 0.7 : 1
                                                        }}
                                                        aria-label={`Fit level: ${getFitLevelLabel(company.fitLevel || null)}`}
                                                    >
                                                        <option value=""></option>
                                                        <option value="Strong">Strong</option>
                                                        <option value="Decent">Decent</option>
                                                        <option value="Long Shot">Long Shot</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    {jobs.filter(j => j.company === company.name).length > 0 ? (
                                                        <button 
                                                            onClick={() => onViewCompanyJobs(company.name)}
                                                            style={{
                                                                background: 'none',
                                                                border: 'none',
                                                                color: '#6b8aff',
                                                                cursor: 'pointer',
                                                                textDecoration: 'underline',
                                                                fontSize: 'inherit',
                                                                padding: 0
                                                            }}
                                                        >
                                                            {jobs.filter(j => j.company === company.name).length}
                                                        </button>
                                                    ) : (
                                                        <span style={{ color: '#6b7280' }}>0</span>
                                                    )}
                                                </td>
                                                <td>
                                                    {isHidden ? (
                                                        <button 
                                                            className="btn btn-sm" 
                                                            onClick={() => onUnhideCompany(company.name)}
                                                            style={{ marginRight: '0.5rem' }}
                                                        >
                                                            Unhide
                                                        </button>
                                                    ) : (
                                                        <>
                                                            <button className="btn btn-sm" onClick={() => onAddJob(company)} style={{ marginRight: '0.5rem' }}>
                                                                Add Job
                                                            </button>
                                                            <button 
                                                                className="btn btn-sm btn-secondary" 
                                                                onClick={() => {
                                                                    if (confirm(`Hide ${company.name} from this list?`)) {
                                                                        onDeleteCompany(company.name);
                                                                    }
                                                                }}
                                                                style={{ marginRight: '0.5rem' }}
                                                            >
                                                                Hide
                                                            </button>
                                                        </>
                                                    )}
                                                    <button className="btn btn-sm btn-secondary" onClick={() => {
                                                        setEditingCompany(company);
                                                        setEditUrl(company.url);
                                                        setEditCompanyName(company.name);
                                                    }}>
                                                        Edit
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                    {editingCompany && (
                        <div className="modal-overlay" onClick={() => setEditingCompany(null)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <h2>Edit Company</h2>
                                <div className="form-group">
                                    <label>Company Name</label>
                                    <input
                                        type="text"
                                        value={editCompanyName}
                                        onChange={(e) => setEditCompanyName(e.target.value)}
                                        placeholder="Company Name"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>URL</label>
                                    <input
                                        type="url"
                                        value={editUrl}
                                        onChange={(e) => setEditUrl(e.target.value)}
                                        placeholder="https://company.com/careers"
                                    />
                                </div>
                                <div className="modal-actions">
                                    <button className="btn" onClick={() => {
                                        onUpdateCompany(editingCompany.name, { 
                                            name: editCompanyName,
                                            url: editUrl 
                                        });
                                        setEditingCompany(null);
                                    }}>
                                        Save
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => setEditingCompany(null)}>
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Jobs Table Component
        function JobsTable({ jobs, filters, setFilters, onAdd, onEdit, onDelete, onExport, onBackup, requestSort, getSortIcon }) {
                        // View modal state
                        const [viewModalOpen, setViewModalOpen] = useState(false);
                        const [viewModalJob, setViewModalJob] = useState(null);
                        const [viewModalEdit, setViewModalEdit] = useState(false);
                        const [editedJobData, setEditedJobData] = useState(null);
                                    const notesTextareaRef = useRef(null);

                                    // Auto-expand textarea based on content
                                    const autoExpandTextarea = () => {
                                        if (notesTextareaRef.current) {
                                            notesTextareaRef.current.style.height = 'auto';
                                            notesTextareaRef.current.style.height = Math.max(notesTextareaRef.current.scrollHeight, 120) + 'px';
                                        }
                                    };

                                    useEffect(() => {
                                        autoExpandTextarea();
                                    }, [viewModalJob, editedJobData, viewModalEdit]);
            // Read-only styling for view mode fields in job modal
            const viewFieldStyle = viewModalEdit ? {} : {
                background: 'var(--bg-tertiary)',
                border: '1px dashed var(--border-primary)',
                color: 'var(--text-secondary)',
                cursor: 'not-allowed'
            };
            // Column visibility state - updated defaults
            const [visibleColumns, setVisibleColumns] = useState({
                company: true,
                role: true,
                status: true,
                priority: false,
                dateApplied: true,
                salary: false,
                closeReason: false,
                progression: true,
                followUp: false,
                notes: false,
                resumeUrl: false,
                coverLetterUrl: false
            });
            const [showColumnSelector, setShowColumnSelector] = useState(false);
            
            // Advanced filters state
            const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
            const [dateRangeFilter, setDateRangeFilter] = useState({ start: '', end: '' });
            
            // Multiselect filters
            const [selectedStatuses, setSelectedStatuses] = useState([]);
            const [selectedPriorities, setSelectedPriorities] = useState([]);
            const [showStatusDropdown, setShowStatusDropdown] = useState(false);
            const [showPriorityDropdown, setShowPriorityDropdown] = useState(false);
            
            // Apply all filters to jobs
            const filteredJobs = jobs.filter(job => {
                // Status multiselect filter
                if (selectedStatuses.length > 0 && !selectedStatuses.includes(job.status)) {
                    return false;
                }
                
                // Priority multiselect filter
                if (selectedPriorities.length > 0 && !selectedPriorities.includes(job.priority)) {
                    return false;
                }
                
                // Date range filter
                if (dateRangeFilter.start || dateRangeFilter.end) {
                    const jobDate = new Date(job.dateApplied);
                    if (dateRangeFilter.start) {
                        const startDate = new Date(dateRangeFilter.start);
                        if (jobDate < startDate) return false;
                    }
                    if (dateRangeFilter.end) {
                        const endDate = new Date(dateRangeFilter.end);
                        if (jobDate > endDate) return false;
                    }
                }
                
                return true;
            });
            
            // Pagination state
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 20;
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredJobs.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedJobs = filteredJobs.slice(startIndex, startIndex + itemsPerPage);
            
            // Reset to first page when filters change
            useEffect(() => {
                setCurrentPage(1);
            }, [filters.search, selectedStatuses.length, selectedPriorities.length, dateRangeFilter]);
            
            // Count active filters
            const activeFiltersCount = [
                filters.search,
                selectedStatuses.length > 0,
                selectedPriorities.length > 0,
                dateRangeFilter.start || dateRangeFilter.end
            ].filter(Boolean).length;
            
            const clearFilters = () => {
                setFilters({ status: 'all', priority: 'all', company: '', search: '' });
                setSelectedStatuses([]);
                setSelectedPriorities([]);
                setDateRangeFilter({ start: '', end: '' });
            };
            
            const toggleColumn = (key) => {
                setVisibleColumns(prev => ({ ...prev, [key]: !prev[key] }));
            };
            
            const toggleStatus = (status) => {
                setSelectedStatuses(prev => 
                    prev.includes(status) 
                        ? prev.filter(s => s !== status)
                        : [...prev, status]
                );
            };
            
            const togglePriority = (priority) => {
                setSelectedPriorities(prev => 
                    prev.includes(priority) 
                        ? prev.filter(p => p !== priority)
                        : [...prev, priority]
                );
            };
            
            const columns = [
                { key: 'company', label: 'Company' },
                { key: 'role', label: 'Role' },
                { key: 'status', label: 'Status' },
                { key: 'priority', label: 'Priority' },
                { key: 'dateApplied', label: 'Date Applied' },
                { key: 'salary', label: 'Salary' },
                { key: 'closeReason', label: 'Reason' },
                { key: 'progression', label: 'Progress' },
                { key: 'followUp', label: 'Follow-up Date' },
                { key: 'notes', label: 'Notes' },
                { key: 'resumeUrl', label: 'Resume' },
                { key: 'coverLetterUrl', label: 'Cover Letter' }
            ];
            
            return (
                <div>
                    <div className="action-bar">
                        <div style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                            <h1 style={{ color: "var(--accent-primary)", fontFamily: "'Bricolage Grotesque', sans-serif", fontSize: "1.75rem" }}>Job Applications</h1>
                            <span style={{ color: "var(--text-tertiary)", fontSize: "0.9rem" }}>
                                {filteredJobs.length === jobs.length 
                                    ? `${jobs.length} ${jobs.length === 1 ? 'job' : 'jobs'}`
                                    : `${filteredJobs.length} of ${jobs.length} jobs`
                                }
                            </span>
                        </div>

                        <div style={{ display: "flex", gap: "0.5rem" }}>
                            <button className="btn btn-secondary" onClick={onExport}> Export CSV</button>
                            <button className="btn" onClick={onAdd}>+ Add Job</button>
                        </div>
                    </div>

                    <div className="action-bar" style={{ marginTop: "1rem" }}>
                        <div className="filters-section" style={{ flex: 1 }}>
                            <div className="filters-row" style={{ display: "flex", gap: "0.75rem", flexWrap: "wrap", alignItems: "center" }}>
                                <input
                                    type="text"
                                    className="search-input"
                                    placeholder="Search roles or companies..."
                                    value={filters.search}
                                    onChange={(e) => setFilters({ ...filters, search: e.target.value })}
                                    style={{ minWidth: "250px" }}
                                />
                                
                                {/* Status Multiselect */}
                                <div style={{ position: "relative" }}>
                                    <button
                                        className="filter-select"
                                        onClick={() => setShowStatusDropdown(!showStatusDropdown)}
                                        style={{
                                            display: "flex",
                                            alignItems: "center",
                                            justifyContent: "space-between",
                                            gap: "0.5rem",
                                            minWidth: "140px",
                                            cursor: "pointer"
                                        }}
                                    >
                                        <span>
                                            {selectedStatuses.length === 0 
                                                ? 'All Statuses' 
                                                : `Status (${selectedStatuses.length})`}
                                        </span>
                                        <span style={{ fontSize: "0.7rem" }}></span>
                                    </button>
                                    {showStatusDropdown && (
                                        <div style={{
                                            position: "absolute",
                                            top: "calc(100% + 4px)",
                                            left: 0,
                                            background: "var(--bg-elevated)",
                                            border: "1px solid var(--border-primary)",
                                            borderRadius: "10px",
                                            padding: "0.5rem",
                                            boxShadow: "var(--shadow-lg)",
                                            zIndex: 1000,
                                            minWidth: "200px",
                                            maxHeight: "300px",
                                            overflowY: "auto"
                                        }}>
                                            {STATUSES.map(status => (
                                                <label
                                                    key={status}
                                                    style={{
                                                        display: "flex",
                                                        alignItems: "center",
                                                        gap: "0.5rem",
                                                        padding: "0.5rem",
                                                        cursor: "pointer",
                                                        borderRadius: "6px",
                                                        transition: "background 0.2s",
                                                        fontSize: "0.9rem",
                                                        color: "var(--text-primary)"
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.background = "var(--bg-hover)"}
                                                    onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedStatuses.includes(status)}
                                                        onChange={() => toggleStatus(status)}
                                                        style={{ 
                                                            width: "16px", 
                                                            height: "16px",
                                                            cursor: "pointer",
                                                            accentColor: "var(--accent-primary)"
                                                        }}
                                                    />
                                                    <span>{status}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Priority Multiselect */}
                                <div style={{ position: "relative" }}>
                                    <button
                                        className="filter-select"
                                        onClick={() => setShowPriorityDropdown(!showPriorityDropdown)}
                                        style={{
                                            display: "flex",
                                            alignItems: "center",
                                            justifyContent: "space-between",
                                            gap: "0.5rem",
                                            minWidth: "140px",
                                            cursor: "pointer"
                                        }}
                                    >
                                        <span>
                                            {selectedPriorities.length === 0 
                                                ? 'All Priorities' 
                                                : `Priority (${selectedPriorities.length})`}
                                        </span>
                                        <span style={{ fontSize: "0.7rem" }}></span>
                                    </button>
                                    {showPriorityDropdown && (
                                        <div style={{
                                            position: "absolute",
                                            top: "calc(100% + 4px)",
                                            left: 0,
                                            background: "var(--bg-elevated)",
                                            border: "1px solid var(--border-primary)",
                                            borderRadius: "10px",
                                            padding: "0.5rem",
                                            boxShadow: "var(--shadow-lg)",
                                            zIndex: 1000,
                                            minWidth: "200px"
                                        }}>
                                            {PRIORITIES.map(priority => (
                                                <label
                                                    key={priority}
                                                    style={{
                                                        display: "flex",
                                                        alignItems: "center",
                                                        gap: "0.5rem",
                                                        padding: "0.5rem",
                                                        cursor: "pointer",
                                                        borderRadius: "6px",
                                                        transition: "background 0.2s",
                                                        fontSize: "0.9rem",
                                                        color: "var(--text-primary)"
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.background = "var(--bg-hover)"}
                                                    onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedPriorities.includes(priority)}
                                                        onChange={() => togglePriority(priority)}
                                                        style={{ 
                                                            width: "16px", 
                                                            height: "16px",
                                                            cursor: "pointer",
                                                            accentColor: "var(--accent-primary)"
                                                        }}
                                                    />
                                                    <span>{priority}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                <button
                                    className={`advanced-filters-toggle ${showAdvancedFilters ? 'active' : ''}`}
                                    onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                                    style={{
                                        background: showAdvancedFilters ? "var(--accent-primary)" : "var(--bg-tertiary)",
                                        color: showAdvancedFilters ? "white" : "var(--text-secondary)",
                                        border: "1px solid var(--border-primary)",
                                        padding: "0.6rem 1rem",
                                        borderRadius: "10px",
                                        cursor: "pointer",
                                        fontSize: "0.85rem",
                                        fontWeight: "500",
                                        display: "flex",
                                        alignItems: "center",
                                        gap: "0.5rem",
                                        transition: "all 0.2s ease"
                                    }}
                                >
                                     Application date
                                    {activeFiltersCount > 0 && ` (${activeFiltersCount})`}
                                </button>
                                {activeFiltersCount > 0 && (
                                    <button className="btn btn-secondary" onClick={clearFilters}>
                                        Clear Filters
                                    </button>
                                )}
                            </div>
                        </div>
                        <button
                            className="btn btn-secondary"
                            onClick={() => setShowColumnSelector(!showColumnSelector)}
                        >
                             Columns
                        </button>
                    </div>

                    {showAdvancedFilters && (
                        <div style={{
                            background: "var(--bg-secondary)",
                            border: "1px solid var(--border-primary)",
                            borderRadius: "12px",
                            padding: "1.5rem",
                            marginBottom: "1.5rem",
                            boxShadow: "var(--shadow-md)",
                            animation: "slideDown 0.3s ease"
                        }}>
                            <div style={{
                                display: "grid",
                                gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
                                gap: "1rem"
                            }}>
                                <div className="filter-group">
                                    <label className="filter-label" style={{ fontSize: "0.85rem", color: "var(--text-secondary)", fontWeight: "500", marginBottom: "0.5rem", display: "block" }}>
                                        Date From
                                    </label>
                                    <input
                                        type="date"
                                        className="filter-select"
                                        value={dateRangeFilter.start}
                                        onChange={(e) => setDateRangeFilter(prev => ({ ...prev, start: e.target.value }))}
                                    />
                                </div>
                                <div className="filter-group">
                                    <label className="filter-label" style={{ fontSize: "0.85rem", color: "var(--text-secondary)", fontWeight: "500", marginBottom: "0.5rem", display: "block" }}>
                                        Date To
                                    </label>
                                    <input
                                        type="date"
                                        className="filter-select"
                                        value={dateRangeFilter.end}
                                        onChange={(e) => setDateRangeFilter(prev => ({ ...prev, end: e.target.value }))}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {showColumnSelector && (
                        <div style={{
                            background: "var(--bg-secondary)",
                            border: "1px solid var(--border-primary)",
                            borderRadius: "12px",
                            padding: "1.5rem",
                            marginBottom: "1.5rem"
                        }}>
                            <h4 style={{ fontSize: "0.95rem", fontWeight: "600", marginBottom: "1rem", color: "var(--text-primary)" }}>
                                Visible Columns
                            </h4>
                            <div style={{
                                display: "grid",
                                gridTemplateColumns: "repeat(auto-fill, minmax(150px, 1fr))",
                                gap: "0.75rem"
                            }}>
                                {columns.map(col => (
                                    <label key={col.key} className="checkbox-label" style={{
                                        display: "flex",
                                        alignItems: "center",
                                        gap: "0.5rem",
                                        cursor: "pointer",
                                        fontSize: "0.9rem",
                                        color: "var(--text-secondary)",
                                        padding: "0.5rem",
                                        borderRadius: "6px",
                                        transition: "all 0.2s ease"
                                    }}>
                                        <input
                                            type="checkbox"
                                            checked={visibleColumns[col.key]}
                                            onChange={() => toggleColumn(col.key)}
                                            style={{ width: "18px", height: "18px", cursor: "pointer", accentColor: "var(--accent-primary)" }}
                                        />
                                        <span>{col.label}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    )}

                    {filteredJobs.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon"></div>
                            <h3>No jobs found</h3>
                            <p>Add a job or adjust your filters</p>
                        </div>
                    ) : (
                        <>
                            <div className="table-container">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            {visibleColumns.company && (
                                                <th onClick={() => requestSort('company')} style={{cursor: 'pointer'}}>
                                                    Company{getSortIcon('company')}
                                                </th>
                                            )}
                                            {visibleColumns.role && (
                                                <th onClick={() => requestSort('role')} style={{cursor: 'pointer'}}>
                                                    Role{getSortIcon('role')}
                                                </th>
                                            )}
                                            {visibleColumns.status && (
                                                <th onClick={() => requestSort('status')} style={{cursor: 'pointer'}}>
                                                    Status{getSortIcon('status')}
                                                </th>
                                            )}
                                            {visibleColumns.priority && (
                                                <th onClick={() => requestSort('priority')} style={{cursor: 'pointer'}}>
                                                    Priority{getSortIcon('priority')}
                                                </th>
                                            )}
                                            {visibleColumns.dateApplied && (
                                                <th onClick={() => requestSort('dateApplied')} style={{cursor: 'pointer'}}>
                                                    Date Applied{getSortIcon('dateApplied')}
                                                </th>
                                            )}
                                            {visibleColumns.salary && (
                                                <th onClick={() => requestSort('salary')} style={{cursor: 'pointer'}}>
                                                    Salary{getSortIcon('salary')}
                                                </th>
                                            )}
                                            {visibleColumns.closeReason && (
                                                <th onClick={() => requestSort('closeReason')} style={{cursor: 'pointer'}}>
                                                    Reason{getSortIcon('closeReason')}
                                                </th>
                                            )}
                                            {visibleColumns.progression && (
                                                <th onClick={() => requestSort('progression')} style={{cursor: 'pointer'}}>
                                                    Progress{getSortIcon('progression')}
                                                </th>
                                            )}
                                            {visibleColumns.followUp && (
                                                <th onClick={() => requestSort('followUp')} style={{cursor: 'pointer'}}>
                                                    Follow-up{getSortIcon('followUp')}
                                                </th>
                                            )}
                                            {visibleColumns.notes && (
                                                <th>Notes</th>
                                            )}
                                            {visibleColumns.resumeUrl && (
                                                <th>Resume</th>
                                            )}
                                            {visibleColumns.coverLetterUrl && (
                                                <th>Cover</th>
                                            )}
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {paginatedJobs.map(job => (
                                            <tr key={job.id}>
                                                {visibleColumns.company && <td><strong>{job.company}</strong></td>}
                                                {visibleColumns.role && (
                                                    <td>
                                                        {job.url ? (
                                                            <a href={job.url} target="_blank" rel="noopener noreferrer" style={{ color: "var(--accent-primary)", textDecoration: "none" }}>{job.role}</a>
                                                        ) : job.role}
                                                    </td>
                                                )}
                                                {visibleColumns.status && <td><StatusBadge status={job.status} /></td>}
                                                {visibleColumns.priority && <td><PriorityBadge priority={job.priority} /></td>}
                                                {visibleColumns.dateApplied && <td>{job.dateApplied ? new Date(job.dateApplied + 'T00:00:00').toLocaleDateString() : '-'}</td>}
                                                {visibleColumns.salary && <td>{job.salary || "-"}</td>}
                                                {visibleColumns.closeReason && <td>{job.closeReason || "-"}</td>}
                                                {visibleColumns.progression && <td>{job.progression || "-"}</td>}
                                                {visibleColumns.followUp && <td>{job.followUp ? new Date(job.followUp + 'T00:00:00').toLocaleDateString() : "-"}</td>}
                                                {visibleColumns.notes && (
                                                    <td style={{ maxWidth: "200px", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                                                        {job.notes || "-"}
                                                    </td>
                                                )}
                                                {visibleColumns.resumeUrl && (
                                                    <td>
                                                        {job.resumeUrl ? (
                                                            <a href={job.resumeUrl} target="_blank" rel="noopener noreferrer" style={{ color: "var(--accent-primary)", textDecoration: "none" }}>
                                                                &nbsp;View
                                                            </a>
                                                        ) : "-"}
                                                    </td>
                                                )}
                                                {visibleColumns.coverLetterUrl && (
                                                    <td>
                                                        {job.coverLetterUrl ? (
                                                            <a href={job.coverLetterUrl} target="_blank" rel="noopener noreferrer" style={{ color: "var(--accent-primary)", textDecoration: "none" }}>
                                                                &nbsp;View
                                                            </a>
                                                        ) : "-"}
                                                    </td>
                                                )}
                                                <td>
                                                    <div style={{ display: "flex", gap: "0.5rem" }}>
                                                        {/* View (eye) icon */}
                                                        <button
                                                            className="icon-btn"
                                                            title="View"
                                                            style={{
                                                                background: "var(--bg-tertiary)",
                                                                border: "1px solid var(--border-primary)",
                                                                width: "32px",
                                                                height: "32px",
                                                                borderRadius: "6px",
                                                                cursor: "pointer",
                                                                display: "flex",
                                                                alignItems: "center",
                                                                justifyContent: "center",
                                                                transition: "all 0.2s ease",
                                                                color: "var(--text-secondary)",
                                                                fontSize: "1.1rem"
                                                            }}
                                                            onClick={() => {
                                                                setViewModalJob(job);
                                                                setViewModalOpen(true);
                                                                setViewModalEdit(false);
                                                            }}
                                                        >
                                                            <span role="img" aria-label="View"></span>
                                                        </button>
                                                        <button 
                                                            className="icon-btn" 
                                                            onClick={() => onEdit(job)}
                                                            title="Edit"
                                                            style={{
                                                                background: "var(--bg-tertiary)",
                                                                border: "1px solid var(--border-primary)",
                                                                width: "32px",
                                                                height: "32px",
                                                                borderRadius: "6px",
                                                                cursor: "pointer",
                                                                display: "flex",
                                                                alignItems: "center",
                                                                justifyContent: "center",
                                                                transition: "all 0.2s ease",
                                                                color: "var(--text-secondary)",
                                                                fontSize: "0.9rem"
                                                            }}
                                                        >
                                                            
                                                        </button>
                                                        <button 
                                                            className="icon-btn danger" 
                                                            onClick={() => onDelete(job.id)}
                                                            title="Delete"
                                                            style={{
                                                                background: "var(--bg-tertiary)",
                                                                border: "1px solid var(--border-primary)",
                                                                width: "32px",
                                                                height: "32px",
                                                                borderRadius: "6px",
                                                                cursor: "pointer",
                                                                display: "flex",
                                                                alignItems: "center",
                                                                justifyContent: "center",
                                                                transition: "all 0.2s ease",
                                                                color: "var(--text-secondary)",
                                                                fontSize: "0.9rem"
                                                            }}
                                                        >
                                                            
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            {totalPages > 1 && (
                                <div style={{
                                    display: "flex",
                                    justifyContent: "center",
                                    alignItems: "center",
                                    gap: "0.5rem",
                                    marginTop: "2rem",
                                    padding: "1rem"
                                }}>
                                    <button
                                        className="pagination-btn"
                                        onClick={() => setCurrentPage(1)}
                                        disabled={currentPage === 1}
                                        style={{
                                            background: "var(--bg-secondary)",
                                            border: "1px solid var(--border-primary)",
                                            color: "var(--text-primary)",
                                            padding: "0.5rem 1rem",
                                            borderRadius: "8px",
                                            cursor: currentPage === 1 ? "not-allowed" : "pointer",
                                            fontSize: "0.9rem",
                                            transition: "all 0.2s ease",
                                            opacity: currentPage === 1 ? 0.4 : 1
                                        }}
                                    >
                                        
                                    </button>
                                    <button
                                        className="pagination-btn"
                                        onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                        disabled={currentPage === 1}
                                        style={{
                                            background: "var(--bg-secondary)",
                                            border: "1px solid var(--border-primary)",
                                            color: "var(--text-primary)",
                                            padding: "0.5rem 1rem",
                                            borderRadius: "8px",
                                            cursor: currentPage === 1 ? "not-allowed" : "pointer",
                                            fontSize: "0.9rem",
                                            transition: "all 0.2s ease",
                                            opacity: currentPage === 1 ? 0.4 : 1
                                        }}
                                    >
                                        
                                    </button>
                                    <span style={{ color: "var(--text-secondary)", fontSize: "0.9rem" }}>
                                        Page {currentPage} of {totalPages} ({filteredJobs.length} total)
                                    </span>
                                    <button
                                        className="pagination-btn"
                                        onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                        disabled={currentPage === totalPages}
                                        style={{
                                            background: "var(--bg-secondary)",
                                            border: "1px solid var(--border-primary)",
                                            color: "var(--text-primary)",
                                            padding: "0.5rem 1rem",
                                            borderRadius: "8px",
                                            cursor: currentPage === totalPages ? "not-allowed" : "pointer",
                                            fontSize: "0.9rem",
                                            transition: "all 0.2s ease",
                                            opacity: currentPage === totalPages ? 0.4 : 1
                                        }}
                                    >
                                        
                                    </button>
                                    <button
                                        className="pagination-btn"
                                        onClick={() => setCurrentPage(totalPages)}
                                        disabled={currentPage === totalPages}
                                        style={{
                                            background: "var(--bg-secondary)",
                                            border: "1px solid var(--border-primary)",
                                            color: "var(--text-primary)",
                                            padding: "0.5rem 1rem",
                                            borderRadius: "8px",
                                            cursor: currentPage === totalPages ? "not-allowed" : "pointer",
                                            fontSize: "0.9rem",
                                            transition: "all 0.2s ease",
                                            opacity: currentPage === totalPages ? 0.4 : 1
                                        }}
                                    >
                                        
                                    </button>
                                </div>
                            )}
                        </>
                    )}
                {/* View Modal for job details */}
                {viewModalOpen && (
                    <div className="modal-overlay" onClick={() => setViewModalOpen(false)}>
                        <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '700px' }}>
                            <div className="modal-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <h2>Job Details</h2>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <button className="icon-btn" title="Edit" style={{
                                        background: 'var(--bg-tertiary)',
                                        border: '1px solid var(--border-primary)',
                                        width: '32px', height: '32px', borderRadius: '6px', cursor: 'pointer',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-secondary)', fontSize: '1.1rem'
                                    }} onClick={() => {
                                        if (!viewModalEdit) {
                                            setEditedJobData({ ...viewModalJob });
                                        }
                                        setViewModalEdit(e => !e);
                                    }}>
                                        <span role="img" aria-label="Edit"></span>
                                    </button>
                                    <button className="modal-close" onClick={() => setViewModalOpen(false)}></button>
                                </div>
                            </div>
                            <div className="modal-body">
                                { /* Use a subtle read-only style in view mode */ }
                                {viewModalJob ? (
                                    <div style={{ borderBottom: '1px solid var(--border-primary)', marginBottom: '1.5rem', paddingBottom: '1.5rem' }}>
                                        <h3 style={{ color: 'var(--accent-primary)', marginBottom: '0.5rem' }}>{viewModalEdit ? editedJobData?.role : viewModalJob.role} @ {viewModalEdit ? editedJobData?.company : viewModalJob.company}</h3>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Company</label>
                                                <input type="text" value={viewModalEdit ? editedJobData?.company || '' : viewModalJob.company} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, company: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                            <div className="form-group">
                                                <label>Role</label>
                                                <input type="text" value={viewModalEdit ? editedJobData?.role || '' : viewModalJob.role} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, role: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                        </div>
                                        <div className="form-group">
                                            <label>Job URL</label>
                                            <input type="url" value={viewModalEdit ? editedJobData?.url || '' : viewModalJob.url || ''} readOnly={!viewModalEdit} onChange={e => {
                                                setEditedJobData({ ...editedJobData, url: e.target.value });
                                            }} style={viewFieldStyle} />
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Status</label>
                                                <input type="text" value={viewModalEdit ? editedJobData?.status || '' : viewModalJob.status || ''} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, status: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                            <div className="form-group">
                                                <label>Priority</label>
                                                <input type="text" value={viewModalEdit ? editedJobData?.priority || '' : viewModalJob.priority || ''} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, priority: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Date Applied</label>
                                                <input type="date" value={viewModalEdit ? editedJobData?.dateApplied || '' : viewModalJob.dateApplied || ''} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, dateApplied: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                            <div className="form-group">
                                                <label>Progression</label>
                                                <input type="text" value={viewModalEdit ? editedJobData?.progression || '' : viewModalJob.progression || ''} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, progression: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Salary</label>
                                                <input type="text" value={viewModalEdit ? editedJobData?.salary || '' : viewModalJob.salary || ''} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, salary: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                            <div className="form-group">
                                                <label>Location</label>
                                                <input type="text" value={viewModalEdit ? editedJobData?.location || '' : viewModalJob.location || ''} readOnly={!viewModalEdit} onChange={e => {
                                                    setEditedJobData({ ...editedJobData, location: e.target.value });
                                                }} style={viewFieldStyle} />
                                            </div>
                                        </div>
                                        <div className="form-group">
                                            <label>Contact</label>
                                            <input type="text" value={viewModalEdit ? editedJobData?.contact || '' : viewModalJob.contact || ''} readOnly={!viewModalEdit} onChange={e => {
                                                setEditedJobData({ ...editedJobData, contact: e.target.value });
                                            }} style={viewFieldStyle} />
                                        </div>
                                        <div className="form-group">
                                            <label>Follow-up Date</label>
                                            <input type="date" value={viewModalEdit ? editedJobData?.followUp || '' : viewModalJob.followUp || ''} readOnly={!viewModalEdit} onChange={e => {
                                                setEditedJobData({ ...editedJobData, followUp: e.target.value });
                                            }} style={viewFieldStyle} />
                                        </div>
                                        <div className="form-group">
                                            <label>Notes</label>
                                            <textarea value={viewModalEdit ? editedJobData?.notes || '' : viewModalJob.notes || ''} readOnly={!viewModalEdit} onChange={e => {
                                                setEditedJobData({ ...editedJobData, notes: e.target.value });
                                                autoExpandTextarea();
                                            }} ref={notesTextareaRef} style={{ minHeight: '120px', resize: 'vertical', overflow: 'hidden', ...viewFieldStyle }} />
                                        </div>
                                        {viewModalEdit && (
                                            <div className="modal-footer" style={{ marginTop: '1.5rem', borderTop: '1px solid var(--border-primary)', paddingTop: '1.5rem', display: 'flex', gap: '0.75rem', justifyContent: 'flex-end' }}>
                                                <button className="btn btn-secondary" onClick={() => {
                                                    setViewModalEdit(false);
                                                    setEditedJobData(null);
                                                }}>Cancel</button>
                                                <button className="btn" onClick={() => {
                                                    onEdit(editedJobData);
                                                    setViewModalOpen(false);
                                                    setViewModalEdit(false);
                                                    setEditedJobData(null);
                                                }}>Save Changes</button>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div>No job found.</div>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                </div>
            );
        }
        // Stats Component
        function Stats({ jobs }) {
            const statusCounts = STATUSES.reduce((acc, status) => {
                acc[status] = jobs.filter(j => j.status === status).length;
                return acc;
            }, {});

            const priorityCounts = PRIORITIES.reduce((acc, priority) => {
                acc[priority] = jobs.filter(j => j.priority === priority).length;
                return acc;
            }, {});

            return (
                <div>
                    <h2 style={{ marginBottom: "1rem", color: "#6b8aff" }}>Application Statuses</h2>
                    <div className="table-container" style={{ marginBottom: "2rem" }}>
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {STATUSES.map(status => (
                                    <tr key={status}>
                                        <td><StatusBadge status={status} /></td>
                                        <td>{statusCounts[status]}</td>
                                        <td>{jobs.length > 0 ? Math.round((statusCounts[status] / jobs.length) * 100) : 0}%</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <h2 style={{ marginBottom: "1rem", color: "#6b8aff" }}>Priority Breakdown</h2>
                    <div className="table-container">
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {PRIORITIES.map(priority => (
                                    <tr key={priority}>
                                        <td><PriorityBadge priority={priority} /></td>
                                        <td>{priorityCounts[priority]}</td>
                                        <td>{jobs.length > 0 ? Math.round((priorityCounts[priority] / jobs.length) * 100) : 0}%</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // Job Modal Component
        function JobModal({ job, onSave, onClose }) {
            const [formData, setFormData] = useState(() => {
                const today = new Date().toISOString().split('T')[0];
                const defaults = {
                    company: "",
                    role: "",
                    url: "",
                    status: "Applied",
                    priority: "Tier 2",
                    salary: "",
                    location: "",
                    contact: "",
                    notes: "",
                    followUp: "",
                    dateApplied: today,
                    closeReason: "",
                    progression: "Application",
                    resumeUrl: "",
                    coverLetterUrl: ""
                };
                
                if (job) {
                    return {
                        ...defaults,
                        ...job,
                        // Ensure status and priority are never undefined
                        status: job.status || "Applied",
                        priority: job.priority || "Tier 2",
                        progression: job.progression || "Application",
                        // Keep existing dateApplied or use today
                        dateApplied: job.dateApplied || today
                    };
                }
                
                return defaults;
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                try {
                    if (!formData.company.trim() || !formData.role.trim()) {
                        alert("Company and Role are required");
                        return;
                    }
                    
                    // Ensure status, priority, and progression are set before saving
                    const jobToSave = {
                        ...formData,
                        status: formData.status || "Applied",
                        priority: formData.priority || "Tier 2",
                        progression: formData.progression || "Application"
                    };
                    
                    console.log("Submitting job:", jobToSave);
                    onSave(jobToSave);
                } catch (error) {
                    console.error("Error submitting job:", error);
                    alert("Error saving job: " + error.message);
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>{job?.id ? "Edit Job" : "Add Job"}</h2>
                            <button className="modal-close" onClick={onClose}></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Company *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.company}
                                            onChange={(e) => setFormData({ ...formData, company: e.target.value })}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Role Title *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.role}
                                            onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Job URL</label>
                                    <input
                                        type="url"
                                        value={formData.url}
                                        onChange={(e) => setFormData({ ...formData, url: e.target.value })}
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Resume URL</label>
                                        <input
                                            type="url"
                                            placeholder="Link to resume used for this application"
                                            value={formData.resumeUrl}
                                            onChange={(e) => setFormData({ ...formData, resumeUrl: e.target.value })}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Cover Letter URL</label>
                                        <input
                                            type="url"
                                            placeholder="Link to cover letter used for this application"
                                            value={formData.coverLetterUrl}
                                            onChange={(e) => setFormData({ ...formData, coverLetterUrl: e.target.value })}
                                        />
                                    </div>
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Status *</label>
                                        <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })}>
                                            {STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label>Priority *</label>
                                        <select value={formData.priority} onChange={(e) => setFormData({ ...formData, priority: e.target.value })}>
                                            {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
                                        </select>
                                    </div>
                                    
      </div>

{/* Show Progression for "In Progress" (editable) or "Closed" (read-only) */}
{(formData.status === "In Progress" || formData.status === "Closed") && (
    <div className="form-group">
        <label>Progression {formData.status === "Closed" && "(Final Stage)"}</label>
        <select 
            value={formData.progression || ""} 
            onChange={(e) => setFormData({ ...formData, progression: e.target.value })}
            disabled={formData.status === "Closed"}
            style={formData.status === "Closed" ? {backgroundColor: '#2a3248', cursor: 'not-allowed'} : {}}
        >
            <option value="">Select progression...</option>
            {PROGRESSIONS.map(p => <option key={p} value={p}>{p}</option>)}
        </select>
    </div>
)}

                                {/* Conditional: Show Close Reason if status is "Closed" */}
                                {formData.status === "Closed" && (
                                    <div className="form-group">
                                        <label>Close Reason *</label>
                                        <select 
                                            required
                                            value={formData.closeReason || ""} 
                                            onChange={(e) => setFormData({ ...formData, closeReason: e.target.value })}
                                        >
                                            <option value="">Select reason...</option>
                                            {CLOSE_REASONS.map(r => <option key={r} value={r}>{r}</option>)}
                                        </select>
                                    </div>
                                )}

                                <div className="form-group">
                                    <label>Date Applied</label>
                                    <input
                                        type="date"
                                        value={formData.dateApplied}
                                        onChange={(e) => setFormData({ ...formData, dateApplied: e.target.value })}
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Salary Range</label>
                                        <input
                                            type="text"
                                            placeholder="e.g., $150k-$180k"
                                            value={formData.salary}
                                            onChange={(e) => setFormData({ ...formData, salary: e.target.value })}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Location</label>
                                        <input
                                            type="text"
                                            placeholder="Remote, Pittsburgh, etc."
                                            value={formData.location}
                                            onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Contact Name</label>
                                    <input
                                        type="text"
                                        placeholder="Recruiter or hiring manager"
                                        value={formData.contact}
                                        onChange={(e) => setFormData({ ...formData, contact: e.target.value })}
                                    />
                                </div>

                                <div className="form-group">
                                    <label>Follow-up Date</label>
                                    <input
                                        type="date"
                                        value={formData.followUp}
                                        onChange={(e) => setFormData({ ...formData, followUp: e.target.value })}
                                    />
                                </div>

                                <div className="form-group">
                                    <label>Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        placeholder="Interview notes, referral info, etc."
                                    />
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn">Save Job</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Import Modal Component
        function ImportModal({ onImport, onClose }) {
            const [dragActive, setDragActive] = useState(false);
            const [selectedFile, setSelectedFile] = useState(null);
            const [fileContent, setFileContent] = useState(null);
            const [preview, setPreview] = useState(null);
            const [importMode, setImportMode] = useState('replace');

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            };

            const handleFileInput = (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            };

            const handleFile = (file) => {
                if (!file.name.endsWith('.json')) {
                    alert('Please select a JSON backup file');
                    return;
                }
                
                setSelectedFile(file);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const data = JSON.parse(content);
                        
                        if (!data.jobs || !Array.isArray(data.jobs)) {
                            alert('Invalid backup file: missing jobs data');
                            return;
                        }
                        
                        setFileContent(content);
                        setPreview({
                            jobCount: data.jobs.length,
                            companyCount: data.customCompanies ? Object.keys(data.customCompanies).length : 0,
                            exportDate: data.exportDate ? new Date(data.exportDate).toLocaleString() : 'Unknown',
                            companies: data.jobs.map(j => j.company).filter((v, i, a) => a.indexOf(v) === i).slice(0, 10)
                        });
                    } catch (error) {
                        alert('Error reading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            const handleImport = () => {
                if (fileContent) {
                    onImport(fileContent, importMode);
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px' }}>
                        <div className="modal-header">
                            <h2>Import Backup</h2>
                            <button className="modal-close" onClick={onClose}></button>
                        </div>
                        <div className="modal-body">
                            {!preview ? (
                                <>
                                    <div 
                                        style={{
                                            border: `2px dashed ${dragActive ? '#6b8aff' : '#2a3248'}`,
                                            borderRadius: '8px',
                                            padding: '3rem 2rem',
                                            textAlign: 'center',
                                            background: dragActive ? '#1e2639' : '#0f1420',
                                            transition: 'all 0.3s'
                                        }}
                                        onDragEnter={handleDrag}
                                        onDragLeave={handleDrag}
                                        onDragOver={handleDrag}
                                        onDrop={handleDrop}
                                    >
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}></div>
                                        <h3 style={{ marginBottom: '0.5rem', color: '#e4e6eb' }}>
                                            Drop your backup file here
                                        </h3>
                                        <p style={{ color: '#9ca3af', marginBottom: '1.5rem' }}>
                                            or click to browse
                                        </p>
                                        <input
                                            type="file"
                                            accept=".json"
                                            onChange={handleFileInput}
                                            style={{ display: 'none' }}
                                            id="backup-file-input"
                                        />
                                        <label htmlFor="backup-file-input">
                                            <span className="btn">Choose File</span>
                                        </label>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#1a1f35', borderRadius: '6px', border: '1px solid #2a3248' }}>
                                        <h3 style={{ color: '#6b8aff', marginBottom: '1rem' }}> Preview</h3>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                                            <div>
                                                <div style={{ color: '#9ca3af', fontSize: '0.85rem' }}>Jobs to import</div>
                                                <div style={{ color: '#e4e6eb', fontSize: '1.5rem', fontWeight: 'bold' }}>{preview.jobCount}</div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#9ca3af', fontSize: '0.85rem' }}>Custom categories</div>
                                                <div style={{ color: '#e4e6eb', fontSize: '1.5rem', fontWeight: 'bold' }}>{preview.companyCount}</div>
                                            </div>
                                        </div>
                                        <div style={{ color: '#9ca3af', fontSize: '0.85rem', marginTop: '0.5rem' }}>
                                            Backup created: {preview.exportDate}
                                        </div>
                                        {preview.companies.length > 0 && (
                                            <div style={{ marginTop: '1rem' }}>
                                                <div style={{ color: '#9ca3af', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                    Companies (first 10):
                                                </div>
                                                <div style={{ color: '#e4e6eb', fontSize: '0.9rem' }}>
                                                    {preview.companies.join(', ')}
                                                    {preview.jobCount > 10 && '...'}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#1a1f35', borderRadius: '6px', border: '1px solid #2a3248' }}>
                                        <h3 style={{ color: '#6b8aff', marginBottom: '1rem' }}>Import Mode</h3>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                            <label style={{ 
                                                display: 'flex', 
                                                alignItems: 'flex-start', 
                                                cursor: 'pointer',
                                                padding: '0.75rem',
                                                background: importMode === 'merge' ? '#2a3248' : 'transparent',
                                                borderRadius: '6px',
                                                border: `1px solid ${importMode === 'merge' ? '#6b8aff' : '#2a3248'}`
                                            }}>
                                                <input
                                                    type="radio"
                                                    name="importMode"
                                                    value="merge"
                                                    checked={importMode === 'merge'}
                                                    onChange={(e) => setImportMode(e.target.value)}
                                                    style={{ marginRight: '0.75rem', marginTop: '0.25rem' }}
                                                />
                                                <div>
                                                    <div style={{ color: '#e4e6eb', fontWeight: '600', marginBottom: '0.25rem' }}>
                                                         Merge (Recommended for historical data)
                                                    </div>
                                                    <div style={{ color: '#9ca3af', fontSize: '0.85rem' }}>
                                                        Adds new jobs and companies without deleting existing data. Skips duplicates based on company + role + date.
                                                    </div>
                                                </div>
                                            </label>
                                            
                                            <label style={{ 
                                                display: 'flex', 
                                                alignItems: 'flex-start', 
                                                cursor: 'pointer',
                                                padding: '0.75rem',
                                                background: importMode === 'replace' ? '#2a3248' : 'transparent',
                                                borderRadius: '6px',
                                                border: `1px solid ${importMode === 'replace' ? '#6b8aff' : '#2a3248'}`
                                            }}>
                                                <input
                                                    type="radio"
                                                    name="importMode"
                                                    value="replace"
                                                    checked={importMode === 'replace'}
                                                    onChange={(e) => setImportMode(e.target.value)}
                                                    style={{ marginRight: '0.75rem', marginTop: '0.25rem' }}
                                                />
                                                <div>
                                                    <div style={{ color: '#e4e6eb', fontWeight: '600', marginBottom: '0.25rem' }}>
                                                         Replace All
                                                    </div>
                                                    <div style={{ color: '#9ca3af', fontSize: '0.85rem' }}>
                                                        Deletes all current data and replaces with backup. Use when restoring from backup.
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <button 
                                        className="btn btn-secondary" 
                                        onClick={() => { setPreview(null); setSelectedFile(null); setFileContent(null); }}
                                        style={{ width: '100%' }}
                                    >
                                         Choose Different File
                                    </button>
                                </>
                            )}
                        </div>
                        <div className="modal-footer">
                            <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            {preview && (
                                <button type="button" className="btn" onClick={handleImport}>
                                    {importMode === 'merge' ? ' Merge Data' : ' Replace All Data'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Company Modal Component
        function CompanyModal({ onSave, onClose, existingCategories }) {
            const [formData, setFormData] = useState({
                name: "",
                url: "",
                category: existingCategories[0] || "",
                newCategory: ""
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                try {
                    const category = formData.newCategory.trim() || formData.category;
                    if (!category || !formData.name.trim() || !formData.url.trim()) {
                        alert("Please fill in all required fields");
                        return;
                    }
                    onSave({ 
                        name: formData.name.trim(), 
                        url: formData.url.trim(), 
                        category: category.trim()
                    });
                } catch (error) {
                    console.error("Error submitting company:", error);
                    alert("Error saving company. Please try again.");
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Add Company</h2>
                            <button className="modal-close" onClick={onClose}></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                <div className="form-group">
                                    <label>Company Name *</label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.name}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        placeholder="e.g., Acme Corp"
                                    />
                                </div>

                                <div className="form-group">
                                    <label>Careers Page URL *</label>
                                    <input
                                        type="url"
                                        required
                                        value={formData.url}
                                        onChange={(e) => setFormData({ ...formData, url: e.target.value })}
                                        placeholder="https://company.com/careers/jobs"
                                    />
                                </div>

                                <div className="form-group">
                                    <label>Category *</label>
                                    <select 
                                        value={formData.category} 
                                        onChange={(e) => setFormData({ ...formData, category: e.target.value, newCategory: "" })}
                                        required={!formData.newCategory}
                                    >
                                        {existingCategories.map(cat => (
                                            <option key={cat} value={cat}>{cat}</option>
                                        ))}
                                        <option value="">-- Create New Category --</option>
                                    </select>
                                </div>

                                {formData.category === "" && (
                                    <div className="form-group">
                                        <label>New Category Name *</label>
                                        <input
                                            type="text"
                                            required={formData.category === ""}
                                            value={formData.newCategory}
                                            onChange={(e) => setFormData({ ...formData, newCategory: e.target.value })}
                                            placeholder="e.g., SaaS Platforms"
                                        />
                                    </div>
                                )}
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn">Add Company</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Status Badge Component
        function StatusBadge({ status }) {
            if (!status) {
                console.warn("StatusBadge received undefined status");
                return <span className="status-badge status-not-applied">Unknown</span>;
            }
            const className = `status-badge status-${status.toLowerCase().replace(/\s+/g, "-")}`;
            return <span className={className}>{status}</span>;
        }

        // Priority Badge Component
        function PriorityBadge({ priority }) {
            if (!priority) {
                console.warn("PriorityBadge received undefined priority");
                return <span className="priority-badge priority-tier2">No Priority</span>;
            }
            const className = `priority-badge priority-${priority.toLowerCase().replace(/\s+/g, "")}`;
            return <span className={className}>{priority}</span>;
        }

        // Render App
        ReactDOM.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>, 
            document.getElementById("root")
        );
    </script>
</body>
</html>